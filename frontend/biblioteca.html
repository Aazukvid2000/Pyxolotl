<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi Biblioteca ‚Äî Pyxolotl</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .biblioteca-container { min-height: 60vh; padding: 20px 0; }
    .biblioteca-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
    .biblioteca-card { background: linear-gradient(180deg, rgba(123, 97, 255, 0.08) 0%, rgba(0, 212, 170, 0.04) 100%); border: 1px solid rgba(123, 97, 255, 0.2); border-radius: 16px; overflow: hidden; transition: all 0.3s ease; cursor: pointer; }
    .biblioteca-card:hover { transform: translateY(-4px); border-color: var(--accent-1); box-shadow: 0 12px 40px rgba(123, 97, 255, 0.2); }
    .biblioteca-card-thumb { height: 180px; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; color: #07102a; overflow: hidden; }
    .biblioteca-card-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .biblioteca-card-info { padding: 16px; }
    .biblioteca-card-title { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 4px; }
    .biblioteca-card-meta { font-size: 13px; color: var(--muted); margin-bottom: 12px; }
    .biblioteca-card-actions { display: flex; gap: 8px; margin-top: 12px; }
    .biblioteca-card-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .biblioteca-card-badge.gratis { background: rgba(0, 212, 170, 0.15); color: var(--accent-2); }
    .biblioteca-card-badge.comprado { background: rgba(123, 97, 255, 0.15); color: var(--accent-1); }
    .btn-download { flex: 1; padding: 10px 16px; border-radius: 8px; background: linear-gradient(90deg, var(--accent-2), var(--accent-1)); color: #07102a; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; text-align: center; }
    .btn-download:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 212, 170, 0.4); }
    .empty-state { text-align: center; padding: 80px 20px; }
    .empty-state-icon { font-size: 80px; margin-bottom: 20px; }
    .empty-state h3 { font-size: 24px; color: #fff; margin-bottom: 12px; }
    .empty-state p { color: var(--muted); margin-bottom: 24px; }
    .loading-spinner { text-align: center; padding: 60px; }
    .loading-spinner::after { content: ''; display: inline-block; width: 40px; height: 40px; border: 3px solid rgba(123, 97, 255, 0.3); border-top-color: var(--accent-1); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; border-radius: 12px; color: #fff; font-weight: 500; z-index: 20000; animation: slideIn 0.3s ease; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
    .toast.success { background: linear-gradient(90deg, #10b981, #059669); }
    .toast.error { background: linear-gradient(90deg, #ef4444, #dc2626); }
    .toast.info { background: linear-gradient(90deg, var(--accent-1), #5b4cd1); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Perfil */
    .user-profile { display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(90deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
    .user-avatar span { color: #07102a; font-weight: bold; font-size: 16px; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    #userName { color: var(--accent-1); font-weight: 600; }
    
    /* Modal de Perfil */
    .profile-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; }
    .profile-modal.active { display: flex; }
    .profile-modal-content { background: var(--card); padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; animation: slideUp 0.4s ease; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .profile-header { text-align: center; margin-bottom: 25px; }
    .profile-avatar-large { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(90deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; overflow: hidden; cursor: pointer; position: relative; }
    .profile-avatar-large:hover .avatar-overlay { opacity: 1; }
    .avatar-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
    .avatar-overlay span { color: white; font-size: 14px; }
    .profile-avatar-large img { width: 100%; height: 100%; object-fit: cover; }
    .profile-avatar-large span { font-size: 40px; font-weight: 700; color: #07102a; }
    .profile-form { display: flex; flex-direction: column; gap: 16px; }
    .profile-form label { display: flex; flex-direction: column; gap: 6px; color: #ccc; font-size: 14px; }
    .profile-form input, .profile-form textarea { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 14px; color: #fff; font-size: 14px; }
    .profile-form input:focus, .profile-form textarea:focus { outline: none; border-color: var(--accent-1); }
    .profile-form textarea { min-height: 80px; resize: vertical; }
    .profile-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 10px; }
    .btn-cancel { background: rgba(255,255,255,0.1); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; }
    .btn-save { background: linear-gradient(90deg, var(--accent-2), var(--accent-1)); color: #07102a; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    #avatarInput { display: none; }
    
    /* Modal de Detalles */
    .game-detail-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); overflow-y: auto; }
    .game-detail-modal.active { display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; }
    .game-detail-container { background: linear-gradient(180deg, #0d1829 0%, #07102a 100%); border: 1px solid rgba(123, 97, 255, 0.3); border-radius: 24px; max-width: 900px; width: 100%; position: relative; overflow: hidden; animation: modalSlideIn 0.3s ease; }
    @keyframes modalSlideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .game-detail-close { position: absolute; top: 16px; right: 16px; width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: none; color: #fff; font-size: 20px; cursor: pointer; z-index: 10; }
    .game-detail-close:hover { background: rgba(255, 59, 48, 0.3); }
    .game-detail-hero { height: 200px; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .game-detail-hero img { width: 100%; height: 100%; object-fit: cover; }
    .game-detail-hero span { font-size: 80px; font-weight: bold; color: #07102a; }
    .game-detail-content { padding: 24px; }
    .game-detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
    .game-detail-title { font-size: 28px; font-weight: 700; color: #fff; margin: 0; }
    .game-detail-price { font-size: 20px; font-weight: 700; color: var(--accent-1); }
    .game-detail-meta { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
    .game-detail-genre { background: rgba(123, 97, 255, 0.15); color: var(--accent-1); padding: 6px 16px; border-radius: 20px; font-size: 14px; }
    .game-detail-stars { color: #fbbf24; font-size: 16px; }
    .game-detail-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; background: rgba(255, 255, 255, 0.03); padding: 20px; border-radius: 12px; margin-bottom: 24px; }
    .game-detail-stat { text-align: center; }
    .game-detail-stat-value { font-size: 24px; font-weight: 700; color: var(--accent-1); }
    .game-detail-stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
    .game-detail-dev { display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; margin-bottom: 24px; }
    .game-detail-dev-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #07102a; }
    .game-detail-dev-name { font-weight: 600; color: #fff; }
    .game-detail-dev-label { font-size: 12px; color: var(--muted); }
    .game-detail-section { margin-bottom: 24px; }
    .game-detail-section-title { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 12px; }
    .game-detail-desc { color: var(--muted); line-height: 1.7; }
    .game-detail-requirements { background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
    .requirements-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .requirements-column h4 { color: var(--accent-1); font-size: 14px; margin-bottom: 16px; border-bottom: 1px solid rgba(123, 97, 255, 0.3); padding-bottom: 8px; }
    .requirement-item { margin-bottom: 12px; }
    .requirement-label { font-size: 11px; color: var(--muted); text-transform: uppercase; margin-bottom: 2px; }
    .requirement-value { font-size: 14px; color: #fff; }
    .reviews-section { margin-bottom: 24px; }
    .review-form { background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .review-form h4 { margin-bottom: 12px; color: #fff; }
    .review-rating { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
    .review-rating label { color: var(--muted); font-size: 14px; }
    .star-input { font-size: 24px; cursor: pointer; color: #4a5568; transition: color 0.2s; }
    .star-input:hover, .star-input.active { color: #fbbf24; }
    .review-textarea { width: 100%; min-height: 100px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; color: #fff; resize: vertical; font-family: inherit; box-sizing: border-box; }
    .review-textarea:focus { outline: none; border-color: var(--accent-1); }
    .review-submit { margin-top: 12px; display: flex; justify-content: space-between; align-items: center; }
    .review-char-count { font-size: 12px; color: var(--muted); }
    .reviews-list { max-height: 400px; overflow-y: auto; }
    .review-item { background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .review-author { display: flex; align-items: center; gap: 10px; }
    .review-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #07102a; font-size: 14px; }
    .review-name { font-weight: 600; color: #fff; }
    .review-date { font-size: 12px; color: var(--muted); }
    .review-badge { background: rgba(16, 185, 129, 0.15); color: #10b981; padding: 4px 12px; border-radius: 20px; font-size: 12px; }
    .review-stars { color: #fbbf24; margin-bottom: 8px; }
    .review-text { color: var(--muted); line-height: 1.6; }
    .reviews-empty { text-align: center; padding: 40px; color: var(--muted); }
    .game-detail-actions { display: flex; gap: 12px; padding: 20px 24px; border-top: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.2); }
    .game-detail-btn-download { flex: 1; padding: 16px 24px; border-radius: 12px; background: linear-gradient(90deg, var(--accent-2), var(--accent-1)); color: #07102a; font-weight: 600; font-size: 16px; border: none; cursor: pointer; }
    .game-detail-btn-download:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0, 212, 170, 0.4); }
    .game-detail-btn-close { padding: 16px 32px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: #fff; font-weight: 600; font-size: 16px; border: none; cursor: pointer; }
    @media (max-width: 768px) { .game-detail-stats { grid-template-columns: repeat(2, 1fr); } .requirements-grid { grid-template-columns: 1fr; } .game-detail-actions { flex-direction: column; } }
    
    /* Footer */
    .pyxolotl-footer { background: linear-gradient(180deg, #0a0e1a 0%, #07102a 100%); border-top: 1px solid rgba(123, 97, 255, 0.1); padding: 60px 0 0 0; margin-top: 100px; color: #e0e0e0; }
    .footer-container { max-width: 1400px; margin: 0 auto; padding: 0 40px; display: grid; grid-template-columns: 1.5fr repeat(3, 1fr); gap: 50px; }
    .footer-column { display: flex; flex-direction: column; gap: 20px; }
    .footer-title { font-size: 24px; font-weight: 700; background: linear-gradient(90deg, var(--accent-1), var(--accent-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; letter-spacing: 1px; }
    .footer-description { color: #b0b0b0; font-size: 14px; line-height: 1.6; margin-bottom: 10px; }
    .footer-social { display: flex; gap: 12px; margin-top: 8px; }
    .social-link { width: 40px; height: 40px; border-radius: 50%; background: rgba(123, 97, 255, 0.1); display: flex; align-items: center; justify-content: center; color: var(--accent-1); transition: all 0.3s ease; border: 1px solid rgba(123, 97, 255, 0.2); text-decoration: none; }
    .social-link:hover { background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color: #07102a; transform: translateY(-3px); }
    .footer-heading { font-size: 12px; font-weight: 700; letter-spacing: 1.5px; color: #808080; text-transform: uppercase; margin-bottom: 4px; }
    .footer-links { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
    .footer-links li a { color: #b0b0b0; font-size: 14px; text-decoration: none; transition: all 0.2s ease; display: inline-block; }
    .footer-links li a:hover { color: var(--accent-1); transform: translateX(4px); }
    .footer-bottom { background: #060a16; border-top: 1px solid rgba(123, 97, 255, 0.1); padding: 24px 0; margin-top: 50px; }
    .footer-bottom .footer-container { display: flex; justify-content: space-between; align-items: center; }
    .footer-copyright { color: #808080; font-size: 13px; margin: 0; }
    .footer-legal { display: flex; gap: 16px; align-items: center; }
    .footer-legal a { color: #808080; font-size: 13px; text-decoration: none; }
    .footer-legal a:hover { color: var(--accent-1); }
    .footer-legal .separator { color: #404040; }
    @media (max-width: 1024px) { .footer-container { grid-template-columns: repeat(2, 1fr); gap: 40px; } .footer-column:first-child { grid-column: 1 / -1; text-align: center; } .footer-social { justify-content: center; } }
    @media (max-width: 768px) { .pyxolotl-footer { padding: 40px 0 0 0; margin-top: 60px; } .footer-container { grid-template-columns: 1fr; gap: 30px; padding: 0 20px; } .footer-bottom .footer-container { flex-direction: column; gap: 16px; text-align: center; } .footer-legal { flex-wrap: wrap; justify-content: center; } }
  </style>
</head>
<body>
  <header class="container header">
    <div class="brand" onclick="window.location.href='index.html'" style="cursor:pointer">
      <img src="PIXOLOTEL.png" alt="Logo Pyxolotl" class="brand-logo" onerror="this.style.display='none'">
      <div>
        <div class="site-title">Pyxolotl</div>
        <div style="font-size:12px;color:var(--muted)">Marketplace de juegos indie mexicanos</div>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">üè† Inicio</a>
      <a href="biblioteca.html" style="color:var(--accent-1);font-weight:600">üìö Biblioteca</a>
      <div id="authButtons" style="display:flex;gap:8px">
        <a class="btn btn-ghost" href="inicio.html">Iniciar sesi√≥n</a>
      </div>
      <div id="userProfile" class="user-profile" style="display:none">
        <div id="userAvatar" class="user-avatar" onclick="openProfileModal()">
          <img id="avatarImg" src="" style="display:none">
          <span id="userInitials">U</span>
        </div>
        <span id="userName">Usuario</span>
        <button id="logoutBtn" class="btn btn-ghost">Cerrar sesi√≥n</button>
      </div>
    </nav>
  </header>

  <main class="container" style="padding-top:40px">
    <h1 style="font-size:32px;margin-bottom:8px">üéÆ Mi Biblioteca de Juegos</h1>
    <p style="color:var(--muted);margin-bottom:40px">Todos tus juegos comprados y gratuitos</p>
    <div id="bibliotecaContainer" class="biblioteca-container">
      <div class="loading-spinner"></div>
    </div>
  </main>

  <!-- Modal de Perfil -->
  <div id="profileModal" class="profile-modal">
    <div class="profile-modal-content">
      <div class="profile-header">
        <h2>Mi Perfil</h2>
        <div class="profile-avatar-large" onclick="document.getElementById('avatarInput').click()">
          <img id="profileAvatarImg" src="" alt="" style="display:none">
          <span id="profileInitials">U</span>
          <div class="avatar-overlay"><span>Cambiar foto</span></div>
        </div>
        <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarChange(event)">
        <h3 id="profileName">Usuario</h3>
        <p style="color:var(--muted);font-size:14px" id="profileEmail">email@ejemplo.com</p>
      </div>
      <form class="profile-form" id="profileForm" onsubmit="saveProfile(event)">
        <label>Nombre<input type="text" id="profileNickname" maxlength="50" placeholder="Tu nombre"></label>
        <label>Descripci√≥n<textarea id="profileDescription" placeholder="Cu√©ntanos algo sobre ti..."></textarea></label>
        <div class="profile-actions">
          <button type="button" class="btn-cancel" onclick="closeProfileModal()">Cancelar</button>
          <button type="submit" class="btn-save">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Detalles del Juego -->
  <div id="gameDetailModal" class="game-detail-modal">
    <div class="game-detail-container">
      <button class="game-detail-close" onclick="closeGameDetailModal()">&times;</button>
      <div id="gameDetailHero" class="game-detail-hero"><span>--</span></div>
      <div class="game-detail-content">
        <div class="game-detail-header">
          <h2 id="gameDetailTitle" class="game-detail-title">Cargando...</h2>
          <div id="gameDetailPrice" class="game-detail-price">üìö En tu biblioteca</div>
        </div>
        <div class="game-detail-meta">
          <span id="gameDetailGenre" class="game-detail-genre">--</span>
          <div><span id="gameDetailStars" class="game-detail-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span> (<span id="gameDetailReviews">0</span> rese√±as) <span id="gameDetailRating" style="color:var(--accent-1);font-weight:600">0.0</span></div>
        </div>
        <div class="game-detail-stats">
          <div class="game-detail-stat"><div id="gameDetailDownloads" class="game-detail-stat-value">0</div><div class="game-detail-stat-label">Descargas</div></div>
          <div class="game-detail-stat"><div id="gameDetailSales" class="game-detail-stat-value">0</div><div class="game-detail-stat-label">Ventas</div></div>
          <div class="game-detail-stat"><div id="gameDetailCalif" class="game-detail-stat-value">0.0</div><div class="game-detail-stat-label">Calificaci√≥n</div></div>
          <div class="game-detail-stat"><div id="gameDetailSize" class="game-detail-stat-value">--</div><div class="game-detail-stat-label">Tama√±o</div></div>
        </div>
        <div class="game-detail-dev">
          <div id="gameDetailDevAvatar" class="game-detail-dev-avatar">D</div>
          <div><div id="gameDetailDevName" class="game-detail-dev-name">Desarrollador</div><div class="game-detail-dev-label">Desarrollador Indie</div></div>
        </div>
        <div class="game-detail-section"><h3 class="game-detail-section-title">üéÆ Acerca del juego</h3><p id="gameDetailDesc" class="game-detail-desc">Cargando...</p></div>
        <div id="gameDetailRequirements" class="game-detail-requirements" style="display:none">
          <h3 class="game-detail-section-title">üñ•Ô∏è Requisitos del Sistema</h3>
          <div class="requirements-grid">
            <div class="requirements-column"><h4>M√çNIMO</h4><div id="reqMinimo"></div></div>
            <div class="requirements-column"><h4>RECOMENDADO</h4><div id="reqRecomendado"></div></div>
          </div>
          <div id="reqPlataformas" style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1)"></div>
        </div>
        <div class="reviews-section">
          <h3 class="game-detail-section-title">üí¨ Rese√±as de usuarios</h3>
          <div id="reviewForm" class="review-form">
            <h4>‚úçÔ∏è Escribe tu rese√±a</h4>
            <div class="review-rating">
              <label>Tu calificaci√≥n:</label>
              <span class="star-input" data-rating="1">‚òÜ</span><span class="star-input" data-rating="2">‚òÜ</span><span class="star-input" data-rating="3">‚òÜ</span><span class="star-input" data-rating="4">‚òÜ</span><span class="star-input" data-rating="5">‚òÜ</span>
              <span id="ratingText" style="color:var(--accent-1);margin-left:8px">Selecciona</span>
            </div>
            <textarea id="reviewTextarea" class="review-textarea" placeholder="¬øQu√© te pareci√≥ este juego?" maxlength="1000"></textarea>
            <div class="review-submit"><span id="charCount" class="review-char-count">0/1000</span><button type="button" id="submitReviewBtn" class="btn-save">üìù Publicar</button></div>
          </div>
          <div id="reviewsList" class="reviews-list"><div class="reviews-empty"><div style="font-size:48px">üí¨</div><p>A√∫n no hay rese√±as</p></div></div>
        </div>
      </div>
      <div class="game-detail-actions">
        <button id="gameDetailDownloadBtn" class="game-detail-btn-download" onclick="descargarJuegoActual()">üì• Descargar</button>
        <button class="game-detail-btn-close" onclick="closeGameDetailModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="pyxolotl-footer">
    <div class="footer-container">
      <div class="footer-column">
        <h3 class="footer-title">PYXOLOTL</h3>
        <p class="footer-description">Plataforma mexicana de videojuegos indie. Conectando desarrolladores con jugadores apasionados.</p>
        <div class="footer-social">
          <a href="https://www.instagram.com/pyxo.lotl" target="_blank" class="social-link">üì∑</a>
          <a href="https://www.facebook.com/profile.php?id=61584296583769" target="_blank" class="social-link">üìò</a>
        </div>
      </div>
      <div class="footer-column">
        <h4 class="footer-heading">DESARROLLADORES</h4>
        <ul class="footer-links">
          <li><a href="publicar-juego.html">Publicar juego</a></li>
          <li><a href="index.html#about">Acerca de Pyxolotl</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4 class="footer-heading">AYUDA</h4>
        <ul class="footer-links">
          <li><a href="faq.html">Preguntas frecuentes</a></li>
          <li><a href="mailto:soporte@pyxolotl.com">Soporte</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4 class="footer-heading">PYXOLOTL</h4>
        <ul class="footer-links">
          <li><a href="biblioteca.html">Mi biblioteca</a></li>
          <li><a href="inicio.html#registro">Registrarse</a></li>
          <li><a href="inicio.html">Iniciar sesi√≥n</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="footer-container">
        <p class="footer-copyright">¬© 2025 Pyxolotl. Todos los derechos reservados.</p>
        <div class="footer-legal"><a href="faq.html">FAQ</a></div>
      </div>
    </div>
  </footer>

  <script src="api.js"></script>
  <script>
    let bibliotecaItems = [];
    let currentGameDetail = null;
    let selectedRating = 0;
    
    function showToast(message, type = 'info') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }
    
    function getImageUrl(url) {
      if (!url) return null;
      if (url.startsWith('http')) return url;
      return API_URL + url;
    }

    // ============ DESCARGA ============
    async function descargarJuego(e, juegoId, titulo) {
      e.stopPropagation();
      showToast('‚è≥ Preparando descarga...', 'info');
      try {
        // Usar el endpoint de descarga de biblioteca
        const token = getAuthToken();
        window.open(`${API_URL}/api/biblioteca/descargar/${juegoId}?token=${token}`, '_blank');
      } catch (error) {
        console.error('Error:', error);
        showToast('‚ùå Error al descargar', 'error');
      }
    }
    
    function descargarJuegoActual() {
      if (!currentGameDetail) return;
      showToast('‚è≥ Preparando descarga...', 'info');
      const token = getAuthToken();
      window.open(`${API_URL}/api/biblioteca/descargar/${currentGameDetail.id}?token=${token}`, '_blank');
    }

    // ============ MODAL DETALLES ============
    async function openGameDetailModal(juegoId) {
      const modal = document.getElementById('gameDetailModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      try {
        const game = await apiGetJuego(juegoId);
        if (!game || game.detail) { showToast('‚ùå No se pudo cargar', 'error'); closeGameDetailModal(); return; }
        currentGameDetail = game;
        renderGameDetailModal(game);
        loadGameReviews(juegoId);
      } catch (error) {
        console.error('Error:', error);
        showToast('‚ùå Error al cargar', 'error');
        closeGameDetailModal();
      }
    }
    
    function closeGameDetailModal() {
      document.getElementById('gameDetailModal').classList.remove('active');
      document.body.style.overflow = '';
      currentGameDetail = null;
      selectedRating = 0;
    }
    
    function renderGameDetailModal(game) {
      const hero = document.getElementById('gameDetailHero');
      if (game.portada_url) {
        const url = getImageUrl(game.portada_url);
        hero.innerHTML = `<img src="${url}" onerror="this.parentElement.innerHTML='<span>${game.titulo.substring(0,2).toUpperCase()}</span>'">`;
      } else {
        hero.innerHTML = `<span>${game.titulo.substring(0,2).toUpperCase()}</span>`;
      }
      document.getElementById('gameDetailTitle').textContent = game.titulo;
      document.getElementById('gameDetailGenre').textContent = game.genero || 'Indie';
      const rating = game.calificacion_promedio || 0;
      document.getElementById('gameDetailStars').textContent = '‚òÖ'.repeat(Math.floor(rating)) + '‚òÜ'.repeat(5 - Math.floor(rating));
      document.getElementById('gameDetailReviews').textContent = game.total_resenas || 0;
      document.getElementById('gameDetailRating').textContent = rating.toFixed(1);
      document.getElementById('gameDetailDownloads').textContent = game.total_descargas || 0;
      document.getElementById('gameDetailSales').textContent = game.total_ventas || 0;
      document.getElementById('gameDetailCalif').textContent = rating.toFixed(1);
      document.getElementById('gameDetailSize').textContent = game.tamano_mb ? game.tamano_mb.toFixed(1) + ' MB' : '--';
      const devName = game.desarrollador?.nombre || 'Desarrollador Indie';
      document.getElementById('gameDetailDevName').textContent = devName;
      document.getElementById('gameDetailDevAvatar').textContent = devName.substring(0,1).toUpperCase();
      document.getElementById('gameDetailDesc').textContent = game.descripcion || 'Sin descripci√≥n.';
      renderRequirements(game.requisitos);
    }
    
    function renderRequirements(requisitos) {
      const container = document.getElementById('gameDetailRequirements');
      if (!requisitos) { container.style.display = 'none'; return; }
      container.style.display = 'block';
      let req = typeof requisitos === 'string' ? JSON.parse(requisitos) : requisitos;
      const minimo = req.minimo || {};
      const recomendado = req.recomendado || {};
      const renderCol = (d) => {
        let h = '';
        if (d.so) h += `<div class="requirement-item"><div class="requirement-label">SO</div><div class="requirement-value">${d.so}</div></div>`;
        if (d.procesador) h += `<div class="requirement-item"><div class="requirement-label">PROCESADOR</div><div class="requirement-value">${d.procesador}</div></div>`;
        if (d.memoria) h += `<div class="requirement-item"><div class="requirement-label">MEMORIA</div><div class="requirement-value">${d.memoria}</div></div>`;
        if (d.graficos) h += `<div class="requirement-item"><div class="requirement-label">GR√ÅFICOS</div><div class="requirement-value">${d.graficos}</div></div>`;
        if (d.almacenamiento) h += `<div class="requirement-item"><div class="requirement-label">ALMACENAMIENTO</div><div class="requirement-value">${d.almacenamiento}</div></div>`;
        return h || '<p style="color:var(--muted)">No especificado</p>';
      };
      document.getElementById('reqMinimo').innerHTML = renderCol(minimo);
      document.getElementById('reqRecomendado').innerHTML = renderCol(recomendado);
      if (req.plataformas?.length) document.getElementById('reqPlataformas').innerHTML = `<div class="requirement-label">PLATAFORMAS</div><div class="requirement-value">${req.plataformas.join(', ')}</div>`;
    }
    
    async function loadGameReviews(juegoId) {
      const list = document.getElementById('reviewsList');
      try {
        const res = await fetch(`${API_URL}/api/resenas/juego/${juegoId}`);
        const resenas = await res.json();
        if (!resenas || resenas.length === 0) { list.innerHTML = '<div class="reviews-empty"><div style="font-size:48px">üí¨</div><p>A√∫n no hay rese√±as</p></div>'; return; }
        list.innerHTML = resenas.map(r => {
          const name = r.usuario?.nombre || 'Usuario';
          const stars = '‚òÖ'.repeat(r.calificacion) + '‚òÜ'.repeat(5 - r.calificacion);
          const date = new Date(r.fecha_creacion).toLocaleDateString('es-MX');
          return `<div class="review-item"><div class="review-header"><div class="review-author"><div class="review-avatar">${name[0]}</div><div><div class="review-name">${name}</div><div class="review-date">${date}</div></div></div>${r.calificacion >= 4 ? '<span class="review-badge">üëç Recomendado</span>' : ''}</div><div class="review-stars">${stars}</div><p class="review-text">${r.comentario || ''}</p></div>`;
        }).join('');
      } catch (e) { console.error('Error rese√±as:', e); }
    }
    
    // Estrellas
    document.querySelectorAll('.star-input').forEach(star => {
      star.addEventListener('click', function() { selectedRating = parseInt(this.dataset.rating); updateStars(); });
      star.addEventListener('mouseenter', function() {
        const r = parseInt(this.dataset.rating);
        document.querySelectorAll('.star-input').forEach((s, i) => { s.textContent = i < r ? '‚òÖ' : '‚òÜ'; s.style.color = i < r ? '#fbbf24' : '#4a5568'; });
      });
    });
    document.querySelector('.review-rating').addEventListener('mouseleave', updateStars);
    function updateStars() {
      document.querySelectorAll('.star-input').forEach((s, i) => { s.textContent = i < selectedRating ? '‚òÖ' : '‚òÜ'; s.style.color = i < selectedRating ? '#fbbf24' : '#4a5568'; });
      document.getElementById('ratingText').textContent = ['Selecciona', 'Malo', 'Regular', 'Bueno', 'Muy bueno', '¬°Excelente!'][selectedRating];
    }
    document.getElementById('reviewTextarea').addEventListener('input', function() { document.getElementById('charCount').textContent = this.value.length + '/1000'; });
    document.getElementById('submitReviewBtn').addEventListener('click', async function() {
      if (!currentGameDetail || selectedRating === 0) { showToast('‚ö†Ô∏è Selecciona una calificaci√≥n', 'error'); return; }
      try {
        const res = await fetch(`${API_URL}/api/resenas/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getAuthToken()}` },
          body: JSON.stringify({ juego_id: currentGameDetail.id, calificacion: selectedRating, comentario: document.getElementById('reviewTextarea').value.trim() })
        });
        if (res.ok) { showToast('‚úÖ ¬°Rese√±a publicada!', 'success'); document.getElementById('reviewTextarea').value = ''; selectedRating = 0; updateStars(); loadGameReviews(currentGameDetail.id); }
        else { const err = await res.json(); showToast('‚ùå ' + (err.detail || 'Error'), 'error'); }
      } catch (e) { showToast('‚ùå Error', 'error'); }
    });

    // ============ PERFIL ============
    function openProfileModal() {
      const user = getCurrentUser();
      if (!user) return;
      document.getElementById('profileModal').classList.add('active');
      document.getElementById('profileName').textContent = user.nombre || 'Usuario';
      document.getElementById('profileEmail').textContent = user.email || '';
      document.getElementById('profileInitials').textContent = (user.nombre || 'U').substring(0, 2).toUpperCase();
      document.getElementById('profileNickname').value = user.nombre || '';
      document.getElementById('profileDescription').value = user.descripcion || '';
      if (user.avatar_url) {
        document.getElementById('profileAvatarImg').src = user.avatar_url;
        document.getElementById('profileAvatarImg').style.display = 'block';
        document.getElementById('profileInitials').style.display = 'none';
      }
    }
    function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); }
    async function handleAvatarChange(event) {
      const file = event.target.files[0];
      if (!file) return;
      showToast('‚è≥ Subiendo foto...', 'info');
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch(`${API_URL}/api/usuarios/avatar`, { method: 'POST', headers: { 'Authorization': `Bearer ${getAuthToken()}` }, body: formData });
        if (res.ok) {
          const data = await res.json();
          const user = getCurrentUser();
          user.avatar_url = data.avatar_url;
          localStorage.setItem('user', JSON.stringify(user));
          document.getElementById('profileAvatarImg').src = data.avatar_url;
          document.getElementById('profileAvatarImg').style.display = 'block';
          document.getElementById('profileInitials').style.display = 'none';
          showToast('‚úÖ Foto actualizada', 'success');
          checkSession();
        } else { showToast('‚ùå Error al subir', 'error'); }
      } catch (e) { showToast('‚ùå Error', 'error'); }
    }
    async function saveProfile(event) {
      event.preventDefault();
      const nombre = document.getElementById('profileNickname').value.trim();
      const descripcion = document.getElementById('profileDescription').value.trim();
      try {
        const res = await fetch(`${API_URL}/api/usuarios/perfil`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getAuthToken()}` },
          body: JSON.stringify({ nombre, descripcion })
        });
        if (res.ok) {
          const user = getCurrentUser();
          user.nombre = nombre;
          user.descripcion = descripcion;
          localStorage.setItem('user', JSON.stringify(user));
          showToast('‚úÖ Perfil actualizado', 'success');
          closeProfileModal();
          checkSession();
        } else { showToast('‚ùå Error al guardar', 'error'); }
      } catch (e) { showToast('‚ùå Error', 'error'); }
    }

    // ============ BIBLIOTECA ============
    async function cargarBiblioteca() {
      const container = document.getElementById('bibliotecaContainer');
      if (!isAuthenticated()) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üîí</div><h3>Inicia sesi√≥n para ver tu biblioteca</h3><p>Necesitas una cuenta para acceder a tus juegos</p><a href="inicio.html" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;padding:12px 32px;border-radius:8px;text-decoration:none">Iniciar sesi√≥n</a></div>`;
        return;
      }
      try {
        const response = await apiGetBiblioteca();
        if (response.detail) throw new Error(response.detail);
        bibliotecaItems = response || [];
        if (bibliotecaItems.length === 0) {
          container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üéÆ</div><h3>Tu biblioteca est√° vac√≠a</h3><p>Explora el cat√°logo y obt√©n tu primer juego</p><a href="index.html" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;padding:12px 32px;border-radius:8px;text-decoration:none">Explorar juegos</a></div>`;
          return;
        }
        let html = '<div class="biblioteca-grid">';
        bibliotecaItems.forEach((item) => {
          const juego = item.juego;
          if (!juego) return;
          const initials = juego.titulo.substring(0, 2).toUpperCase();
          const imgUrl = getImageUrl(juego.portada_url);
          let thumb = imgUrl ? `<img src="${imgUrl}" alt="${juego.titulo}" onerror="this.parentElement.innerHTML='<span>${initials}</span>'">` : `<span>${initials}</span>`;
          html += `<article class="biblioteca-card" onclick="openGameDetailModal(${juego.id})"><div class="biblioteca-card-thumb">${thumb}</div><div class="biblioteca-card-info"><h3 class="biblioteca-card-title">${juego.titulo}</h3><p class="biblioteca-card-meta">${juego.genero || 'Indie'} ‚Ä¢ ‚≠ê ${(juego.calificacion_promedio || 0).toFixed(1)}</p><span class="biblioteca-card-badge ${item.es_gratuito ? 'gratis' : 'comprado'}">${item.es_gratuito ? '‚ú® Gratis' : 'üíé Comprado'}</span><div class="biblioteca-card-actions"><button class="btn-download" onclick="descargarJuego(event, ${juego.id}, '${juego.titulo.replace(/'/g, "\\'")}')">üì• Descargar</button></div></div></article>`;
        });
        html += '</div>';
        container.innerHTML = html;
      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üòï</div><h3>Error al cargar</h3><p>${error.message}</p><button onclick="cargarBiblioteca()" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;padding:12px 32px;border-radius:8px;border:none;cursor:pointer">Reintentar</button></div>`;
      }
    }

    function checkSession() {
      const user = getCurrentUser();
      const authButtons = document.getElementById('authButtons');
      const userProfile = document.getElementById('userProfile');
      if (user && isAuthenticated()) {
        authButtons.style.display = 'none';
        userProfile.style.display = 'flex';
        const initials = user.nombre ? user.nombre.substring(0, 2).toUpperCase() : 'U';
        document.getElementById('userInitials').textContent = initials;
        document.getElementById('userName').textContent = user.nombre || 'Usuario';
        if (user.avatar_url) {
          document.getElementById('avatarImg').src = user.avatar_url;
          document.getElementById('avatarImg').style.display = 'block';
          document.getElementById('userInitials').style.display = 'none';
        } else {
          document.getElementById('avatarImg').style.display = 'none';
          document.getElementById('userInitials').style.display = 'block';
        }
        document.getElementById('logoutBtn').onclick = () => { logout(); window.location.href = 'index.html'; };
      } else {
        authButtons.style.display = 'flex';
        userProfile.style.display = 'none';
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('gameDetailModal').classList.contains('active')) closeGameDetailModal();
        if (document.getElementById('profileModal').classList.contains('active')) closeProfileModal();
      }
    });
    document.getElementById('gameDetailModal').addEventListener('click', (e) => { if (e.target.classList.contains('game-detail-modal')) closeGameDetailModal(); });
    document.getElementById('profileModal').addEventListener('click', (e) => { if (e.target.classList.contains('profile-modal')) closeProfileModal(); });
    
    document.addEventListener('DOMContentLoaded', () => { checkSession(); cargarBiblioteca(); });
  </script>
</body>
</html>
