<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi Biblioteca ‚Äî Pyxolotl</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Biblioteca Grid */
    .biblioteca-container { min-height: 60vh; padding: 20px 0; }
    
    .biblioteca-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
    }
    
    .biblioteca-card {
      background: linear-gradient(180deg, rgba(123, 97, 255, 0.08) 0%, rgba(0, 212, 170, 0.04) 100%);
      border: 1px solid rgba(123, 97, 255, 0.2);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .biblioteca-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent-1);
      box-shadow: 0 12px 40px rgba(123, 97, 255, 0.2);
    }
    
    .biblioteca-card-thumb {
      height: 180px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: flex; align-items: center; justify-content: center;
      font-size: 48px; font-weight: bold; color: #07102a; overflow: hidden;
    }
    
    .biblioteca-card-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .biblioteca-card-info { padding: 16px; }
    .biblioteca-card-title { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 4px; }
    .biblioteca-card-meta { font-size: 13px; color: var(--muted); margin-bottom: 12px; }
    
    .biblioteca-card-actions { display: flex; gap: 8px; margin-top: 12px; }
    
    .biblioteca-card-badge {
      display: inline-block; padding: 4px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 600;
    }
    .biblioteca-card-badge.gratis { background: rgba(0, 212, 170, 0.15); color: var(--accent-2); }
    .biblioteca-card-badge.comprado { background: rgba(123, 97, 255, 0.15); color: var(--accent-1); }
    
    .btn-download {
      flex: 1; padding: 10px 16px; border-radius: 8px;
      background: linear-gradient(90deg, var(--accent-2), var(--accent-1));
      color: #07102a; font-weight: 600; border: none; cursor: pointer;
      transition: all 0.3s; text-align: center; text-decoration: none;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-download:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 212, 170, 0.4); }
    
    .btn-info {
      padding: 10px 16px; border-radius: 8px;
      background: rgba(255, 255, 255, 0.1); color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      cursor: pointer; transition: all 0.3s;
    }
    .btn-info:hover { background: rgba(255, 255, 255, 0.15); }
    
    /* Empty State */
    .empty-state { text-align: center; padding: 80px 20px; }
    .empty-state-icon { font-size: 80px; margin-bottom: 20px; }
    .empty-state h3 { font-size: 24px; color: #fff; margin-bottom: 12px; }
    .empty-state p { color: var(--muted); margin-bottom: 24px; }
    
    /* Loading */
    .loading-spinner { text-align: center; padding: 60px; }
    .loading-spinner::after {
      content: ''; display: inline-block; width: 40px; height: 40px;
      border: 3px solid rgba(123, 97, 255, 0.3); border-top-color: var(--accent-1);
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Toast */
    .toast {
      position: fixed; bottom: 24px; right: 24px; padding: 16px 24px;
      border-radius: 12px; color: #fff; font-weight: 500; z-index: 20000;
      animation: slideIn 0.3s ease; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .toast.success { background: linear-gradient(90deg, #10b981, #059669); }
    .toast.error { background: linear-gradient(90deg, #ef4444, #dc2626); }
    .toast.info { background: linear-gradient(90deg, var(--accent-1), #5b4cd1); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* User profile styles */
    .user-profile { display: flex; align-items: center; gap: 10px; }
    .user-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; overflow: hidden;
    }
    .user-avatar span { color: #07102a; font-weight: bold; font-size: 16px; }
    #userName { color: var(--accent-1); font-weight: 600; }
  </style>
</head>
<body>
  <header class="container header">
    <div class="brand" onclick="window.location.href='index.html'" style="cursor:pointer">
      <img src="PIXOLOTEL.png" alt="Logo Pyxolotl" class="brand-logo" onerror="this.style.display='none'">
      <div>
        <div class="site-title">Pyxolotl</div>
        <div style="font-size:12px;color:var(--muted)">Marketplace de juegos indie mexicanos</div>
      </div>
    </div>

    <nav class="nav">
      <a href="index.html">üè† Inicio</a>
      <a href="biblioteca.html" style="color:var(--accent-1);font-weight:600">üìö Biblioteca</a>
      
      <div id="authButtons" style="display:flex;gap:8px">
        <a class="btn btn-ghost" href="inicio.html">Iniciar sesi√≥n</a>
      </div>
      
      <div id="userProfile" class="user-profile" style="display:none">
        <div id="userAvatar" class="user-avatar">
          <span id="userInitials">U</span>
        </div>
        <span id="userName">Usuario</span>
        <button id="logoutBtn" class="btn btn-ghost">Cerrar sesi√≥n</button>
      </div>
    </nav>
  </header>

  <main class="container" style="padding-top:40px">
    <h1 style="font-size:32px;margin-bottom:8px">üéÆ Mi Biblioteca de Juegos</h1>
    <p style="color:var(--muted);margin-bottom:40px">Todos tus juegos comprados y gratuitos</p>
    <div id="bibliotecaContainer" class="biblioteca-container">
      <div class="loading-spinner"></div>
    </div>
  </main>

  <script src="api.js"></script>
  <script>
    let bibliotecaItems = [];
    
    function showToast(message, type = 'info') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }
    
    function getImageUrl(url) {
      if (!url) return null;
      if (url.startsWith('http')) return url;
      return API_URL + url;
    }
    
    async function descargarJuego(juegoId, titulo) {
      showToast('‚è≥ Preparando descarga...', 'info');
      try {
        // Usar el endpoint de descarga de biblioteca
        apiDescargarBiblioteca(juegoId);
        showToast('‚úÖ ¬°Descarga iniciada!', 'success');
      } catch (error) {
        console.error('Error al descargar:', error);
        showToast('‚ùå Error al descargar', 'error');
      }
    }
    
    async function cargarBiblioteca() {
      const container = document.getElementById('bibliotecaContainer');
      
      if (!isAuthenticated()) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîí</div>
            <h3>Inicia sesi√≥n para ver tu biblioteca</h3>
            <p>Necesitas una cuenta para acceder a tus juegos</p>
            <a href="inicio.html" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;padding:12px 32px;border-radius:8px;text-decoration:none;display:inline-block">Iniciar sesi√≥n</a>
          </div>
        `;
        return;
      }
      
      try {
        const response = await apiGetBiblioteca();
        console.log('Respuesta biblioteca:', response);
        
        if (response.detail) throw new Error(response.detail);
        
        bibliotecaItems = response || [];
        
        if (bibliotecaItems.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üéÆ</div>
              <h3>Tu biblioteca est√° vac√≠a</h3>
              <p>Explora el cat√°logo y obt√©n tu primer juego</p>
              <a href="index.html" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;padding:12px 32px;border-radius:8px;text-decoration:none;display:inline-block">Explorar juegos</a>
            </div>
          `;
          return;
        }
        
        let html = '<div class="biblioteca-grid">';
        
        bibliotecaItems.forEach((item) => {
          const juego = item.juego;
          if (!juego) return;
          
          const initials = juego.titulo.substring(0, 2).toUpperCase();
          const imgUrl = getImageUrl(juego.portada_url);
          
          let thumbHtml = imgUrl 
            ? `<img src="${imgUrl}" alt="${juego.titulo}" onerror="this.parentElement.innerHTML='<span>${initials}</span>'">`
            : `<span>${initials}</span>`;
          
          html += `
            <article class="biblioteca-card">
              <div class="biblioteca-card-thumb">${thumbHtml}</div>
              <div class="biblioteca-card-info">
                <h3 class="biblioteca-card-title">${juego.titulo}</h3>
                <p class="biblioteca-card-meta">${juego.genero || 'Indie'} ‚Ä¢ ‚≠ê ${(juego.calificacion_promedio || 0).toFixed(1)}</p>
                <span class="biblioteca-card-badge ${item.es_gratuito ? 'gratis' : 'comprado'}">${item.es_gratuito ? '‚ú® Gratis' : 'üíé Comprado'}</span>
                <div class="biblioteca-card-actions">
                  <button class="btn-download" onclick="descargarJuego(${juego.id}, '${juego.titulo.replace(/'/g, "\\'")}')">
                    üì• Descargar
                  </button>
                  <a href="producto-detalle.html?id=${juego.id}" class="btn-info">‚ÑπÔ∏è Info</a>
                </div>
              </div>
            </article>
          `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error cargando biblioteca:', error);
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üòï</div>
            <h3>Error al cargar la biblioteca</h3>
            <p>${error.message || 'Por favor intenta de nuevo m√°s tarde'}</p>
            <button onclick="cargarBiblioteca()" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;padding:12px 32px;border-radius:8px;border:none;cursor:pointer">Reintentar</button>
          </div>
        `;
      }
    }
    
    function checkSession() {
      const user = getCurrentUser();
      const authButtons = document.getElementById('authButtons');
      const userProfile = document.getElementById('userProfile');
      
      if (user && isAuthenticated()) {
        authButtons.style.display = 'none';
        userProfile.style.display = 'flex';
        
        const initials = user.nombre ? user.nombre.substring(0, 2).toUpperCase() : 'U';
        document.getElementById('userInitials').textContent = initials;
        document.getElementById('userName').textContent = user.nombre || 'Usuario';
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
          logout();
          window.location.href = 'index.html';
        });
      } else {
        authButtons.style.display = 'flex';
        userProfile.style.display = 'none';
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      checkSession();
      cargarBiblioteca();
    });
  </script>
</body>
</html>
