<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pago ‚Äì Pyxolotl</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    .payment-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 28px;
    }
    .payment-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 32px;
      margin-top: 32px;
    }
    .payment-form {
      background: var(--card);
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    /* Estilos para Stripe Elements */
    #card-element {
      padding: 14px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: var(--glass);
      transition: border-color 0.2s;
    }
    #card-element.StripeElement--focus {
      border-color: var(--accent-1);
    }
    #card-element.StripeElement--invalid {
      border-color: #ff4757;
    }
    #card-errors {
      color: #ff4757;
      font-size: 13px;
      margin-top: 8px;
      min-height: 20px;
    }
    .order-summary {
      background: var(--card);
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    .order-item {
      display: flex;
      gap: 16px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 20px;
    }
    .order-thumb {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      background: linear-gradient(135deg,var(--accent-1),var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #07102a;
      font-size: 24px;
      flex-shrink: 0;
      overflow: hidden;
    }
    .order-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .order-details h4 {
      margin: 0 0 6px;
      font-size: 16px;
    }
    .order-details p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
    .price-line {
      display: flex;
      justify-content: space-between;
      margin: 12px 0;
      font-size: 15px;
    }
    .price-line.total {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-1);
      padding-top: 16px;
      border-top: 2px solid rgba(255,255,255,0.1);
      margin-top: 16px;
    }
    .stripe-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      padding: 14px;
      background: linear-gradient(90deg, rgba(99,91,255,0.1), rgba(0,212,170,0.1));
      border-radius: 8px;
      border: 1px solid rgba(99,91,255,0.2);
    }
    .stripe-badge img {
      height: 24px;
    }
    .stripe-badge span {
      font-size: 13px;
      color: var(--muted);
    }
    .security-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      padding: 12px;
      background: rgba(78,163,255,0.05);
      border-radius: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .success-message {
      display: none;
      text-align: center;
      padding: 60px 20px;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    }
    .success-message.show {
      display: block;
    }
    .success-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg,var(--accent-1),var(--accent-2));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 24px;
    }
    .test-cards {
      margin-top: 20px;
      padding: 16px;
      background: rgba(255,193,7,0.1);
      border: 1px solid rgba(255,193,7,0.3);
      border-radius: 8px;
    }
    .test-cards h4 {
      margin: 0 0 10px;
      color: #ffc107;
      font-size: 14px;
    }
    .test-cards code {
      display: block;
      padding: 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
      font-size: 13px;
      color: #fff;
      margin: 4px 0;
    }
    .test-cards small {
      color: var(--muted);
      font-size: 12px;
    }
    @media (max-width: 900px) {
      .payment-grid {
        grid-template-columns: 1fr;
      }
      .order-summary {
        position: static;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="container header">
    <div class="brand">
      <img src="PIXOLOTEL.png" alt="Logo Pyxolotl" class="brand-logo" onerror="this.style.display='none'">
      <div>
        <div class="site-title">Pyxolotl</div>
        <div style="font-size:12px;color:var(--muted)">Marketplace de juegos indie mexicanos</div>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">Inicio</a>
    </nav>
  </header>

  <div class="payment-container">
    <div style="text-align:center;margin-bottom:20px">
      <h1 style="margin:0 0 8px">Completar compra</h1>
      <p style="color:var(--muted);margin:0">Pago seguro con Stripe</p>
    </div>

    <div id="paymentSection" class="payment-grid">
      <!-- FORMULARIO DE PAGO -->
      <div>
        <div class="payment-form">
          <h3 style="margin-top:0">üí≥ Informaci√≥n de pago</h3>
          
          <form id="paymentForm">
            <div class="form-group">
              <label>Tarjeta de cr√©dito o d√©bito</label>
              <div id="card-element"></div>
              <div id="card-errors" role="alert"></div>
            </div>

            <div class="stripe-badge">
              <svg width="60" height="25" viewBox="0 0 60 25" fill="none">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M59.64 12.66c0-4.37-2.11-7.81-6.16-7.81-4.07 0-6.53 3.44-6.53 7.78 0 5.13 2.91 7.73 7.08 7.73 2.04 0 3.58-.46 4.75-1.1v-3.4c-1.17.58-2.51.95-4.21.95-1.67 0-3.14-.59-3.33-2.61h8.39c0-.22.01-1.1.01-1.54zm-8.47-1.62c0-1.94 1.19-2.75 2.27-2.75 1.05 0 2.17.81 2.17 2.75h-4.44zM40.17 4.85c-1.68 0-2.76.79-3.36 1.34l-.22-1.07h-3.75v19.54l4.26-.9.01-4.75c.62.45 1.53 1.08 3.04 1.08 3.07 0 5.87-2.47 5.87-7.91-.01-4.98-2.86-7.33-5.85-7.33zm-1.03 11.28c-1.01 0-1.61-.36-2.02-.81l-.03-6.38c.44-.5 1.06-.84 2.05-.84 1.57 0 2.65 1.76 2.65 4.01 0 2.3-1.06 4.02-2.65 4.02zM26.15 3.39l4.28-.91V0l-4.28.91v2.48zM26.15 5.12h4.28v14.65h-4.28V5.12zM21.54 6.28l-.27-1.16h-3.69v14.65h4.26V9.53c1.01-1.31 2.72-1.07 3.25-.88V5.12c-.55-.21-2.56-.59-3.55 1.16zM13.02 1.9l-4.17.89-.02 13.42c0 2.48 1.86 4.31 4.35 4.31 1.38 0 2.38-.25 2.94-.56v-3.46c-.54.22-3.21.99-3.21-1.5V8.53h3.21V5.12h-3.21L13.02 1.9zM4.33 9.07c0-.67.56-.93 1.48-.93 1.32 0 2.99.4 4.31 1.11V5.49c-1.44-.58-2.87-.8-4.31-.8C2.28 4.69 0 6.51 0 9.35c0 4.42 6.08 3.72 6.08 5.62 0 .79-.69 1.05-1.65 1.05-1.43 0-3.26-.59-4.71-1.38v3.82c1.6.69 3.23.98 4.71.98 3.62 0 6.11-1.79 6.11-4.66-.01-4.77-6.21-3.93-6.21-5.71z" fill="#635BFF"/>
              </svg>
              <span>Pago seguro procesado por Stripe</span>
            </div>

            <div class="security-badge">
              <span style="font-size:18px">üîí</span>
              <div>
                <strong style="color:#fff">Pago 100% seguro</strong><br>
                Encriptaci√≥n SSL de 256 bits
              </div>
            </div>

            <!-- Tarjetas de prueba (solo para entorno test) -->
            <div class="test-cards">
              <h4>üß™ Tarjetas de prueba (Modo Test)</h4>
              <code>4242 4242 4242 4242</code>
              <small>Usa cualquier fecha futura y cualquier CVC de 3 d√≠gitos</small>
            </div>

            <button type="submit" class="btn" id="payBtn" style="width:100%;margin-top:24px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;font-weight:600;padding:16px;font-size:16px">
              üí≥ Pagar <span id="payBtnAmount"></span>
            </button>
          </form>
        </div>
      </div>

      <!-- RESUMEN DEL PEDIDO -->
      <div class="order-summary">
        <h3 style="margin-top:0">üõí Resumen del pedido</h3>
        <div class="order-item">
          <div class="order-thumb" id="gameThumb">--</div>
          <div class="order-details">
            <h4 id="gameTitle">Cargando...</h4>
            <p>Juego digital ‚Ä¢ Descarga inmediata</p>
          </div>
        </div>
        <div id="gamesList"></div>
        <div class="price-line">
          <span>Subtotal</span>
          <span id="subtotal">$0.00 MXN</span>
        </div>
        <div class="price-line">
          <span>IVA (16%)</span>
          <span id="taxes">$0.00 MXN</span>
        </div>
        <div class="price-line">
          <span>Comisi√≥n de servicio</span>
          <span id="fee">$15.00 MXN</span>
        </div>
        <div class="price-line total">
          <span>Total</span>
          <span id="total">$0.00 MXN</span>
        </div>
      </div>
    </div>

    <!-- MENSAJE DE √âXITO -->
    <div id="successMessage" class="success-message">
      <div class="success-icon">‚úì</div>
      <h2 style="margin:0 0 12px;color:var(--accent-1)">¬°Compra exitosa!</h2>
      <p style="color:var(--muted);margin:0 0 24px;font-size:18px">Tu pago ha sido procesado correctamente</p>
      
      <div style="background:var(--glass);padding:20px;border-radius:12px;margin-bottom:24px">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span style="color:var(--muted)">N√∫mero de orden:</span>
          <span id="orderNumber" style="font-weight:600;color:var(--accent-1)">---</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span style="color:var(--muted)">Juego:</span>
          <span id="successGameTitle" style="font-weight:500">---</span>
        </div>
        <div style="display:flex;justify-content:space-between">
          <span style="color:var(--muted)">Total pagado:</span>
          <span id="successTotal" style="font-weight:600;color:var(--accent-2)">---</span>
        </div>
      </div>

      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <button id="downloadBtn" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;font-weight:600;padding:14px 28px">
          üì• Descargar ahora
        </button>
        <a href="biblioteca.html" class="btn" style="background:var(--glass);padding:14px 28px">
          üìö Ir a mi biblioteca
        </a>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastContainer" style="position:fixed;bottom:20px;right:20px;z-index:9999"></div>

  <script src="api.js"></script>
  <script>
    // ============================================
    // CONFIGURACI√ìN DE STRIPE
    // ============================================
    // Clave publicable de Stripe (modo test)
    const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SbsuO5USbcghZcA0EGbGbmMLdTnUQJoC6vcYHbNz0r3gOjHEYO34V7GHHWRUPav0PBnkiWH7K9qVK6lPSr0Fjhl007hHPy1mh';
    
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
    const elements = stripe.elements({
      locale: 'es'
    });
    
    // Estilo personalizado para el elemento de tarjeta
    const cardStyle = {
      base: {
        color: '#ffffff',
        fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, sans-serif',
        fontSmoothing: 'antialiased',
        fontSize: '16px',
        '::placeholder': {
          color: '#6b7280'
        }
      },
      invalid: {
        color: '#ff4757',
        iconColor: '#ff4757'
      }
    };
    
    const cardElement = elements.create('card', { style: cardStyle });
    cardElement.mount('#card-element');
    
    // Manejar errores de validaci√≥n en tiempo real
    cardElement.on('change', (event) => {
      const displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    });

    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let checkoutCart = [];
    let totalAmount = 0;
    let clientSecret = null;

    // Usar API_URL de api.js (ya est√° definida globalmente)

    // ============================================
    // FUNCIONES DE UTILIDAD
    // ============================================
    function showPaymentToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.style.cssText = `
        padding: 14px 20px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 14px;
        font-weight: 500;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? 'linear-gradient(90deg, #00d4aa, #4ea3ff)' : type === 'error' ? '#ff4757' : '#635BFF'};
        color: ${type === 'success' ? '#07102a' : '#fff'};
      `;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function getImageUrl(url) {
      if (!url) return null;
      if (url.startsWith('http')) return url;
      return API_URL + url;
    }

    // ============================================
    // FUNCI√ìN DE DESCARGA
    // ============================================
    function downloadPurchasedGame() {
      if (checkoutCart.length === 0) {
        showPaymentToast('No hay juego para descargar', 'error');
        return;
      }
      
      const game = checkoutCart[0];
      let downloadUrl = game.archivo_juego_url || game.downloadUrl;
      
      if (!downloadUrl) {
        showPaymentToast('üìö Ve a tu biblioteca para descargar', 'info');
        setTimeout(() => {
          window.location.href = 'biblioteca.html';
        }, 1500);
        return;
      }
      
      if (!downloadUrl.startsWith('http')) {
        downloadUrl = `${API_URL}${downloadUrl}`;
      }
      
      showPaymentToast('üì• Iniciando descarga...', 'success');
      
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `${game.title.replace(/[^a-z0-9]/gi, '_')}.zip`;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ============================================
    // INICIALIZACI√ìN
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Cargar datos del carrito
      checkoutCart = JSON.parse(sessionStorage.getItem('checkoutCart')) || [];
      
      if (checkoutCart.length === 0) {
        showPaymentToast('Tu carrito est√° vac√≠o', 'error');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1500);
        return;
      }

      // Verificar autenticaci√≥n
      const token = localStorage.getItem('auth_token');
      if (!token) {
        showPaymentToast('Debes iniciar sesi√≥n para comprar', 'error');
        setTimeout(() => {
          window.location.href = 'inicio.html';
        }, 1500);
        return;
      }

      // Calcular totales en PESOS MEXICANOS
      let subtotal = 0;
      checkoutCart.forEach(item => {
        subtotal += parseFloat(item.price);
      });

      const taxes = subtotal * 0.16;
      const fee = 15; // $15 MXN de comisi√≥n
      totalAmount = subtotal + taxes + fee;

      // Mostrar info del juego
      if (checkoutCart.length === 1) {
        document.getElementById('gameTitle').textContent = checkoutCart[0].title;
        const thumbEl = document.getElementById('gameThumb');
        if (checkoutCart[0].portada_url) {
          thumbEl.innerHTML = `<img src="${getImageUrl(checkoutCart[0].portada_url)}" alt="${checkoutCart[0].title}" onerror="this.parentElement.textContent='${checkoutCart[0].title.substring(0, 2).toUpperCase()}'">`;
        } else {
          thumbEl.textContent = checkoutCart[0].title.substring(0, 2).toUpperCase();
        }
      } else {
        document.getElementById('gameTitle').textContent = `${checkoutCart.length} juegos`;
        document.getElementById('gameThumb').textContent = checkoutCart.length;
        
        // Lista de juegos
        const gamesListEl = document.getElementById('gamesList');
        gamesListEl.style.cssText = 'margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.06)';
        checkoutCart.forEach(item => {
          const gameItem = document.createElement('div');
          gameItem.style.cssText = 'display:flex;justify-content:space-between;margin:8px 0;font-size:14px';
          gameItem.innerHTML = `
            <span style="color:var(--muted)">${item.title}</span>
            <span>$${parseFloat(item.price).toFixed(2)}</span>
          `;
          gamesListEl.appendChild(gameItem);
        });
      }

      // Actualizar precios en MXN
      document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)} MXN`;
      document.getElementById('taxes').textContent = `$${taxes.toFixed(2)} MXN`;
      document.getElementById('fee').textContent = `$${fee.toFixed(2)} MXN`;
      document.getElementById('total').textContent = `$${totalAmount.toFixed(2)} MXN`;
      document.getElementById('payBtnAmount').textContent = `$${totalAmount.toFixed(2)} MXN`;

      // Configurar bot√≥n de descarga
      document.getElementById('downloadBtn').addEventListener('click', downloadPurchasedGame);

      // Crear PaymentIntent al cargar la p√°gina
      try {
        const juegosIds = checkoutCart.map(item => item.id);
        
        const response = await fetch(`${API_URL}/api/pagos/crear-intent`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ juegos_ids: juegosIds })
        });
        
        const data = await response.json();
        
        if (response.ok && data.client_secret) {
          clientSecret = data.client_secret;
          console.log('‚úÖ PaymentIntent creado');
        } else {
          throw new Error(data.detail || 'Error al crear PaymentIntent');
        }
      } catch (error) {
        console.error('Error creando PaymentIntent:', error);
        showPaymentToast('‚ùå Error al preparar el pago: ' + error.message, 'error');
      }

      // ============================================
      // PROCESAR PAGO CON STRIPE
      // ============================================
      document.getElementById('paymentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!clientSecret) {
          showPaymentToast('Error: No se pudo inicializar el pago', 'error');
          return;
        }
        
        const btn = document.getElementById('payBtn');
        btn.textContent = 'Procesando...';
        btn.disabled = true;
        btn.style.opacity = '0.7';

        try {
          // Confirmar el pago con Stripe
          const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
              card: cardElement
            }
          });

          if (error) {
            throw new Error(error.message);
          }

          if (paymentIntent.status === 'succeeded') {
            // Pago exitoso - confirmar en nuestro backend
            const juegosIds = checkoutCart.map(item => item.id);
            
            const confirmResponse = await fetch(`${API_URL}/api/compras/confirmar-stripe`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
              },
              body: JSON.stringify({
                juegos_ids: juegosIds,
                payment_intent_id: paymentIntent.id,
                metodo_pago: 'stripe'
              })
            });
            
            const result = await confirmResponse.json();
            
            if (confirmResponse.ok && result.numero_orden) {
              // √âxito - mostrar mensaje
              document.getElementById('paymentSection').style.display = 'none';
              const successMsg = document.getElementById('successMessage');
              successMsg.classList.add('show');
              
              document.getElementById('orderNumber').textContent = `#${result.numero_orden}`;
              document.getElementById('successGameTitle').textContent = checkoutCart.length === 1 ? checkoutCart[0].title : `${checkoutCart.length} juegos`;
              document.getElementById('successTotal').textContent = `$${totalAmount.toFixed(2)} MXN`;

              // Limpiar carrito
              localStorage.removeItem('pyxolotl_cart');
              localStorage.removeItem('cart');
              sessionStorage.removeItem('checkoutCart');

              window.scrollTo({ top: 0, behavior: 'smooth' });
              showPaymentToast('‚úÖ ¬°Compra realizada exitosamente!', 'success');
            } else {
              throw new Error(result.detail || 'Error al confirmar la compra');
            }
          }
          
        } catch (error) {
          console.error('Error en pago:', error);
          showPaymentToast('‚ùå ' + (error.message || 'Error al procesar el pago'), 'error');
          
          btn.innerHTML = 'üí≥ Pagar <span id="payBtnAmount">$' + totalAmount.toFixed(2) + ' MXN</span>';
          btn.disabled = false;
          btn.style.opacity = '1';
        }
      });
    });
  </script>
  
  <style>
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</body>
</html>