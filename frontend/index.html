<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pyxolotl ‚Äì Indie Games Marketplace</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="container header">
    <div class="brand">
      <img id="brandImg" src="PIXOLOTEL.png" alt="Logo Pyxolotl" class="brand-logo" data-initials="PX" onerror="this.style.display='none'">
      <span id="brandFallback" class="logo" aria-hidden="true" style="display:none">PX</span>

      <div>
        <div class="site-title">Pyxolotl</div>
        <div style="font-size:12px;color:var(--muted)">Marketplace de juegos indie mexicanos</div>
      </div>
    </div>

    <nav class="nav">
      <a href="#features">Caracter√≠sticas</a>
      <a href="#gallery">Juegos</a>
      <a href="#about">Acerca</a>
      <a class="cta" href="publicar-juego.html" id="publicarBtn">Presentar juego</a>
      <a class="btn btn-ghost" href="inicio.html" id="loginBtn">Iniciar sesi√≥n</a>
      <!-- Perfil del usuario (oculto por defecto) -->
      <div id="userProfile" class="user-profile" style="display:none">
        <span id="userName">Usuario</span>
        <button id="logoutBtn" class="btn btn-ghost">Cerrar sesi√≥n</button>
      </div>
      <button id="cartBtn" class="btn btn-ghost" style="position:relative">
        üõí <span id="cartCount" class="cart-badge">0</span>
      </button>
    </nav>

    <button id="menuBtn" class="btn btn-ghost" aria-label="menu">‚ò∞</button>
  </header>

  <main class="container">
    <section class="hero fade-in">
      <div class="hero-left">
        <span class="kicker">Beta ¬∑ Pyxolotl</span>
        <h1>M√°s visibilidad para desarrolladores indie mexicanos</h1>
        <p>Pyxolotl es una vitrina pensada para creadores de videojuegos independientes. Sub√≠ tu proyecto, consigue feedback y llega a jugadores.</p>

        <div class="hero-cta">
          <a class="btn" href="#gallery" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">Explorar juegos</a>
          <a class="btn btn-ghost" href="publicar-juego.html">Presentar tu juego</a>
        </div>
      </div>

      <div style="flex:1">
        <div style="background:linear-gradient(135deg,var(--accent-1),var(--accent-2));padding:18px;border-radius:16px">
          <div style="color:#07102a;font-weight:700">Destacado</div>
          <div style="height:220px;margin-top:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.07), rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center">üéÆ Juegos indie mexicanos</div>
        </div>
      </div>
    </section>

    <section id="features" class="features">
      <div class="feature">
        <h4>Visibilidad</h4>
        <p>Conecta con jugadores y otros desarrolladores. Promociona tus builds y demos.</p>
      </div>
      <div class="feature">
        <h4>Feedback</h4>
        <p>Recibe comentarios constructivos y m√©tricas para mejorar tu juego.</p>
      </div>
      <div class="feature">
        <h4>Colaboraciones</h4>
        <p>Encuentra artistas, m√∫sicos y programadores interesados en colaborar.</p>
      </div>
    </section>

    <section id="gallery">
      <h2 style="margin-top:0">Cat√°logo de Juegos</h2>
      
      <!-- SECCI√ìN DE JUEGOS GRATIS (Din√°mico desde BD) -->
      <div id="freeGamesSection" style="margin-bottom:30px;display:none">
        <h3 style="color:var(--accent-1);display:flex;align-items:center;gap:8px">
          üéÆ Juegos Gratis - ¬°Juega ahora!
        </h3>
        <div class="grid" id="freeGamesGrid"></div>
      </div>

      <!-- SECCI√ìN DE JUEGOS DE PAGO (Din√°mico desde BD) -->
      <div id="paidGamesSection" style="display:none">
        <h3 style="color:var(--accent-2);display:flex;align-items:center;gap:8px">
          üíé Juegos Premium
        </h3>
        <div class="grid" id="paidGamesGrid"></div>
      </div>

      <!-- MENSAJE SI NO HAY JUEGOS -->
      <div id="noGamesMessage" style="text-align:center;padding:60px 20px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">üéÆ</div>
        <h3>A√∫n no hay juegos publicados</h3>
        <p>¬°S√© el primero en publicar un juego indie en Pyxolotl!</p>
        <a href="publicar-juego.html" class="btn" style="margin-top:20px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">
          Publicar mi juego
        </a>
      </div>

      <!-- LOADER -->
      <div id="gamesLoader" style="text-align:center;padding:40px">
        <div style="display:inline-block;width:40px;height:40px;border:4px solid rgba(255,255,255,0.1);border-top-color:var(--accent-1);border-radius:50%;animation:spin 1s linear infinite"></div>
        <p style="margin-top:16px;color:var(--muted)">Cargando juegos...</p>
      </div>
    </section>

    <section id="about" style="margin-top:28px">
      <h2>Acerca de Pyxolotl</h2>
      <p style="color:var(--muted)">Pyxolotl es una plataforma para ayudar a desarrolladores indie mexicanos a obtener exposici√≥n. Publica tu juego, recibe feedback y conecta con jugadores.</p>
    </section>

    <footer class="footer">
      <div class="container center" style="flex-direction:column;gap:10px">
        <div style="width:100%;display:flex;justify-content:space-between;align-items:center;max-width:var(--max-width)">
          <div>¬© 2025 Pyxolotl ¬∑ Hecho con ‚ô• para desarrolladores indie</div>
          <div style="color:var(--muted)">Contacto: pyxolotl@example.com</div>
        </div>
      </div>
    </footer>
  </main>

  <!-- MODAL CARRITO -->
  <div id="cartModal" class="modal">
    <div class="panel" style="max-width:600px">
      <button class="close-cart" style="float:right;background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer">‚úï</button>
      <h3>üõí Tu Carrito</h3>
      
      <div id="cartItems" style="margin-top:20px;max-height:300px;overflow-y:auto"></div>

      <div id="cartEmpty" style="text-align:center;padding:40px;color:var(--muted)">
        El carrito est√° vac√≠o
      </div>

      <div id="cartSummary" style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1);display:none">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span>Subtotal:</span>
          <span id="subtotal">$0.00</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span>IVA (16%):</span>
          <span id="tax">$0.00</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:20px;font-weight:700;color:var(--accent-1)">
          <span>Total:</span>
          <span id="total">$0.00</span>
        </div>
      </div>

      <button id="checkoutBtn" class="btn" style="width:100%;margin-top:20px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;font-weight:700;display:none">
        Proceder al pago
      </button>
    </div>
  </div>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #userName {
      font-weight: 600;
      color: var(--accent-1);
    }
  </style>

  <script src="api.js"></script>
  <script src="cart.js"></script>
  <script>
    // Cargar juegos desde la base de datos
    async function loadGames() {
      const loader = document.getElementById('gamesLoader');
      const noGamesMsg = document.getElementById('noGamesMessage');
      const freeSection = document.getElementById('freeGamesSection');
      const paidSection = document.getElementById('paidGamesSection');
      const freeGrid = document.getElementById('freeGamesGrid');
      const paidGrid = document.getElementById('paidGamesGrid');

      try {
        // Llamar a la API para obtener juegos aprobados
        const response = await apiGetJuegos({ estado: 'aprobado' });
        
        loader.style.display = 'none';

        if (!response || response.length === 0) {
          noGamesMsg.style.display = 'block';
          return;
        }

        noGamesMsg.style.display = 'none';

        // Separar juegos gratis y de pago
        const freeGames = response.filter(game => parseFloat(game.precio) === 0);
        const paidGames = response.filter(game => parseFloat(game.precio) > 0);

        // Mostrar juegos gratis
        if (freeGames.length > 0) {
          freeSection.style.display = 'block';
          freeGames.forEach(game => {
            const card = createGameCard(game, true);
            freeGrid.appendChild(card);
          });
        }

        // Mostrar juegos de pago
        if (paidGames.length > 0) {
          paidSection.style.display = 'block';
          paidGames.forEach(game => {
            const card = createGameCard(game, false);
            paidGrid.appendChild(card);
          });
        }

      } catch (error) {
        console.error('Error al cargar juegos:', error);
        loader.style.display = 'none';
        noGamesMsg.style.display = 'block';
        noGamesMsg.innerHTML = `
          <div style="font-size:48px;margin-bottom:16px">‚ö†Ô∏è</div>
          <h3>Error al cargar juegos</h3>
          <p>No se pudo conectar con el servidor. Por favor intenta m√°s tarde.</p>
        `;
      }
    }

    // Crear tarjeta de juego
    function createGameCard(game, isFree) {
      const article = document.createElement('article');
      article.className = 'card';
      article.style.cursor = 'pointer';

      const thumbnailDiv = document.createElement('div');
      thumbnailDiv.className = 'thumb';
      
      if (game.imagen_portada) {
        thumbnailDiv.style.backgroundImage = `url(${game.imagen_portada})`;
        thumbnailDiv.style.backgroundSize = 'cover';
        thumbnailDiv.style.backgroundPosition = 'center';
      } else {
        thumbnailDiv.textContent = game.titulo.substring(0, 2).toUpperCase();
      }

      const title = document.createElement('h3');
      title.textContent = game.titulo;

      const description = document.createElement('p');
      description.textContent = `${game.genero} ¬∑ ${game.desarrollador_nombre || 'Indie'}`;

      article.appendChild(thumbnailDiv);
      article.appendChild(title);
      article.appendChild(description);

      if (isFree) {
        const freeTag = document.createElement('div');
        freeTag.style.cssText = 'margin-top:8px;padding:8px;background:rgba(76,175,80,0.1);border-radius:6px';
        freeTag.innerHTML = '<small style="color:#4CAF50;font-weight:600">‚ú® GRATIS</small>';
        article.appendChild(freeTag);

        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn';
        downloadBtn.style.cssText = 'width:100%;margin-top:12px;background:linear-gradient(90deg,#4CAF50,#45a049);color:#fff;font-weight:600';
        downloadBtn.textContent = '‚¨áÔ∏è Obtener gratis';
        downloadBtn.onclick = () => handleFreeGame(game.id);
        article.appendChild(downloadBtn);
      } else {
        const priceRow = document.createElement('div');
        priceRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-top:12px';
        
        const priceSpan = document.createElement('span');
        priceSpan.style.cssText = 'font-size:18px;font-weight:700;color:var(--accent-1)';
        priceSpan.textContent = `$${parseFloat(game.precio).toFixed(2)}`;
        
        const addBtn = document.createElement('button');
        addBtn.className = 'btn';
        addBtn.style.cssText = 'background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;padding:8px 16px';
        addBtn.textContent = 'Agregar';
        addBtn.onclick = (e) => {
          e.stopPropagation();
          handleAddToCart(game);
        };
        
        priceRow.appendChild(priceSpan);
        priceRow.appendChild(addBtn);
        article.appendChild(priceRow);
      }

      // Click en la tarjeta para ver detalles
      article.onclick = () => {
        window.location.href = `producto-detalle.html?id=${game.id}`;
      };

      return article;
    }

    // Manejar juego gratis
    async function handleFreeGame(gameId) {
      if (!isAuthenticated()) {
        alert('Debes iniciar sesi√≥n para obtener juegos gratis');
        window.location.href = 'inicio.html';
        return;
      }

      try {
        const response = await apiGetJuegoGratis(gameId);
        if (response.success) {
          alert('‚úÖ ¬°Juego agregado a tu biblioteca! Ya puedes descargarlo.');
          window.location.href = 'biblioteca.html';
        } else {
          alert('‚ùå ' + (response.message || 'Error al obtener el juego'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al procesar la solicitud');
      }
    }

    // Manejar agregar al carrito
    function handleAddToCart(game) {
      if (!isAuthenticated()) {
        alert('Debes iniciar sesi√≥n para agregar juegos al carrito');
        window.location.href = 'inicio.html';
        return;
      }

      // Usar la funci√≥n del cart.js
      if (typeof window.addToCart === 'function') {
        window.addToCart(game.id, game.titulo, game.precio, game.imagen_portada);
      }
    }

    // Verificar autenticaci√≥n y mostrar perfil
    function checkAuth() {
      const user = getCurrentUser();
      const loginBtn = document.getElementById('loginBtn');
      const userProfile = document.getElementById('userProfile');
      const userName = document.getElementById('userName');

      if (user && isAuthenticated()) {
        loginBtn.style.display = 'none';
        userProfile.style.display = 'flex';
        userName.textContent = user.nombre;
      } else {
        loginBtn.style.display = 'block';
        userProfile.style.display = 'none';
      }
    }

    // Cerrar sesi√≥n
    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
        logout();
      }
    });

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadGames();
    });
  </script>
</body>
</html>