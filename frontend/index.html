<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pyxolotl ‚Äì Indie Games Marketplace</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos para el perfil de usuario */
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .user-avatar span {
      color: #07102a;
      font-weight: bold;
      font-size: 16px;
    }
    
    #userName {
      color: var(--accent-1);
      font-weight: 600;
      cursor: pointer;
    }
    
    #userName:hover {
      text-decoration: underline;
    }
    
    /* Modal de perfil */
    .profile-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .profile-modal.active {
      display: flex;
    }
    
    .profile-modal-content {
      background: var(--card);
      padding: 30px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      animation: slideUp 0.4s ease;
    }
    
    .profile-header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    .profile-avatar-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    
    .profile-avatar-large:hover .avatar-overlay {
      opacity: 1;
    }
    
    .avatar-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .avatar-overlay span {
      color: white;
      font-size: 14px;
    }
    
    .profile-avatar-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-avatar-large span {
      color: #07102a;
      font-weight: bold;
      font-size: 48px;
    }
    
    .profile-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .profile-form label {
      display: flex;
      flex-direction: column;
      gap: 5px;
      color: var(--muted);
      font-size: 14px;
    }
    
    .profile-form input[type="text"],
    .profile-form textarea {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: var(--glass);
      color: #fff;
      font-family: inherit;
    }
    
    .profile-form textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .profile-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .profile-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-save {
      background: linear-gradient(90deg, var(--accent-2), var(--accent-1));
      color: #07102a;
    }
    
    .btn-cancel {
      background: var(--glass);
      color: #fff;
    }
    
    .btn-save:hover,
    .btn-cancel:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    #avatarInput {
      display: none;
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <header class="container header">
    <div class="brand" onclick="window.location.href='index.html'" style="cursor:pointer">
      <img id="brandImg" src="PIXOLOTEL.png" alt="Logo Pyxolotl" class="brand-logo" data-initials="PX" onerror="this.style.display='none'">
      <span id="brandFallback" class="logo" aria-hidden="true" style="display:none">PX</span>

      <div>
        <div class="site-title">Pyxolotl</div>
        <div style="font-size:12px;color:var(--muted)">Marketplace de juegos indie mexicanos</div>
      </div>
    </div>

    <nav class="nav">
      <a href="#features">Caracter√≠sticas</a>
      <a href="#gallery">Juegos</a>
      <a href="#about">Acerca</a>
      <a class="cta" href="#" onclick="validarPublicarJuego(event)" id="publicarBtn">Presentar juego</a>
      <a class="btn btn-ghost" href="inicio.html" id="loginBtn">Iniciar sesi√≥n</a>
      <a class="btn" href="inicio.html#registro" id="registerBtn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">Registrarse</a>
      
      <!-- Perfil del usuario (oculto por defecto) -->
      <div id="userProfile" class="user-profile" style="display:none">
        <!-- Avatar circular con foto o iniciales -->
        <div id="userAvatar" class="user-avatar" onclick="openProfileModal()">
          <span id="userInitials">U</span>
        </div>
        <span id="userName" style="cursor:pointer" onclick="openProfileModal()">Usuario</span>
        <button id="logoutBtn" class="btn btn-ghost">Cerrar sesi√≥n</button>
      </div>
      
      <button id="cartBtn" class="btn btn-ghost" style="position:relative">
        üõí <span id="cartCount" class="cart-badge">0</span>
      </button>
    </nav>

    <button id="menuBtn" class="btn btn-ghost" aria-label="menu">‚ò∞</button>
  </header>

  <!-- Modal de Perfil de Usuario -->
  <div id="profileModal" class="profile-modal">
    <div class="profile-modal-content">
      <div class="profile-header">
        <h2>Mi Perfil</h2>
        <div class="profile-avatar-large" onclick="document.getElementById('avatarInput').click()">
          <img id="profileAvatarImg" src="" alt="" style="display:none">
          <span id="profileInitials">U</span>
          <div class="avatar-overlay">
            <span>Cambiar foto</span>
          </div>
        </div>
        <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarChange(event)">
        <h3 id="profileName">Usuario</h3>
        <p style="color:var(--muted);font-size:14px" id="profileEmail">email@ejemplo.com</p>
      </div>
      
      <form class="profile-form" id="profileForm">
        <label>
          Sobrenombre (m√°ximo 16 caracteres)
          <input type="text" id="nickname" maxlength="16" placeholder="Tu sobrenombre">
        </label>
        
        <label>
          Descripci√≥n personal
          <textarea id="description" placeholder="Cu√©ntanos algo sobre ti..."></textarea>
        </label>
        
        <div class="profile-actions">
          <button type="button" class="btn-cancel" onclick="closeProfileModal()">Cancelar</button>
          <button type="submit" class="btn-save">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <main class="container">
    <section class="hero fade-in">
      <div class="hero-left">
        <span class="kicker">Beta ¬∑ Pyxolotl</span>
        <h1>M√°s visibilidad para desarrolladores indie mexicanos</h1>
        <p>Pyxolotl es una vitrina pensada para creadores de videojuegos independientes. Sub√≠ tu proyecto, consigue feedback y llega a jugadores.</p>

        <div class="hero-cta">
          <a class="btn" href="#gallery" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">Explorar juegos</a>
          <a class="btn btn-ghost" href="#" onclick="validarPublicarJuego(event)" id="publicarBtnHero">Presentar tu juego</a>
        </div>
      </div>

      <div style="flex:1">
        <div style="background:linear-gradient(135deg,var(--accent-1),var(--accent-2));padding:18px;border-radius:16px">
          <div style="color:#07102a;font-weight:700">Destacado</div>
          <div style="height:220px;margin-top:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.07), rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center">üéÆ Juegos indie mexicanos</div>
        </div>
      </div>
    </section>

    <section id="features" class="features">
      <div class="feature">
        <h4>Visibilidad</h4>
        <p>Conecta con jugadores y otros desarrolladores. Promociona tus builds y demos.</p>
      </div>
      <div class="feature">
        <h4>Feedback</h4>
        <p>Recibe comentarios constructivos y m√©tricas para mejorar tu juego.</p>
      </div>
      <div class="feature">
        <h4>Colaboraciones</h4>
        <p>Encuentra artistas, m√∫sicos y programadores interesados en colaborar.</p>
      </div>
    </section>

    <section id="gallery">
      <h2 style="margin-top:0">Cat√°logo de Juegos</h2>
      
      <!-- SECCI√ìN DE JUEGOS GRATIS (Din√°mico desde BD) -->
      <div id="freeGamesSection" style="margin-bottom:30px;display:none">
        <h3 style="color:var(--accent-1);display:flex;align-items:center;gap:8px">
          üéÆ Juegos Gratis - ¬°Juega ahora!
        </h3>
        <div class="grid" id="freeGamesGrid"></div>
      </div>

      <!-- SECCI√ìN DE JUEGOS DE PAGO (Din√°mico desde BD) -->
      <div id="paidGamesSection" style="display:none">
        <h3 style="color:var(--accent-2);display:flex;align-items:center;gap:8px">
          üíé Juegos Premium
        </h3>
        <div class="grid" id="paidGamesGrid"></div>
      </div>

      <!-- MENSAJE SI NO HAY JUEGOS -->
      <div id="noGamesMessage" style="text-align:center;padding:60px 20px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">üéÆ</div>
        <h3>A√∫n no hay juegos publicados</h3>
        <p>¬°S√© el primero en publicar un juego indie en Pyxolotl!</p>
        <a href="publicar-juego.html" class="btn" style="margin-top:20px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">
          Publicar mi juego
        </a>
      </div>

      <!-- LOADER -->
      <div id="gamesLoader" style="text-align:center;padding:40px">
        <div style="display:inline-block;width:40px;height:40px;border:4px solid rgba(255,255,255,0.1);border-top-color:var(--accent-1);border-radius:50%;animation:spin 1s linear infinite"></div>
        <p style="margin-top:16px;color:var(--muted)">Cargando juegos...</p>
      </div>
    </section>

    <section id="about" style="margin-top:28px">
      <h2>Acerca de Pyxolotl</h2>
      <p style="color:var(--muted)">Pyxolotl es una plataforma para ayudar a desarrolladores indie mexicanos a obtener exposici√≥n. Publica tu juego, recibe feedback y conecta con jugadores.</p>
    </section>

    <footer class="footer">
      <div class="container center" style="flex-direction:column;gap:10px">
        <div style="width:100%;display:flex;justify-content:space-between;align-items:center;max-width:var(--max-width)">
          <div>¬© 2025 Pyxolotl ¬∑ Hecho con ‚ô• para desarrolladores indie</div>
          <div style="color:var(--muted)">Contacto: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5a3935342e3b392e351a2a23223536352e36743722">[email&#160;protected]</a></div>
        </div>
      </div>
    </footer>
  </main>

  <!-- MODAL CARRITO -->
  <div id="cartModal" class="modal">
    <div class="panel" style="max-width:600px">
      <button class="close-cart" style="float:right;background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer">‚úï</button>
      <h3>üõí Tu Carrito</h3>
      
      <div id="cartItems" style="margin-top:20px;max-height:300px;overflow-y:auto"></div>

      <div id="cartEmpty" style="text-align:center;padding:40px;color:var(--muted)">
        El carrito est√° vac√≠o
      </div>

      <div id="cartSummary" style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1);display:none">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span>Subtotal:</span>
          <span id="subtotal">$0.00</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span>IVA (16%):</span>
          <span id="tax">$0.00</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:20px;font-weight:700;color:var(--accent-1)">
          <span>Total:</span>
          <span id="total">$0.00</span>
        </div>
      </div>

      <button id="checkoutBtn" class="btn" style="width:100%;margin-top:20px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;font-weight:700;display:none">
        Proceder al pago
      </button>
    </div>
  </div>

  <!-- MODAL DE PERFIL -->
  <div id="profileModal" class="modal">
    <div class="panel" style="max-width:700px">
      <button class="close-profile" style="float:right;background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer">‚úï</button>
      <h2>üë§ Mi Perfil</h2>
      
      <div style="margin-top:24px">
        <!-- Avatar grande con opci√≥n de cambiar -->
        <div style="text-align:center;margin-bottom:30px">
          <div id="profileAvatarLarge" class="profile-avatar-large">
            <span id="profileInitialsLarge">U</span>
          </div>
          <div style="margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <label for="avatarUpload" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;cursor:pointer">
              üì∑ Cambiar foto
            </label>
            <button id="removeAvatarBtn" class="btn btn-ghost" style="display:none">
              üóëÔ∏è Eliminar foto
            </button>
            <input type="file" id="avatarUpload" accept="image/*" style="display:none">
          </div>
          <div id="uploadProgress" style="display:none;margin-top:10px;color:var(--accent-1)">
            Procesando imagen...
          </div>
        </div>

        <!-- Informaci√≥n del perfil -->
        <div style="display:grid;gap:20px">
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);font-size:14px">Nombre de usuario</label>
            <input type="text" id="profileNameInput" class="profile-input" placeholder="Tu nombre">
          </div>

          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);font-size:14px">Correo electr√≥nico</label>
            <input type="email" id="profileEmailInput" class="profile-input" readonly style="opacity:0.6;cursor:not-allowed">
          </div>

          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);font-size:14px">Tipo de cuenta</label>
            <input type="text" id="profileTypeInput" class="profile-input" readonly style="opacity:0.6;cursor:not-allowed">
          </div>

          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);font-size:14px">Biograf√≠a</label>
            <textarea id="profileBioInput" class="profile-input" rows="4" placeholder="Cu√©ntanos sobre ti..." style="resize:vertical"></textarea>
          </div>

          <!-- Secci√≥n de cambio de contrase√±a -->
          <div style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1)">
            <h3 style="margin-bottom:16px;font-size:18px">üîí Cambiar Contrase√±a</h3>
            <div id="passwordSection">
              <button id="showPasswordChangeBtn" class="btn btn-ghost" style="width:100%">
                Cambiar mi contrase√±a
              </button>
              
              <div id="passwordChangeForm" style="display:none;margin-top:16px">
                <div style="margin-bottom:12px">
                  <label style="display:block;margin-bottom:8px;color:var(--muted);font-size:14px">Contrase√±a actual</label>
                  <input type="password" id="currentPassword" class="profile-input" placeholder="Ingresa tu contrase√±a actual">
                </div>
                <div style="margin-bottom:12px">
                  <label style="display:block;margin-bottom:8px;color:var(--muted);font-size:14px">Nueva contrase√±a</label>
                  <input type="password" id="newPassword" class="profile-input" placeholder="M√≠nimo 8 caracteres" minlength="8">
                </div>
                <div style="margin-bottom:12px">
                  <label style="display:block;margin-bottom:8px;color:var(--muted);font-size:14px">Confirmar nueva contrase√±a</label>
                  <input type="password" id="confirmPassword" class="profile-input" placeholder="Repite la nueva contrase√±a">
                </div>
                <div style="display:flex;gap:8px">
                  <button id="changePasswordBtn" class="btn" style="flex:1;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;font-weight:600">
                    Cambiar contrase√±a
                  </button>
                  <button id="cancelPasswordBtn" class="btn btn-ghost" style="flex:1">
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Botones de acci√≥n -->
        <div style="display:flex;gap:12px;margin-top:24px">
          <button id="saveProfileBtn" class="btn" style="flex:1;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;font-weight:600">
            üíæ Guardar cambios
          </button>
          <button class="btn btn-ghost close-profile" style="flex:1">
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    #userName {
      font-weight: 600;
      color: var(--accent-1);
    }
    
    /* Avatar del usuario */
    .user-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #07102a;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 3px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }
    
    .user-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(123,97,255,0.3);
    }
    
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Avatar grande en el modal */
    .profile-avatar-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #07102a;
      font-size: 40px;
      border: 4px solid rgba(255,255,255,0.1);
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(123,97,255,0.3);
    }
    
    .profile-avatar-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Inputs del perfil */
    .profile-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: var(--glass);
      color: #fff;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    .profile-input:focus {
      outline: none;
      border-color: var(--accent-1);
    }
    
    .profile-input::placeholder {
      color: var(--muted);
    }
  </style>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="api.js"></script>
  <script src="cart.js"></script>
  <script>
    // ============================================
    // SISTEMA DE PERFIL CON LOCALSTORAGE
    // ============================================
    
    function getProfileData() {
      const saved = localStorage.getItem('user_profile');
      if (saved) {
        return JSON.parse(saved);
      }
      return {
        avatarBase64: null, // Imagen guardada como base64
        displayName: null,
        bio: null
      };
    }

    function saveProfileData(data) {
      localStorage.setItem('user_profile', JSON.stringify(data));
      updateUserInterface();
    }

    function updateUserInterface() {
      const user = getCurrentUser();
      const profile = getProfileData();
      
      if (!user) return;

      // Actualizar nombre (prioridad: displayName > nombre del usuario)
      const displayName = profile.displayName || user.nombre;
      document.getElementById('userName').textContent = displayName;
      document.getElementById('profileNameInput').value = profile.displayName || user.nombre;

      // Actualizar avatar peque√±o
      const userAvatar = document.getElementById('userAvatar');
      const userInitials = document.getElementById('userInitials');
      
      if (profile.avatarBase64) {
        userAvatar.innerHTML = `<img src="${profile.avatarBase64}" alt="Avatar">`;
      } else {
        const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        userInitials.textContent = initials;
      }

      // Actualizar avatar grande en modal
      const profileAvatarLarge = document.getElementById('profileAvatarLarge');
      const profileInitialsLarge = document.getElementById('profileInitialsLarge');
      const removeAvatarBtn = document.getElementById('removeAvatarBtn');
      
      if (profile.avatarBase64) {
        profileAvatarLarge.innerHTML = `<img src="${profile.avatarBase64}" alt="Avatar">`;
        removeAvatarBtn.style.display = 'inline-block'; // Mostrar bot√≥n de eliminar
      } else {
        const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        profileInitialsLarge.textContent = initials;
        removeAvatarBtn.style.display = 'none'; // Ocultar bot√≥n de eliminar
      }

      // Actualizar otros campos
      document.getElementById('profileEmailInput').value = user.email;
      document.getElementById('profileTypeInput').value = 
        user.tipo_cuenta === 'desarrollador' ? 'Desarrollador' : 'Comprador';
      document.getElementById('profileBioInput').value = profile.bio || '';
    }

    function openProfileModal() {
      document.getElementById('profileModal').classList.add('show');
      updateUserInterface();
    }

    function closeProfileModal() {
      document.getElementById('profileModal').classList.remove('show');
    }

    // Event listeners para cerrar modales
    document.querySelectorAll('.close-profile').forEach(btn => {
      btn.addEventListener('click', closeProfileModal);
    });

    // Cerrar modal al hacer click fuera
    document.getElementById('profileModal').addEventListener('click', (e) => {
      if (e.target.id === 'profileModal') {
        closeProfileModal();
      }
    });

    // ============================================
    // SUBIR IMAGEN LOCAL (BASE64)
    // ============================================
    
    document.getElementById('avatarUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validar tipo de archivo
      if (!file.type.startsWith('image/')) {
        alert('‚ùå Por favor selecciona una imagen v√°lida');
        return;
      }

      // Validar tama√±o (m√°x 2MB para localStorage)
      if (file.size > 2 * 1024 * 1024) {
        alert('‚ùå La imagen es demasiado grande. M√°ximo 2MB');
        return;
      }

      const uploadProgress = document.getElementById('uploadProgress');
      uploadProgress.style.display = 'block';
      uploadProgress.textContent = 'Procesando imagen...';

      // Leer archivo como base64
      const reader = new FileReader();
      
      reader.onload = function(event) {
        const base64Image = event.target.result;
        
        // Guardar en perfil
        const profile = getProfileData();
        profile.avatarBase64 = base64Image;
        saveProfileData(profile);

        uploadProgress.style.display = 'none';
        alert('‚úÖ Foto de perfil actualizada correctamente');
      };

      reader.onerror = function() {
        uploadProgress.style.display = 'none';
        alert('‚ùå Error al procesar la imagen. Por favor intenta de nuevo.');
      };

      reader.readAsDataURL(file);
    });

    // ============================================
    // ELIMINAR FOTO DE PERFIL
    // ============================================
    
    document.getElementById('removeAvatarBtn').addEventListener('click', () => {
      if (confirm('¬øEst√°s seguro de que quieres eliminar tu foto de perfil?')) {
        const profile = getProfileData();
        profile.avatarBase64 = null;
        saveProfileData(profile);
        alert('‚úÖ Foto de perfil eliminada');
      }
    });

    // ============================================
    // CAMBIAR CONTRASE√ëA
    // ============================================
    
    // Mostrar/ocultar formulario de cambio de contrase√±a
    document.getElementById('showPasswordChangeBtn').addEventListener('click', () => {
      const form = document.getElementById('passwordChangeForm');
      const btn = document.getElementById('showPasswordChangeBtn');
      
      if (form.style.display === 'none') {
        form.style.display = 'block';
        btn.style.display = 'none';
      }
    });

    document.getElementById('cancelPasswordBtn').addEventListener('click', () => {
      const form = document.getElementById('passwordChangeForm');
      const btn = document.getElementById('showPasswordChangeBtn');
      
      form.style.display = 'none';
      btn.style.display = 'block';
      
      // Limpiar campos
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    });

    document.getElementById('changePasswordBtn').addEventListener('click', async () => {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validaciones
      if (!currentPassword || !newPassword || !confirmPassword) {
        alert('‚ùå Por favor completa todos los campos');
        return;
      }

      if (newPassword.length < 8) {
        alert('‚ùå La nueva contrase√±a debe tener al menos 8 caracteres');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('‚ùå Las contrase√±as no coinciden');
        return;
      }

      const btn = document.getElementById('changePasswordBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Cambiando...';
      btn.disabled = true;

      try {
        // Llamar a la API para cambiar la contrase√±a
        const response = await apiCambiarPassword(currentPassword, newPassword);
        
        if (response.success) {
          alert('‚úÖ Contrase√±a cambiada correctamente');
          
          // Limpiar y ocultar formulario
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
          document.getElementById('passwordChangeForm').style.display = 'none';
          document.getElementById('showPasswordChangeBtn').style.display = 'block';
        } else {
          alert('‚ùå ' + (response.message || 'Error al cambiar la contrase√±a'));
        }
        
      } catch (error) {
        console.error('Error cambiando contrase√±a:', error);
        alert('‚ùå Error al cambiar la contrase√±a. Por favor intenta de nuevo.');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    });

    // ============================================
    // GUARDAR CAMBIOS DEL PERFIL
    // ============================================
    
    document.getElementById('saveProfileBtn').addEventListener('click', () => {
      const profile = getProfileData();
      const newName = document.getElementById('profileNameInput').value.trim();
      const newBio = document.getElementById('profileBioInput').value.trim();

      if (!newName) {
        alert('‚ùå El nombre no puede estar vac√≠o');
        return;
      }

      profile.displayName = newName;
      profile.bio = newBio;
      
      saveProfileData(profile);
      closeProfileModal();
      
      alert('‚úÖ Perfil actualizado correctamente');
    });

    // ============================================
    // CARGAR JUEGOS DESDE LA BASE DE DATOS
    // ============================================
    
    async function loadGames() {
      const loader = document.getElementById('gamesLoader');
      const noGamesMsg = document.getElementById('noGamesMessage');
      const freeSection = document.getElementById('freeGamesSection');
      const paidSection = document.getElementById('paidGamesSection');
      const freeGrid = document.getElementById('freeGamesGrid');
      const paidGrid = document.getElementById('paidGamesGrid');

      try {
        const response = await apiGetJuegos({ estado: 'aprobado' });
        
        loader.style.display = 'none';

        if (!response || response.length === 0) {
          noGamesMsg.style.display = 'block';
          return;
        }

        noGamesMsg.style.display = 'none';

        const freeGames = response.filter(game => parseFloat(game.precio) === 0);
        const paidGames = response.filter(game => parseFloat(game.precio) > 0);

        if (freeGames.length > 0) {
          freeSection.style.display = 'block';
          freeGames.forEach(game => {
            const card = createGameCard(game, true);
            freeGrid.appendChild(card);
          });
        }

        if (paidGames.length > 0) {
          paidSection.style.display = 'block';
          paidGames.forEach(game => {
            const card = createGameCard(game, false);
            paidGrid.appendChild(card);
          });
        }

      } catch (error) {
        console.error('Error al cargar juegos:', error);
        loader.style.display = 'none';
        noGamesMsg.style.display = 'block';
        noGamesMsg.innerHTML = `
          <div style="font-size:48px;margin-bottom:16px">‚ö†Ô∏è</div>
          <h3>Error al cargar juegos</h3>
          <p>No se pudo conectar con el servidor. Por favor intenta m√°s tarde.</p>
        `;
      }
    }

    function createGameCard(game, isFree) {
      const article = document.createElement('article');
      article.className = 'card';
      article.style.cursor = 'pointer';

      const thumbnailDiv = document.createElement('div');
      thumbnailDiv.className = 'thumb';
      
      if (game.imagen_portada) {
        thumbnailDiv.style.backgroundImage = `url(${game.imagen_portada})`;
        thumbnailDiv.style.backgroundSize = 'cover';
        thumbnailDiv.style.backgroundPosition = 'center';
      } else {
        thumbnailDiv.textContent = game.titulo.substring(0, 2).toUpperCase();
      }

      const title = document.createElement('h3');
      title.textContent = game.titulo;

      const description = document.createElement('p');
      description.textContent = `${game.genero} ¬∑ ${game.desarrollador_nombre || 'Indie'}`;

      article.appendChild(thumbnailDiv);
      article.appendChild(title);
      article.appendChild(description);

      if (isFree) {
        const freeTag = document.createElement('div');
        freeTag.style.cssText = 'margin-top:8px;padding:8px;background:rgba(76,175,80,0.1);border-radius:6px';
        freeTag.innerHTML = '<small style="color:#4CAF50;font-weight:600">‚ú® GRATIS</small>';
        article.appendChild(freeTag);

        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn';
        downloadBtn.style.cssText = 'width:100%;margin-top:12px;background:linear-gradient(90deg,#4CAF50,#45a049);color:#fff;font-weight:600';
        downloadBtn.textContent = '‚¨áÔ∏è Obtener gratis';
        downloadBtn.onclick = () => handleFreeGame(game.id);
        article.appendChild(downloadBtn);
      } else {
        const priceRow = document.createElement('div');
        priceRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-top:12px';
        
        const priceSpan = document.createElement('span');
        priceSpan.style.cssText = 'font-size:18px;font-weight:700;color:var(--accent-1)';
        priceSpan.textContent = `$${parseFloat(game.precio).toFixed(2)}`;
        
        const addBtn = document.createElement('button');
        addBtn.className = 'btn';
        addBtn.style.cssText = 'background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;padding:8px 16px';
        addBtn.textContent = 'Agregar';
        addBtn.onclick = (e) => {
          e.stopPropagation();
          handleAddToCart(game);
        };
        
        priceRow.appendChild(priceSpan);
        priceRow.appendChild(addBtn);
        article.appendChild(priceRow);
      }

      article.onclick = () => {
        window.location.href = `producto-detalle.html?id=${game.id}`;
      };

      return article;
    }

    async function handleFreeGame(gameId) {
      if (!isAuthenticated()) {
        alert('Debes iniciar sesi√≥n para obtener juegos gratis');
        window.location.href = 'inicio.html';
        return;
      }

      try {
        const response = await apiGetJuegoGratis(gameId);
        if (response.success) {
          alert('‚úÖ ¬°Juego agregado a tu biblioteca! Ya puedes descargarlo.');
          window.location.href = 'biblioteca.html';
        } else {
          alert('‚ùå ' + (response.message || 'Error al obtener el juego'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al procesar la solicitud');
      }
    }

    function handleAddToCart(game) {
      if (!isAuthenticated()) {
        alert('Debes iniciar sesi√≥n para agregar juegos al carrito');
        window.location.href = 'inicio.html';
        return;
      }

      if (typeof window.addToCart === 'function') {
        window.addToCart(game.id, game.titulo, game.precio, game.imagen_portada);
      }
    }

    // ============================================
    // VERIFICAR AUTENTICACI√ìN
    // ============================================
    
    function checkAuth() {
      const user = getCurrentUser();
      const loginBtn = document.getElementById('loginBtn');
      const registerBtn = document.getElementById('registerBtn');
      const userProfile = document.getElementById('userProfile');
      const publicarBtn = document.getElementById('publicarBtn');
      const publicarBtnHero = document.getElementById('publicarBtnHero');

      if (user && isAuthenticated()) {
        loginBtn.style.display = 'none';
        if (registerBtn) registerBtn.style.display = 'none';
        userProfile.style.display = 'flex';
        updateUserInterface();

        if (user.tipo_cuenta === 'comprador') {
          if (publicarBtn) publicarBtn.style.display = 'none';
          if (publicarBtnHero) publicarBtnHero.style.display = 'none';
        } else {
          if (publicarBtn) publicarBtn.style.display = 'inline-block';
          if (publicarBtnHero) publicarBtnHero.style.display = 'inline-block';
        }
      } else {
        loginBtn.style.display = 'block';
        if (registerBtn) registerBtn.style.display = 'inline-block';
        userProfile.style.display = 'none';
        if (publicarBtn) publicarBtn.style.display = 'inline-block';
        if (publicarBtnHero) publicarBtnHero.style.display = 'inline-block';
      }
    }

    // Cerrar sesi√≥n
    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('¬øSeguro que deseas cerrar sesi√≥n?')) {
        logout();
      }
    });

    // ============================================
    // GESTI√ìN DE SESI√ìN Y PERFIL DE USUARIO
    // ============================================
    
    // Verificar si hay una sesi√≥n activa al cargar la p√°gina
    function checkUserSession() {
      const user = getCurrentUser();
      const token = getAuthToken();
      
      if (user && token) {
        // Ocultar botones de login/registro
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('registerBtn').style.display = 'none';
        
        // Mostrar perfil de usuario
        const userProfile = document.getElementById('userProfile');
        userProfile.style.display = 'flex';
        
        // Establecer nombre de usuario
        document.getElementById('userName').textContent = user.nombre || 'Usuario';
        
        // Cargar datos del perfil desde localStorage
        loadProfileData(user);
        
        // Configurar bot√≥n de cerrar sesi√≥n
        document.getElementById('logoutBtn').addEventListener('click', function() {
          logout();
        });
        
        // Ajustar visibilidad del bot√≥n publicar seg√∫n tipo de cuenta
        if (user.tipo_cuenta === 'comprador') {
          const publicarBtns = document.querySelectorAll('#publicarBtn, #publicarBtnHero');
          publicarBtns.forEach(btn => {
            btn.style.display = 'none';
          });
        }
      } else {
        // Mostrar botones de login/registro
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('registerBtn').style.display = 'block';
        document.getElementById('userProfile').style.display = 'none';
      }
    }
    
    // Cargar datos del perfil desde localStorage
    function loadProfileData(user) {
      const profileData = JSON.parse(localStorage.getItem('userProfile') || '{}');
      
      // Cargar avatar o iniciales
      const userAvatar = document.getElementById('userAvatar');
      const userInitials = document.getElementById('userInitials');
      const profileAvatarImg = document.getElementById('profileAvatarImg');
      const profileInitials = document.getElementById('profileInitials');
      
      if (profileData.avatar) {
        // Si hay avatar guardado
        userAvatar.innerHTML = `<img src="${profileData.avatar}" alt="Avatar">`;
        profileAvatarImg.src = profileData.avatar;
        profileAvatarImg.style.display = 'block';
        profileInitials.style.display = 'none';
      } else {
        // Mostrar iniciales
        const initials = getInitials(user.nombre);
        userInitials.textContent = initials;
        profileInitials.textContent = initials;
        profileAvatarImg.style.display = 'none';
        profileInitials.style.display = 'block';
      }
      
      // Cargar sobrenombre y descripci√≥n
      if (profileData.nickname) {
        document.getElementById('nickname').value = profileData.nickname;
      }
      if (profileData.description) {
        document.getElementById('description').value = profileData.description;
      }
      
      // Establecer nombre y email en el modal
      document.getElementById('profileName').textContent = user.nombre;
      document.getElementById('profileEmail').textContent = user.email;
    }
    
    // Obtener iniciales del nombre
    function getInitials(name) {
      if (!name) return 'U';
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }
    
    // Abrir modal de perfil
    function openProfileModal() {
      const modal = document.getElementById('profileModal');
      modal.classList.add('active');
    }
    
    // Cerrar modal de perfil
    function closeProfileModal() {
      const modal = document.getElementById('profileModal');
      modal.classList.remove('active');
    }
    
    // Manejar cambio de avatar
    function handleAvatarChange(event) {
      const file = event.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const base64Image = e.target.result;
          
          // Actualizar avatar en el modal
          const profileAvatarImg = document.getElementById('profileAvatarImg');
          profileAvatarImg.src = base64Image;
          profileAvatarImg.style.display = 'block';
          document.getElementById('profileInitials').style.display = 'none';
          
          // Guardar temporalmente para cuando se guarde el formulario
          profileAvatarImg.dataset.tempAvatar = base64Image;
        };
        reader.readAsDataURL(file);
      }
    }
    
    // Guardar cambios del perfil
    document.getElementById('profileForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const profileData = JSON.parse(localStorage.getItem('userProfile') || '{}');
      
      // Guardar sobrenombre y descripci√≥n
      profileData.nickname = document.getElementById('nickname').value;
      profileData.description = document.getElementById('description').value;
      
      // Guardar avatar si hay uno nuevo
      const profileAvatarImg = document.getElementById('profileAvatarImg');
      if (profileAvatarImg.dataset.tempAvatar) {
        profileData.avatar = profileAvatarImg.dataset.tempAvatar;
        delete profileAvatarImg.dataset.tempAvatar;
      } else if (profileAvatarImg.src && profileAvatarImg.style.display !== 'none') {
        profileData.avatar = profileAvatarImg.src;
      }
      
      // Guardar en localStorage
      localStorage.setItem('userProfile', JSON.stringify(profileData));
      
      // Actualizar el avatar en el header
      const userAvatar = document.getElementById('userAvatar');
      if (profileData.avatar) {
        userAvatar.innerHTML = `<img src="${profileData.avatar}" alt="Avatar">`;
      }
      
      // Cerrar modal
      closeProfileModal();
      
      // Mostrar confirmaci√≥n
      showNotification('‚úÖ Perfil actualizado correctamente');
    });
    
    // Funci√≥n para mostrar notificaciones
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--card);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Cerrar modal al hacer clic fuera
    document.getElementById('profileModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeProfileModal();
      }
    });
    
    // A√±adir estilos de animaci√≥n
    const styleSheet = document.createElement('style');
    styleSheet.textContent = `
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(100px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      
      @keyframes slideOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100px);
        }
      }
    `;
    document.head.appendChild(styleSheet);
    
    // Ejecutar verificaci√≥n de sesi√≥n al cargar
    checkUserSession();
    
    // ============================================
    // VALIDAR PUBLICAR JUEGO (Requiere login)
    // ============================================
    function validarPublicarJuego(event) {
      event.preventDefault();
      const user = getCurrentUser();
      
      if (!user || !isAuthenticated()) {
        showNotification('‚ö†Ô∏è Debes iniciar sesi√≥n para publicar un juego');
        setTimeout(() => {
          window.location.href = 'inicio.html';
        }, 1500);
        return;
      }
      
      if (user.tipo_cuenta === 'comprador') {
        showNotification('‚ö†Ô∏è Solo las cuentas de desarrollador pueden publicar juegos');
        return;
      }
      
      // Si todo est√° bien, redirigir a la p√°gina de publicar
      window.location.href = 'publicar-juego.html';
    }

    // ============================================
    // INICIALIZACI√ìN CR√çTICA - DETECTAR SESI√ìN
    // ============================================
    
    // Funci√≥n principal de inicializaci√≥n
    async function initializeApp() {
      console.log('Inicializando aplicaci√≥n...');
      
      // 1. Verificar sesi√≥n activa PRIMERO
      checkUserSession();
      
      // 2. Cargar juegos desde el backend
      await loadGames();
      
      // 3. Actualizar contador del carrito
      actualizarContadorCarrito();
      
      console.log('Aplicaci√≥n inicializada correctamente');
    }
    
    // Ejecutar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      // DOM ya est√° listo, ejecutar inmediatamente
      initializeApp();
    }
    
    // Tambi√©n verificar sesi√≥n cuando la p√°gina obtiene el foco
    window.addEventListener('focus', function() {
      checkUserSession();
    });

  </script>
</body>
</html>