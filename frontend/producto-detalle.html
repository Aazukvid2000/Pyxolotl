<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalles del Juego ‚Äì Pyxolotl</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .product-hero {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin: 40px 0;
      align-items: start;
    }
    .product-gallery {
      position: sticky;
      top: 100px;
    }
    .main-image {
      width: 100%;
      height: 400px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      color: #07102a;
      font-weight: 700;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(123,97,255,0.3);
      overflow: hidden;
    }
    .main-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumbnail-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .thumbnail {
      height: 80px;
      border-radius: 8px;
      background: var(--glass);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      overflow: hidden;
    }
    .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumbnail:hover, .thumbnail.active {
      border-color: var(--accent-1);
      transform: scale(1.05);
    }
    .product-info {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    }
    .price-section {
      background: linear-gradient(135deg, rgba(123,97,255,0.1), rgba(78,163,255,0.1));
      padding: 24px;
      border-radius: 12px;
      margin: 24px 0;
    }
    .current-price {
      font-size: 42px;
      font-weight: 700;
      color: var(--accent-1);
      margin: 8px 0;
    }
    .free-badge {
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      color: #07102a;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 24px;
      display: inline-block;
    }
    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 24px 0;
      flex-wrap: wrap;
    }
    .tab-navigation {
      display: flex;
      gap: 12px;
      border-bottom: 2px solid rgba(255,255,255,0.06);
      margin: 40px 0 24px;
      flex-wrap: wrap;
    }
    .tab-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 12px 24px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--accent-2); }
    .tab-btn.active {
      color: var(--accent-1);
      border-bottom-color: var(--accent-1);
    }
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .tab-content.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .requirements-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin: 20px 0;
    }
    .requirement-box {
      background: var(--glass);
      padding: 20px;
      border-radius: 12px;
    }
    .reviews-summary {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      display: flex;
      gap: 40px;
      align-items: center;
      flex-wrap: wrap;
    }
    .reviews-score { text-align: center; }
    .reviews-score .score {
      font-size: 64px;
      font-weight: 700;
      color: var(--accent-1);
    }
    .reviews-bars { flex: 1; min-width: 250px; }
    .bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0;
    }
    .bar-label { color: var(--muted); width: 30px; }
    .bar-container {
      flex: 1;
      height: 8px;
      background: var(--glass);
      border-radius: 4px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-2), var(--accent-1));
      border-radius: 4px;
    }
    .bar-count { color: var(--muted); width: 40px; text-align: right; }
    .review-card {
      background: var(--glass);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .review-user { display: flex; align-items: center; gap: 12px; }
    .review-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #07102a;
    }
    .rating-stars { color: #ffd700; font-size: 18px; }
    .review-form-container {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      display: none;
    }
    .review-form-container.active { display: block; }
    .star-rating { display: flex; gap: 8px; margin: 16px 0; }
    .star-rating .star {
      font-size: 32px;
      cursor: pointer;
      color: var(--glass);
      transition: all 0.2s;
    }
    .star-rating .star:hover,
    .star-rating .star.active {
      color: #ffd700;
      transform: scale(1.1);
    }
    .review-textarea {
      width: 100%;
      min-height: 120px;
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--glass);
      background: rgba(255,255,255,0.03);
      color: #fff;
      font-family: inherit;
      font-size: 16px;
      resize: vertical;
      transition: border-color 0.2s;
    }
    .review-textarea:focus {
      outline: none;
      border-color: var(--accent-1);
    }
    .review-actions { display: flex; gap: 12px; margin-top: 16px; }
    .no-reviews { text-align: center; padding: 40px; color: var(--muted); }
    .dev-info {
      background: linear-gradient(135deg, rgba(123,97,255,0.15), rgba(78,163,255,0.15));
      padding: 20px;
      border-radius: 12px;
      margin-top: 24px;
    }
    .loading { text-align: center; padding: 60px; color: var(--muted); }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--glass);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 1024px) {
      .product-hero { grid-template-columns: 1fr; gap: 24px; }
      .product-gallery { position: static; }
      .requirements-grid { grid-template-columns: 1fr; }
      .reviews-summary { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body>
  <header class="container header" style="background:rgba(52,73,94,0.85);backdrop-filter:blur(10px);position:sticky;top:0;z-index:999;box-shadow:0 2px 20px rgba(0,0,0,0.3)">
    <div class="brand" onclick="window.location.href='index.html'" style="cursor:pointer">
      <img src="PIXOLOTEL.png" alt="Logo Pyxolotl" class="brand-logo" onerror="this.style.display='none'">
      <div>
        <div class="site-title">Pyxolotl</div>
        <div style="font-size:12px;color:var(--muted)">Marketplace de juegos indie mexicanos</div>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">üè† Inicio</a>
      <a href="index.html#gallery">Juegos</a>
      <a href="biblioteca.html">üìö Biblioteca</a>
      <button id="cartBtn" class="btn btn-ghost" style="position:relative">
        üõí <span id="cartCount" class="cart-badge">0</span>
      </button>
    </nav>
  </header>

  <main class="container">
    <div style="margin: 20px 0">
      <a href="index.html" style="color:var(--muted);text-decoration:none">‚Üê Volver a la tienda</a>
    </div>

    <div id="loadingState" class="loading">
      <div class="loading-spinner"></div>
      <p>Cargando informaci√≥n del juego...</p>
    </div>

    <div id="errorState" style="display:none;text-align:center;padding:60px">
      <h2 style="color:#ff4757">‚ùå Juego no encontrado</h2>
      <p style="color:var(--muted)">El juego que buscas no existe o no est√° disponible.</p>
      <a href="index.html" class="btn" style="margin-top:20px">Volver al cat√°logo</a>
    </div>

    <div id="gameContent" style="display:none">
      <div class="product-hero">
        <div class="product-gallery">
          <div class="main-image" id="mainImage"><span id="mainImageFallback"></span></div>
          <div class="thumbnail-grid" id="thumbnailGrid"></div>
        </div>

        <div>
          <div style="margin-bottom:12px"><span class="kicker" id="gameGenre">Cargando...</span></div>
          <h1 style="margin:0 0 16px;font-size:48px" id="productTitle">Cargando...</h1>
          <p style="font-size:18px;color:var(--muted);line-height:1.6" id="gameDescription">Cargando descripci√≥n...</p>

          <div class="product-info">
            <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
              <div class="rating-stars" id="headerStars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
              <span style="color:var(--muted)" id="headerRating">0.0 (0 rese√±as)</span>
            </div>

            <div class="price-section">
              <div id="priceDisplay"><div class="current-price" id="productPrice">$0.00</div></div>
            </div>

            <div class="action-buttons">
              <button id="addToCartBtn" class="btn" style="flex:1;padding:16px;font-size:18px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">üõí Agregar al carrito</button>
              <button id="getFreeBtn" class="btn" style="flex:1;padding:16px;font-size:18px;background:linear-gradient(135deg,#43e97b,#38f9d7);color:#07102a;display:none">üéÆ Obtener gratis</button>
              <button class="btn btn-ghost" style="padding:16px" title="Agregar a favoritos">‚ù§Ô∏è</button>
            </div>

            <div class="dev-info">
              <p style="margin:0"><strong>üéÆ Desarrollado por:</strong> <span id="devName">-</span></p>
              <p style="margin:8px 0 0;color:var(--muted);font-size:14px"><span id="gameSize"></span></p>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="description">üìù Descripci√≥n</button>
        <button class="tab-btn" data-tab="requirements">üíª Requisitos</button>
        <button class="tab-btn" data-tab="reviews">‚≠ê Rese√±as</button>
      </div>

      <div class="tab-content active" id="description">
        <div style="background:var(--card);padding:32px;border-radius:16px">
          <h2 style="margin-top:0">Acerca del juego</h2>
          <div id="fullDescription" style="color:var(--muted);line-height:1.8"></div>
        </div>
      </div>

      <div class="tab-content" id="requirements">
        <div class="requirements-grid">
          <div class="requirement-box">
            <h3 style="margin-top:0;color:var(--accent-1)">üíª Requisitos M√≠nimos</h3>
            <div id="minRequirements" style="color:var(--muted);line-height:1.8"><p>No especificados</p></div>
          </div>
          <div class="requirement-box">
            <h3 style="margin-top:0;color:var(--accent-2)">üöÄ Requisitos Recomendados</h3>
            <div id="recRequirements" style="color:var(--muted);line-height:1.8"><p>No especificados</p></div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="reviews">
        <div class="reviews-summary">
          <div class="reviews-score">
            <div class="score" id="avgScore">0.0</div>
            <div class="rating-stars" id="avgStars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
            <div style="color:var(--muted);margin-top:8px" id="totalReviews">0 rese√±as</div>
          </div>
          <div class="reviews-bars" id="reviewsBars"></div>
          <div>
            <button id="writeReviewBtn" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">‚úçÔ∏è Escribir rese√±a</button>
          </div>
        </div>

        <div class="review-form-container" id="reviewFormContainer">
          <h3 style="margin-top:0">‚úçÔ∏è Escribe tu rese√±a</h3>
          <p style="color:var(--muted)">Comparte tu experiencia con este juego</p>
          <div>
            <label style="color:var(--muted);display:block;margin-bottom:8px">Tu calificaci√≥n:</label>
            <div class="star-rating" id="starRating">
              <span class="star" data-value="1">‚òÜ</span>
              <span class="star" data-value="2">‚òÜ</span>
              <span class="star" data-value="3">‚òÜ</span>
              <span class="star" data-value="4">‚òÜ</span>
              <span class="star" data-value="5">‚òÜ</span>
            </div>
          </div>
          <div style="margin-top:16px">
            <label style="color:var(--muted);display:block;margin-bottom:8px">Tu rese√±a (m√≠nimo 10 caracteres):</label>
            <textarea id="reviewText" class="review-textarea" placeholder="Cu√©ntanos qu√© te pareci√≥ el juego..."></textarea>
          </div>
          <div class="review-actions">
            <button id="submitReviewBtn" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">üì§ Publicar rese√±a</button>
            <button id="cancelReviewBtn" class="btn btn-ghost">Cancelar</button>
          </div>
        </div>

        <div id="reviewsList">
          <div class="no-reviews">
            <p>üéÆ A√∫n no hay rese√±as para este juego.</p>
            <p>¬°S√© el primero en dejar tu opini√≥n!</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer" style="margin-top:60px">
    <div class="container center" style="flex-direction:column;gap:10px">
      <div style="width:100%;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
        <div>¬© 2025 Pyxolotl ¬∑ Hecho con ‚ô• para desarrolladores indie mexicanos</div>
        <div style="color:var(--muted)">Contacto: contacto@pyxolotl.com</div>
      </div>
    </div>
  </footer>

  <script src="api.js"></script>
  <script src="cart.js"></script>
  <script>
    let currentGame = null;
    let currentRating = 0;
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('id');

    async function initPage() {
      if (!gameId) { showError(); return; }
      try {
        const game = await apiGetJuego(gameId);
        if (game.detail || !game.id) { showError(); return; }
        currentGame = game;
        renderGameDetails(game);
        await loadReviews();
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('gameContent').style.display = 'block';
      } catch (error) {
        console.error('Error al cargar juego:', error);
        showError();
      }
    }

    function showError() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
    }

    function renderGameDetails(game) {
      document.getElementById('productTitle').textContent = game.titulo;
      document.title = `${game.titulo} ‚Äì Pyxolotl`;
      document.getElementById('gameGenre').textContent = `${game.genero} ‚Ä¢ Indie`;
      document.getElementById('gameDescription').textContent = game.descripcion.substring(0, 200) + (game.descripcion.length > 200 ? '...' : '');
      document.getElementById('fullDescription').innerHTML = `<p>${game.descripcion.replace(/\n/g, '</p><p>')}</p>`;
      
      const mainImage = document.getElementById('mainImage');
      if (game.portada_url && !game.portada_url.includes('temp')) {
        const imgUrl = getImageUrl(game.portada_url);
        mainImage.innerHTML = `<img src="${imgUrl}" alt="${game.titulo}" onerror="this.parentElement.innerHTML='<span>${getInitials(game.titulo)}</span>'">`;
      } else {
        document.getElementById('mainImageFallback').textContent = getInitials(game.titulo);
      }
      
      renderScreenshots(game);
      
      if (game.precio === 0) {
        document.getElementById('priceDisplay').innerHTML = '<span class="free-badge">‚ú® GRATIS</span>';
        document.getElementById('addToCartBtn').style.display = 'none';
        document.getElementById('getFreeBtn').style.display = 'block';
      } else {
        document.getElementById('productPrice').textContent = `$${game.precio.toFixed(2)} MXN`;
      }
      
      document.getElementById('headerStars').innerHTML = getStarsHTML(game.calificacion_promedio);
      document.getElementById('headerRating').textContent = `${game.calificacion_promedio.toFixed(1)} (${game.total_resenas} rese√±as)`;
      
      if (game.desarrollador) {
        document.getElementById('devName').textContent = game.desarrollador.nombre;
      }
      if (game.tamano_mb) {
        document.getElementById('gameSize').textContent = `üì¶ Tama√±o: ${game.tamano_mb.toFixed(1)} MB`;
      }
      renderRequirements(game.requisitos);
    }

    function renderScreenshots(game) {
      const grid = document.getElementById('thumbnailGrid');
      grid.innerHTML = '';
      if (game.portada_url) {
        grid.appendChild(createThumbnail(game.portada_url, game.titulo, true));
      }
      if (game.screenshots_urls) {
        try {
          const screenshots = JSON.parse(game.screenshots_urls);
          screenshots.forEach((url, idx) => {
            grid.appendChild(createThumbnail(url, `Screenshot ${idx + 1}`, false));
          });
        } catch (e) { console.error('Error parsing screenshots:', e); }
      }
    }

    function createThumbnail(url, alt, isActive) {
      const div = document.createElement('div');
      div.className = 'thumbnail' + (isActive ? ' active' : '');
      const imgUrl = getImageUrl(url);
      div.innerHTML = `<img src="${imgUrl}" alt="${alt}" onerror="this.parentElement.style.background='linear-gradient(135deg,var(--accent-1),var(--accent-2))'">`;
      div.addEventListener('click', () => {
        document.getElementById('mainImage').innerHTML = `<img src="${imgUrl}" alt="${alt}">`;
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        div.classList.add('active');
      });
      return div;
    }

    function renderRequirements(requisitos) {
      if (!requisitos) return;
      try {
        const reqs = JSON.parse(requisitos);
        if (reqs.minimos) document.getElementById('minRequirements').innerHTML = formatRequirements(reqs.minimos);
        if (reqs.recomendados) document.getElementById('recRequirements').innerHTML = formatRequirements(reqs.recomendados);
      } catch (e) {
        document.getElementById('minRequirements').innerHTML = `<p>${requisitos}</p>`;
      }
    }

    function formatRequirements(reqs) {
      let html = '<ul style="list-style:none;padding:0">';
      if (reqs.os) html += `<li><strong>SO:</strong> ${reqs.os}</li>`;
      if (reqs.cpu) html += `<li><strong>Procesador:</strong> ${reqs.cpu}</li>`;
      if (reqs.ram) html += `<li><strong>Memoria:</strong> ${reqs.ram}</li>`;
      if (reqs.gpu) html += `<li><strong>Gr√°ficos:</strong> ${reqs.gpu}</li>`;
      if (reqs.storage) html += `<li><strong>Almacenamiento:</strong> ${reqs.storage}</li>`;
      return html + '</ul>';
    }

    async function loadReviews() {
      try {
        const reviews = await apiGetResenas(gameId);
        renderReviews(reviews);
      } catch (error) { console.error('Error al cargar rese√±as:', error); }
    }

    function renderReviews(reviews) {
      const container = document.getElementById('reviewsList');
      if (!reviews || reviews.length === 0) {
        container.innerHTML = `<div class="no-reviews"><p>üéÆ A√∫n no hay rese√±as para este juego.</p><p>¬°S√© el primero en dejar tu opini√≥n!</p></div>`;
        renderReviewsSummary([0,0,0,0,0], 0, 0);
        return;
      }
      const totalReviews = reviews.length;
      const avgScore = reviews.reduce((sum, r) => sum + r.calificacion, 0) / totalReviews;
      const distribution = [0, 0, 0, 0, 0];
      reviews.forEach(r => distribution[r.calificacion - 1]++);
      renderReviewsSummary(distribution, avgScore, totalReviews);
      container.innerHTML = reviews.map(review => `
        <div class="review-card">
          <div class="review-header">
            <div class="review-user">
              <div class="review-avatar">${getInitials(review.usuario?.nombre || 'Usuario')}</div>
              <div>
                <strong>${review.usuario?.nombre || 'Usuario'}</strong>
                <div style="color:var(--muted);font-size:13px">${formatDate(review.fecha_creacion)}</div>
              </div>
            </div>
            <div class="rating-stars">${getStarsHTML(review.calificacion)}</div>
          </div>
          <p style="color:var(--muted);line-height:1.6;margin:0">${review.texto}</p>
        </div>
      `).join('');
    }

    function renderReviewsSummary(distribution, avgScore, total) {
      document.getElementById('avgScore').textContent = avgScore.toFixed(1);
      document.getElementById('avgStars').innerHTML = getStarsHTML(avgScore);
      document.getElementById('totalReviews').textContent = `${total} rese√±a${total !== 1 ? 's' : ''}`;
      const barsContainer = document.getElementById('reviewsBars');
      barsContainer.innerHTML = '';
      for (let i = 5; i >= 1; i--) {
        const count = distribution[i - 1] || 0;
        const percentage = total > 0 ? (count / total) * 100 : 0;
        barsContainer.innerHTML += `<div class="bar-row"><span class="bar-label">${i}‚òÖ</span><div class="bar-container"><div class="bar-fill" style="width:${percentage}%"></div></div><span class="bar-count">${count}</span></div>`;
      }
    }

    document.getElementById('writeReviewBtn').addEventListener('click', () => {
      if (!isAuthenticated()) {
        alert('‚ö†Ô∏è Debes iniciar sesi√≥n para escribir una rese√±a');
        window.location.href = 'inicio.html';
        return;
      }
      document.getElementById('reviewFormContainer').classList.add('active');
      document.getElementById('writeReviewBtn').style.display = 'none';
    });

    document.getElementById('cancelReviewBtn').addEventListener('click', () => {
      document.getElementById('reviewFormContainer').classList.remove('active');
      document.getElementById('writeReviewBtn').style.display = 'block';
      resetReviewForm();
    });

    document.querySelectorAll('#starRating .star').forEach(star => {
      star.addEventListener('click', () => {
        currentRating = parseInt(star.dataset.value);
        updateStarDisplay();
      });
      star.addEventListener('mouseenter', () => {
        const value = parseInt(star.dataset.value);
        document.querySelectorAll('#starRating .star').forEach((s, idx) => {
          s.textContent = idx < value ? '‚òÖ' : '‚òÜ';
        });
      });
    });

    document.getElementById('starRating').addEventListener('mouseleave', updateStarDisplay);

    function updateStarDisplay() {
      document.querySelectorAll('#starRating .star').forEach((s, idx) => {
        s.textContent = idx < currentRating ? '‚òÖ' : '‚òÜ';
        s.classList.toggle('active', idx < currentRating);
      });
    }

    document.getElementById('submitReviewBtn').addEventListener('click', async () => {
      const texto = document.getElementById('reviewText').value.trim();
      if (currentRating === 0) { alert('‚ö†Ô∏è Por favor selecciona una calificaci√≥n'); return; }
      if (texto.length < 10) { alert('‚ö†Ô∏è La rese√±a debe tener al menos 10 caracteres'); return; }
      try {
        const result = await apiCrearResena(gameId, currentRating, texto);
        if (result.id) {
          alert('‚úÖ ¬°Rese√±a publicada exitosamente!');
          document.getElementById('reviewFormContainer').classList.remove('active');
          document.getElementById('writeReviewBtn').style.display = 'block';
          resetReviewForm();
          await loadReviews();
        } else {
          alert('‚ùå ' + (result.detail || 'Error al publicar la rese√±a'));
        }
      } catch (error) {
        console.error('Error al crear rese√±a:', error);
        alert('‚ùå Error al publicar la rese√±a');
      }
    });

    function resetReviewForm() {
      currentRating = 0;
      document.getElementById('reviewText').value = '';
      updateStarDisplay();
    }

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    document.getElementById('addToCartBtn').addEventListener('click', () => {
      if (!currentGame) return;
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (cart.find(item => item.id === currentGame.id)) {
        alert('‚ö†Ô∏è Este juego ya est√° en tu carrito');
      } else {
        cart.push({ id: currentGame.id, title: currentGame.titulo, price: currentGame.precio, image: currentGame.portada_url });
        localStorage.setItem('cart', JSON.stringify(cart));
        alert('‚úÖ Juego agregado al carrito');
        updateCartCount();
      }
    });

    document.getElementById('getFreeBtn').addEventListener('click', async () => {
      if (!isAuthenticated()) {
        alert('‚ö†Ô∏è Debes iniciar sesi√≥n para obtener este juego');
        window.location.href = 'inicio.html';
        return;
      }
      try {
        const result = await apiGetJuegoGratis(gameId);
        if (result.success) {
          alert('‚úÖ ' + result.message);
          window.location.href = 'biblioteca.html';
        } else {
          alert('‚ùå ' + (result.detail || result.message));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al obtener el juego');
      }
    });

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      document.getElementById('cartCount').textContent = cart.length;
    }

    function getInitials(title) {
      if (!title) return '?';
      const words = title.split(' ');
      return words.length >= 2 ? (words[0][0] + words[1][0]).toUpperCase() : title.substring(0, 2).toUpperCase();
    }

    function getStarsHTML(rating) {
      let stars = '';
      for (let i = 0; i < 5; i++) stars += i < Math.round(rating) ? '‚òÖ' : '‚òÜ';
      return stars;
    }

    function getImageUrl(url) {
      if (!url) return '';
      if (url.startsWith('http')) return url;
      const backendUrl = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://pyxolotl-production.up.railway.app';
      return `${backendUrl}${url}`;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) return 'Hoy';
      if (diffDays === 1) return 'Ayer';
      if (diffDays < 7) return `Hace ${diffDays} d√≠as`;
      if (diffDays < 30) return `Hace ${Math.floor(diffDays / 7)} semana${Math.floor(diffDays / 7) > 1 ? 's' : ''}`;
      return date.toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    updateCartCount();
    initPage();
  </script>
</body>
</html>
