<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalles del Juego ‚Äì Pyxolotl</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos espec√≠ficos para la p√°gina de detalles */
    .product-hero {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 40px;
      margin: 40px 0;
      align-items: start;
    }
    
    .product-gallery { position: sticky; top: 100px; }
    
    .main-image {
      width: 100%; height: 400px; border-radius: 16px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; box-shadow: 0 10px 40px rgba(123,97,255,0.2);
      margin-bottom: 20px;
    }
    .main-image img, .main-image iframe, .main-image video { width: 100%; height: 100%; object-fit: cover; border: none; }
    
    .thumbnail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .thumbnail {
      height: 80px; border-radius: 8px; background: var(--glass);
      cursor: pointer; transition: all 0.2s; border: 2px solid transparent; overflow: hidden;
    }
    .thumbnail:hover, .thumbnail.active { border-color: var(--accent-1); }
    .thumbnail img { width: 100%; height: 100%; object-fit: cover; }

    .product-info { background: var(--card); padding: 32px; border-radius: 16px; }
    
    .stats-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
      margin: 24px 0; padding: 20px; background: var(--glass); border-radius: 12px;
    }
    .stat-item small { display: block; color: var(--muted); font-size: 12px; }
    .stat-item strong { display: block; font-size: 18px; color: #fff; }

    /* Sistema de Rese√±as */
    .reviews-summary {
      background: var(--card); padding: 32px; border-radius: 16px;
      margin-bottom: 24px; display: flex; gap: 40px; align-items: center; flex-wrap: wrap;
    }
    .rating-big { font-size: 64px; font-weight: 700; color: var(--accent-1); line-height: 1; }
    .bars-container { flex: 1; min-width: 200px; }
    .bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
    .bar-bg { flex: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
    .bar-fill { height: 100%; background: var(--accent-1); }
    
    /* Formulario Rese√±a */
    .review-form { background: var(--glass); padding: 24px; border-radius: 12px; margin-bottom: 32px; display: none; }
    .review-form.active { display: block; }
    .star-input { font-size: 32px; cursor: pointer; color: #444; transition: color 0.2s; background: none; border: none; }
    .star-input:hover, .star-input.active { color: #ffd700; }
    
    .review-card { background: var(--glass); padding: 20px; border-radius: 12px; margin-bottom: 16px; }

    @media (max-width: 900px) {
      .product-hero { grid-template-columns: 1fr; }
      .product-gallery { position: static; }
    }
  </style>
</head>
<body>
  <header class="container header" style="background:rgba(52,73,94,0.95); position:sticky; top:0; z-index:999;">
    <div class="brand" onclick="window.location.href='index.html'" style="cursor:pointer">
      <img src="PIXOLOTEL.png" alt="Pyxolotl" class="brand-logo" onerror="this.style.display='none'">
      <div>
        <div class="site-title">Pyxolotl</div>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">üè† Inicio</a>
      <a href="biblioteca.html">üìö Biblioteca</a>
      <a href="cart.html">üõí Carrito <span id="cartCount" style="background:var(--accent-1); padding:2px 6px; border-radius:10px; font-size:12px;">0</span></a>
    </nav>
  </header>

  <main class="container">
    <div style="margin: 20px 0">
      <a href="index.html" style="color:var(--accent-1); text-decoration:none">‚Üê Volver al cat√°logo</a>
    </div>

    <div id="loadingState" style="text-align:center; padding: 100px;">
      <div style="font-size: 40px; animation: spin 1s infinite linear;">‚Üª</div>
      <p>Cargando juego...</p>
    </div>

    <div id="errorState" style="display:none; text-align:center; padding: 100px;">
      <h2 style="color: #ff4757">‚ö†Ô∏è Juego no encontrado</h2>
      <p>El juego que buscas no existe o ha sido eliminado.</p>
    </div>

    <div id="gameContent" style="display:none">
      <div class="product-hero">
        <div class="product-gallery">
          <div class="main-image" id="mainImageContainer">
            </div>
          <div class="thumbnail-grid" id="thumbnailGrid">
            </div>
        </div>

        <div class="product-info">
          <span class="genre-badge" id="genreBadge" style="background:var(--accent-1); color:#000; padding:4px 12px; border-radius:20px; font-weight:bold; font-size:12px;">Indie</span>
          
          <h1 id="gameTitle" style="font-size: 42px; margin: 10px 0;">Titulo</h1>
          <p id="devName" style="color: var(--muted);">Por: Desarrollador</p>
          
          <div class="price-section" style="margin: 24px 0; font-size: 36px; font-weight: 700; color: var(--accent-1);">
            <span id="priceDisplay">$0.00</span>
          </div>

          <div style="display:flex; gap:12px; margin-bottom: 24px;">
            <button id="addToCartBtn" class="btn" style="flex:1; background:linear-gradient(90deg,var(--accent-2),var(--accent-1)); color:#000; font-weight:bold;">
              üõí Agregar al carrito
            </button>
            <button id="downloadFreeBtn" class="btn" style="flex:1; display:none; background:#2ecc71; color:#fff;">
              ‚¨áÔ∏è Obtener Gratis
            </button>
          </div>

          <div class="stats-grid">
            <div class="stat-item">
              <small>üì¶ Tama√±o</small>
              <strong id="statSize">0 MB</strong>
            </div>
            <div class="stat-item">
              <small>‚¨áÔ∏è Descargas</small>
              <strong id="statDownloads">0</strong>
            </div>
            <div class="stat-item">
              <small>‚≠ê Calificaci√≥n</small>
              <strong id="statRating">0.0</strong>
            </div>
            <div class="stat-item">
              <small>üìÖ Publicado</small>
              <strong id="statDate">-</strong>
            </div>
          </div>

          <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:12px;">
            <h3 style="margin-top:0;">Descripci√≥n</h3>
            <p id="gameDesc" style="line-height:1.6; color:var(--muted);">...</p>
          </div>
        </div>
      </div>

      <div style="border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px;">
        <button class="btn btn-ghost" onclick="showTab('reqs')" style="color:var(--accent-1)">Requisitos del Sistema</button>
        <button class="btn btn-ghost" onclick="showTab('reviews')">Rese√±as y Opiniones</button>
      </div>

      <div id="tab-reqs">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
          <div style="background:var(--glass); padding:20px; border-radius:12px;">
            <h4 style="color:var(--accent-1)">M√≠nimos</h4>
            <div id="reqsMin">No especificados</div>
          </div>
          <div style="background:var(--glass); padding:20px; border-radius:12px;">
            <h4 style="color:var(--accent-2)">Recomendados</h4>
            <div id="reqsRec">No especificados</div>
          </div>
        </div>
      </div>

      <div id="tab-reviews" style="margin-top:40px;">
        <div class="reviews-summary">
          <div style="text-align:center;">
            <div class="rating-big" id="avgRatingBig">0.0</div>
            <div style="color:#ffd700; font-size:24px;" id="avgStars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
            <div style="color:var(--muted); margin-top:8px;"><span id="totalReviewsCount">0</span> rese√±as</div>
          </div>
          
          <div class="bars-container" id="ratingBars">
            </div>
          
          <div>
            <button id="btnWriteReview" class="btn" style="background:var(--glass); border:1px solid var(--accent-1);">‚úçÔ∏è Escribir rese√±a</button>
          </div>
        </div>

        <div id="reviewForm" class="review-form">
          <h3 style="margin-top:0;">Tu opini√≥n sobre el juego</h3>
          
          <div style="margin-bottom:16px;">
            <label>Calificaci√≥n:</label>
            <div id="starRatingInput">
              <button type="button" class="star-input" data-val="1">‚òÖ</button>
              <button type="button" class="star-input" data-val="2">‚òÖ</button>
              <button type="button" class="star-input" data-val="3">‚òÖ</button>
              <button type="button" class="star-input" data-val="4">‚òÖ</button>
              <button type="button" class="star-input" data-val="5">‚òÖ</button>
            </div>
          </div>
          
          <div style="margin-bottom:16px;">
            <textarea id="reviewText" style="width:100%; height:100px; padding:12px; background:rgba(0,0,0,0.3); border:1px solid #444; color:#fff; border-radius:8px;" placeholder="Cu√©ntanos qu√© te pareci√≥ (m√≠nimo 10 caracteres)..."></textarea>
            <div style="text-align:right; font-size:12px; color:var(--muted);"><span id="charCount">0</span>/500</div>
          </div>
          
          <div style="display:flex; gap:10px;">
            <button id="submitReviewBtn" class="btn" style="background:var(--accent-1); color:#000;">Publicar</button>
            <button onclick="document.getElementById('reviewForm').classList.remove('active')" class="btn btn-ghost">Cancelar</button>
          </div>
        </div>

        <div id="reviewsList">
          </div>
      </div>
    </div>
  </main>

  <script src="api.js"></script>
  <script>
    // Variables Globales
    let currentGameId = null;
    let currentRating = 0;
    
    // Obtener ID de la URL
    const params = new URLSearchParams(window.location.search);
    currentGameId = params.get('id');
    
    console.log("üìç ID recuperado de URL:", currentGameId); // DEBUGGING

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      if(!currentGameId) {
        showError();
      } else {
        loadGameData();
      }
      
      // Update cart count visual
      const cart = JSON.parse(localStorage.getItem('pyxolotl_cart') || '[]');
      document.getElementById('cartCount').textContent = cart.length;
    });

    async function loadGameData() {
      try {
        // 1. Cargar datos del juego
        const game = await apiGetJuego(currentGameId);
        renderGameDetails(game);
        
        // 2. Cargar rese√±as
        await loadReviews();
        
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('gameContent').style.display = 'block';
        
      } catch (error) {
        console.error("Error cargando juego:", error);
        showError();
      }
    }

    function showError() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
    }

    // Renderizar Detalles del Juego
    function renderGameDetails(game) {
      document.title = `${game.titulo} - Pyxolotl`;
      
      // Textos B√°sicos
      document.getElementById('gameTitle').textContent = game.titulo;
      document.getElementById('genreBadge').textContent = game.genero;
      document.getElementById('devName').textContent = `Desarrollador: ${game.desarrollador?.nombre || 'Indie'}`;
      document.getElementById('gameDesc').textContent = game.descripcion;
      
      // Estad√≠sticas Reales
      document.getElementById('statSize').textContent = game.tamano_mb ? `${game.tamano_mb.toFixed(1)} MB` : 'N/A';
      document.getElementById('statDownloads').textContent = game.total_descargas || 0;
      document.getElementById('statRating').textContent = game.calificacion_promedio ? game.calificacion_promedio.toFixed(1) : '0.0';
      document.getElementById('statDate').textContent = new Date(game.fecha_creacion).toLocaleDateString();

      // Precio / Botones
      const priceDisplay = document.getElementById('priceDisplay');
      const cartBtn = document.getElementById('addToCartBtn');
      const freeBtn = document.getElementById('downloadFreeBtn');

      if (game.precio === 0) {
        priceDisplay.textContent = "¬°GRATIS!";
        priceDisplay.style.color = "#2ecc71";
        cartBtn.style.display = 'none';
        freeBtn.style.display = 'block';
        freeBtn.onclick = () => handleFreeDownload(game.id);
      } else {
        priceDisplay.textContent = `$${game.precio.toFixed(2)} MXN`;
        cartBtn.onclick = () => addToCart(game);
      }

      // Galer√≠a y Trailer
      setupGallery(game);

      // Requisitos
      if (game.requisitos) {
        try {
          const reqs = JSON.parse(game.requisitos);
          document.getElementById('reqsMin').innerHTML = formatReqs(reqs.minimos);
          document.getElementById('reqsRec').innerHTML = formatReqs(reqs.recomendados);
        } catch(e) {
          document.getElementById('reqsMin').textContent = "Ver descripci√≥n.";
        }
      }
    }

    function setupGallery(game) {
      const mainContainer = document.getElementById('mainImageContainer');
      const thumbGrid = document.getElementById('thumbnailGrid');
      
      // Funci√≥n para setear la vista principal
      const setMain = (content, isVideo = false) => {
        mainContainer.innerHTML = '';
        if (isVideo) {
           mainContainer.innerHTML = content;
        } else {
           mainContainer.innerHTML = `<img src="${content}" alt="Main">`;
        }
      };

      // 1. Portada (Thumbnail 1)
      if (game.portada_url) {
        const thumb = createThumb(game.portada_url);
        thumb.onclick = () => setMain(game.portada_url);
        thumbGrid.appendChild(thumb);
        setMain(game.portada_url); // Default
      }

      // 2. Trailer (Si existe)
      if (game.trailer_url) {
        const videoHtml = getEmbedVideo(game.trailer_url);
        const thumbVideo = document.createElement('div');
        thumbVideo.className = 'thumbnail';
        thumbVideo.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:24px;">üé¨</div>';
        thumbVideo.onclick = () => setMain(videoHtml, true);
        thumbGrid.appendChild(thumbVideo);
      }

      // 3. Screenshots
      if (game.screenshots_urls) {
        try {
          const screens = JSON.parse(game.screenshots_urls);
          screens.forEach(url => {
            const t = createThumb(url);
            t.onclick = () => setMain(url);
            thumbGrid.appendChild(t);
          });
        } catch(e) {}
      }
    }

    function createThumb(url) {
      const div = document.createElement('div');
      div.className = 'thumbnail';
      div.innerHTML = `<img src="${url}">`;
      return div;
    }

    function getEmbedVideo(url) {
      // Detectar YouTube
      const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/);
      if (ytMatch) {
        return `<iframe src="https://www.youtube.com/embed/${ytMatch[1]}?autoplay=1" allowfullscreen style="width:100%;height:100%;border:0;"></iframe>`;
      }
      // Video directo
      return `<video controls autoplay src="${url}" style="width:100%;height:100%"></video>`;
    }

    function formatReqs(obj) {
      if (!obj) return 'No especificado';
      return `
        <ul style="list-style:none; padding:0; margin:0; font-size:14px; color:var(--muted);">
          <li><strong>SO:</strong> ${obj.os || '-'}</li>
          <li><strong>CPU:</strong> ${obj.cpu || '-'}</li>
          <li><strong>RAM:</strong> ${obj.ram || '-'}</li>
          <li><strong>GPU:</strong> ${obj.gpu || '-'}</li>
          <li><strong>Espacio:</strong> ${obj.storage || '-'}</li>
        </ul>
      `;
    }

    // ==========================================
    // SISTEMA DE RESE√ëAS
    // ==========================================

    async function loadReviews() {
      const reviews = await apiGetResenas(currentGameId);
      
      // Calcular Stats
      const total = reviews.length;
      const sum = reviews.reduce((a, b) => a + b.calificacion, 0);
      const avg = total ? (sum / total) : 0;
      
      // Actualizar UI Header Rese√±as
      document.getElementById('avgRatingBig').textContent = avg.toFixed(1);
      document.getElementById('avgStars').textContent = '‚òÖ'.repeat(Math.round(avg)) + '‚òÜ'.repeat(5 - Math.round(avg));
      document.getElementById('totalReviewsCount').textContent = total;
      
      // Barras de distribuci√≥n
      const counts = {1:0, 2:0, 3:0, 4:0, 5:0};
      reviews.forEach(r => counts[r.calificacion]++);
      
      const barsHtml = [5,4,3,2,1].map(star => {
        const p = total ? (counts[star] / total * 100) : 0;
        return `
          <div class="bar-row">
            <span style="width:20px">${star}‚òÖ</span>
            <div class="bar-bg"><div class="bar-fill" style="width:${p}%"></div></div>
            <span style="width:30px; text-align:right">${counts[star]}</span>
          </div>
        `;
      }).join('');
      document.getElementById('ratingBars').innerHTML = barsHtml;
      
      // Listado
      const list = document.getElementById('reviewsList');
      if (total === 0) {
        list.innerHTML = '<p style="text-align:center; color:var(--muted); padding:20px;">No hay rese√±as a√∫n. ¬°S√© el primero!</p>';
      } else {
        list.innerHTML = reviews.map(r => `
          <div class="review-card">
            <div style="display:flex; justify-content:space-between;">
              <strong>${r.usuario?.nombre || 'Usuario'}</strong>
              <span style="color:#ffd700">${'‚òÖ'.repeat(r.calificacion)}</span>
            </div>
            <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">${new Date(r.fecha_creacion).toLocaleDateString()}</div>
            <p style="margin:0; line-height:1.5;">${r.texto}</p>
          </div>
        `).join('');
      }
    }

    // L√≥gica Formulario Rese√±a
    const btnWrite = document.getElementById('btnWriteReview');
    const form = document.getElementById('reviewForm');
    
    btnWrite.onclick = () => {
      if (!isAuthenticated()) {
        alert("Debes iniciar sesi√≥n para escribir una rese√±a");
        window.location.href = 'inicio.html';
        return;
      }
      form.classList.add('active');
      btnWrite.style.display = 'none';
    };

    // Estrellas input
    document.querySelectorAll('.star-input').forEach(btn => {
      btn.onclick = () => {
        currentRating = parseInt(btn.dataset.val);
        updateStarInputVisuals();
      };
    });

    function updateStarInputVisuals() {
      document.querySelectorAll('.star-input').forEach(btn => {
        const val = parseInt(btn.dataset.val);
        if (val <= currentRating) btn.classList.add('active');
        else btn.classList.remove('active');
      });
    }

    // Contador Caracteres
    document.getElementById('reviewText').addEventListener('input', function() {
      document.getElementById('charCount').textContent = this.value.length;
    });

    // Enviar Rese√±a
    document.getElementById('submitReviewBtn').onclick = async () => {
      const text = document.getElementById('reviewText').value;
      
      if (currentRating === 0) return alert("Selecciona una calificaci√≥n");
      if (text.length < 10) return alert("La rese√±a es muy corta (m√≠nimo 10 caracteres)");
      
      try {
        await apiCrearResena(currentGameId, currentRating, text);
        alert("¬°Rese√±a publicada!");
        
        // Reset
        form.classList.remove('active');
        btnWrite.style.display = 'block';
        document.getElementById('reviewText').value = '';
        currentRating = 0;
        updateStarInputVisuals();
        
        // Recargar
        await loadReviews();
        
      } catch(e) {
        alert("Error: " + e.message);
      }
    };

    // ==========================================
    // CARRITO Y DESCARGAS
    // ==========================================

    function addToCart(game) {
      if (!isAuthenticated()) return window.location.href = 'inicio.html';
      
      let cart = JSON.parse(localStorage.getItem('pyxolotl_cart') || '[]');
      if (cart.find(i => i.id === game.id)) return alert("Ya est√° en el carrito");
      
      cart.push({
        id: game.id,
        titulo: game.titulo,
        precio: game.precio,
        imagen: game.portada_url
      });
      
      localStorage.setItem('pyxolotl_cart', JSON.stringify(cart));
      document.getElementById('cartCount').textContent = cart.length;
      alert("Agregado al carrito");
    }

    async function handleFreeDownload(id) {
      if (!isAuthenticated()) return window.location.href = 'inicio.html';
      try {
        const res = await apiGetJuegoGratis(id);
        alert(res.message);
        window.location.href = 'biblioteca.html';
      } catch(e) {
        alert("Error al obtener juego");
      }
    }

    function showTab(id) {
      // Simplificado, podr√≠as a√±adir clases 'active'
      document.getElementById('tab-reqs').style.display = id === 'reqs' ? 'block' : 'none';
      document.getElementById('tab-reviews').style.display = id === 'reviews' ? 'block' : 'none';
    }
  </script>
</body>
</html><!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalles del Juego ‚Äì Pyxolotl</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Header fix */
    .header {
      background: rgba(52,73,94,0.85);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 999;
      box-shadow: 0 2px 20px rgba(0,0,0,0.3);
    }
    
    .product-hero {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin: 40px 0;
      align-items: start;
    }
    
    .product-gallery {
      position: sticky;
      top: 100px;
    }
    
    .main-image {
      width: 100%;
      height: 400px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      color: #07102a;
      font-weight: 700;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(123,97,255,0.3);
      overflow: hidden;
    }
    
    .main-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .thumbnail-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    
    .thumbnail {
      height: 80px;
      border-radius: 8px;
      background: var(--glass);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      overflow: hidden;
    }
    
    .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .thumbnail:hover,
    .thumbnail.active {
      border-color: var(--accent-1);
      transform: scale(1.05);
    }
    
    .product-info {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    }
    
    .genre-badge {
      display: inline-block;
      padding: 6px 12px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #07102a;
      font-size: 12px;
      font-weight: 600;
      border-radius: 20px;
      margin-bottom: 16px;
    }
    
    .product-title {
      font-size: 36px;
      font-weight: 700;
      margin: 0 0 16px;
    }
    
    .product-subtitle {
      color: var(--muted);
      margin-bottom: 24px;
      line-height: 1.6;
    }
    
    .price-section {
      background: linear-gradient(135deg, rgba(123,97,255,0.1), rgba(78,163,255,0.1));
      padding: 24px;
      border-radius: 12px;
      margin: 24px 0;
    }
    
    .original-price {
      text-decoration: line-through;
      color: var(--muted);
      font-size: 18px;
    }
    
    .current-price {
      font-size: 42px;
      font-weight: 700;
      color: var(--accent-1);
      margin: 8px 0;
    }
    
    .discount-badge {
      background: linear-gradient(135deg, #ff4757, #ff6348);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      display: inline-block;
      margin-left: 12px;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 24px 0;
    }
    
    .stats-list {
      list-style: none;
      margin: 20px 0;
      padding: 0;
    }
    
    .stats-list li {
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stats-list li:last-child {
      border-bottom: none;
    }
    
    .developer-info {
      background: var(--glass);
      padding: 16px;
      border-radius: 8px;
      margin-top: 24px;
    }
    
    .tabs {
      display: flex;
      gap: 24px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      margin: 40px 0 32px;
    }
    
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      color: var(--muted);
      font-weight: 500;
      transition: all 0.2s;
      position: relative;
    }
    
    .tab:hover {
      color: #fff;
    }
    
    .tab.active {
      color: var(--accent-1);
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent-1);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .requirements-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin: 24px 0;
    }
    
    .requirement-box {
      background: var(--glass);
      padding: 24px;
      border-radius: 12px;
    }
    
    .requirement-box h4 {
      color: var(--accent-1);
      margin: 0 0 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .requirement-box ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    
    .requirement-box li {
      padding: 8px 0;
      color: var(--muted);
    }
    
    .requirement-box strong {
      color: #fff;
      font-weight: 500;
    }
    
    /* Review System Styles */
    .reviews-section {
      margin-top: 32px;
    }
    
    .review-summary {
      background: var(--glass);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      gap: 32px;
      align-items: center;
    }
    
    .rating-number {
      font-size: 48px;
      font-weight: 700;
      color: var(--accent-1);
    }
    
    .rating-bars {
      flex: 1;
    }
    
    .rating-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 4px 0;
    }
    
    .rating-bar-fill {
      flex: 1;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .rating-bar-fill div {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      border-radius: 4px;
    }
    
    /* Add Review Form */
    .add-review-box {
      background: var(--glass);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .add-review-box h4 {
      margin: 0 0 16px;
      color: var(--accent-1);
    }
    
    .star-rating {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .star-rating button {
      background: none;
      border: none;
      font-size: 32px;
      cursor: pointer;
      color: #444;
      transition: color 0.2s;
    }
    
    .star-rating button:hover,
    .star-rating button.active {
      color: #ffd700;
    }
    
    .review-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-family: inherit;
      resize: vertical;
      margin-bottom: 16px;
    }
    
    .review-textarea:focus {
      outline: none;
      border-color: var(--accent-1);
    }
    
    .review-card {
      background: var(--glass);
      padding: 20px;
      border-radius: 12px;
      margin: 16px 0;
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .review-author {
      font-weight: 600;
    }
    
    .review-date {
      font-size: 14px;
      color: var(--muted);
    }
    
    .review-stars {
      color: #ffd700;
    }
    
    .similar-games {
      margin: 48px 0;
    }
    
    .games-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-top: 24px;
    }
    
    .game-card {
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .game-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(123,97,255,0.3);
    }
    
    .game-card .thumb {
      height: 150px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: 700;
      color: #07102a;
      overflow: hidden;
    }
    
    .game-card .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .game-card-info {
      padding: 16px;
    }
    
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--glass);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .error-message {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    
    .error-message h2 {
      color: var(--accent-1);
      margin-bottom: 16px;
    }
    
    @media (max-width: 768px) {
      .product-hero {
        grid-template-columns: 1fr;
      }
      .product-gallery {
        position: relative;
        top: 0;
      }
      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .requirements-grid {
        grid-template-columns: 1fr;
      }
      .games-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="container header">
    <div class="brand" onclick="window.location.href='index.html'" style="cursor:pointer">
      <img src="PIXOLOTEL.png" alt="Logo" class="brand-logo" onerror="this.style.display='none'">
      <div>
        <div class="site-title">Pyxolotl</div>
        <div style="font-size:12px;color:var(--muted)">Marketplace de juegos indie mexicanos</div>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">üè† Inicio</a>
      <a href="index.html#gallery">Juegos</a>
      <a href="#" id="userProfileBtn" style="display:none">üë§ Perfil</a>
      <a href="cart.html" style="position:relative">
        üõí <span id="cartCount" style="position:absolute;top:-8px;right:-8px;background:var(--accent-1);color:#fff;border-radius:50%;padding:2px 6px;font-size:12px;display:none">0</span>
      </a>
    </nav>
  </header>

  <!-- Volver a la tienda -->
  <div class="container" style="margin:20px auto">
    <a href="index.html" style="color:var(--accent-1);text-decoration:none;display:inline-flex;align-items:center;gap:8px">
      ‚Üê Volver a la tienda
    </a>
  </div>

  <!-- Loading spinner -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
  </div>

  <!-- Error message (hidden by default) -->
  <div id="errorMessage" class="container error-message" style="display:none">
    <div style="font-size:64px;margin-bottom:16px">‚ö†Ô∏è</div>
    <h2>Juego no encontrado</h2>
    <p>El juego que buscas no existe o ha sido eliminado.</p>
    <a href="index.html" class="btn" style="margin-top:20px;display:inline-block">Volver al inicio</a>
  </div>

  <!-- Main content (hidden until loaded) -->
  <div id="mainContent" class="container" style="display:none">
    <!-- Product Hero Section -->
    <div class="product-hero">
      <!-- Gallery -->
      <div class="product-gallery">
        <div class="main-image" id="mainImage">
          <span id="mainImageInitial">?</span>
        </div>
        <div class="thumbnail-grid" id="thumbnailGrid">
          <!-- Screenshots will be added here dynamically -->
        </div>
      </div>

      <!-- Product Info -->
      <div class="product-info">
        <span class="genre-badge" id="genreBadge">Cargando...</span>
        <h1 class="product-title" id="productTitle">Cargando...</h1>
        <p class="product-subtitle" id="productSubtitle">
          Cargando descripci√≥n...
        </p>

        <!-- Price Section -->
        <div class="price-section">
          <div id="priceDisplay">
            <!-- Price will be inserted here -->
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="btn" id="addToCartBtn" style="flex:1;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;font-weight:600">
            Agregar al carrito
          </button>
          <button class="btn" id="wishlistBtn" style="background:var(--glass)">
            ‚ù§Ô∏è Lista de deseados
          </button>
        </div>

        <!-- Game Stats -->
        <h3 style="margin:24px 0 16px">üìä Estad√≠sticas del juego</h3>
        <ul class="stats-list">
          <li>
            <span>‚≠ê Calificaci√≥n promedio</span>
            <strong id="gameRating">0.0</strong>
          </li>
          <li>
            <span>üí¨ Total de rese√±as</span>
            <strong id="totalReviews">0</strong>
          </li>
          <li>
            <span>‚¨áÔ∏è Descargas totales</span>
            <strong id="totalDownloads">0</strong>
          </li>
          <li>
            <span>üí∞ Ventas totales</span>
            <strong id="totalSales">0</strong>
          </li>
          <li>
            <span>üíæ Tama√±o del archivo</span>
            <strong id="fileSize">0 MB</strong>
          </li>
        </ul>

        <!-- Developer Info -->
        <div class="developer-info">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <small style="color:var(--muted)">üéÆ Desarrollado por:</small>
              <div style="font-weight:600" id="developerName">Cargando...</div>
            </div>
            <div style="text-align:right">
              <small style="color:var(--muted)">üìÖ Fecha de publicaci√≥n:</small>
              <div id="releaseDate">Cargando...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs Section -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('description')">
        üìù Descripci√≥n
      </div>
      <div class="tab" onclick="switchTab('requirements')">
        üíª Requisitos
      </div>
      <div class="tab" onclick="switchTab('reviews')">
        ‚≠ê Rese√±as (<span id="reviewCount">0</span>)
      </div>
    </div>

    <!-- Tab Contents -->
    <div id="descriptionTab" class="tab-content active">
      <h2>Acerca de este juego</h2>
      <div id="fullDescription" style="white-space: pre-wrap; line-height: 1.6;">
        <!-- Full description will be inserted here -->
      </div>

      <!-- Trailer if exists -->
      <div id="trailerSection" style="margin-top:32px;display:none;">
        <h3 style="color:var(--accent-1);margin-bottom:16px;">üé¨ Tr√°iler del juego</h3>
        <div id="trailerContainer" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;">
          <!-- Video will be embedded here -->
        </div>
      </div>
    </div>

    <div id="requirementsTab" class="tab-content">
      <div class="requirements-grid">
        <div class="requirement-box">
          <h4>üíª Requisitos M√≠nimos</h4>
          <ul id="minRequirements">
            <!-- Min requirements will be added here -->
          </ul>
        </div>
        <div class="requirement-box">
          <h4 style="color:var(--accent-2)">üöÄ Requisitos Recomendados</h4>
          <ul id="recRequirements">
            <!-- Recommended requirements will be added here -->
          </ul>
        </div>
      </div>
      
      <!-- Platforms -->
      <div style="margin-top:32px;">
        <h3 style="color:var(--accent-1);margin-bottom:16px;">üñ•Ô∏è Plataformas compatibles</h3>
        <div id="platformsList" style="display:flex;gap:16px;flex-wrap:wrap;">
          <!-- Platforms will be added here -->
        </div>
      </div>
    </div>

    <div id="reviewsTab" class="tab-content">
      <!-- Add Review Form (only for logged in users) -->
      <div id="addReviewSection" class="add-review-box" style="display:none;">
        <h4>‚úçÔ∏è Escribe tu rese√±a</h4>
        <div class="star-rating" id="starRating">
          <button data-rating="1">‚≠ê</button>
          <button data-rating="2">‚≠ê</button>
          <button data-rating="3">‚≠ê</button>
          <button data-rating="4">‚≠ê</button>
          <button data-rating="5">‚≠ê</button>
        </div>
        <textarea 
          id="reviewText" 
          class="review-textarea" 
          placeholder="Comparte tu experiencia con este juego..."
          maxlength="500"
        ></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <small style="color:var(--muted)"><span id="charCount">0</span>/500 caracteres</small>
          <button 
            id="submitReviewBtn" 
            class="btn" 
            style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;font-weight:600;"
          >
            Publicar rese√±a
          </button>
        </div>
      </div>

      <!-- Login prompt for non-logged users -->
      <div id="loginPrompt" class="add-review-box" style="display:none;text-align:center;">
        <p style="color:var(--muted);margin-bottom:16px;">Debes iniciar sesi√≥n para dejar una rese√±a</p>
        <a href="inicio.html" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a;font-weight:600;">
          Iniciar sesi√≥n
        </a>
      </div>

      <!-- Review Summary -->
      <div class="review-summary">
        <div>
          <div class="rating-number" id="avgRating">0.0</div>
          <div class="review-stars" id="avgStars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
          <div style="color:var(--muted);margin-top:8px"><span id="totalReviewsCount">0</span> rese√±as</div>
        </div>
        <div class="rating-bars">
          <div class="rating-bar">
            <span>5‚òÖ</span>
            <div class="rating-bar-fill">
              <div style="width:0%" id="bar5"></div>
            </div>
            <span id="count5">0</span>
          </div>
          <div class="rating-bar">
            <span>4‚òÖ</span>
            <div class="rating-bar-fill">
              <div style="width:0%" id="bar4"></div>
            </div>
            <span id="count4">0</span>
          </div>
          <div class="rating-bar">
            <span>3‚òÖ</span>
            <div class="rating-bar-fill">
              <div style="width:0%" id="bar3"></div>
            </div>
            <span id="count3">0</span>
          </div>
          <div class="rating-bar">
            <span>2‚òÖ</span>
            <div class="rating-bar-fill">
              <div style="width:0%" id="bar2"></div>
            </div>
            <span id="count2">0</span>
          </div>
          <div class="rating-bar">
            <span>1‚òÖ</span>
            <div class="rating-bar-fill">
              <div style="width:0%" id="bar1"></div>
            </div>
            <span id="count1">0</span>
          </div>
        </div>
      </div>

      <div id="reviewsList">
        <!-- Reviews will be added here dynamically -->
      </div>
    </div>

    <!-- Similar Games -->
    <section class="similar-games">
      <h2>üéÆ Tambi√©n te puede interesar</h2>
      <div class="games-grid" id="similarGames">
        <!-- Similar games will be added here -->
      </div>
    </section>
  </div>

  <!-- Footer -->
  <footer style="background:var(--card);padding:40px 0;margin-top:80px">
    <div class="container" style="text-align:center">
      <p style="color:var(--muted)">¬© 2025 Pyxolotl ¬∑ Hecho con ‚ô• para desarrolladores indie</p>
      <p style="margin-top:12px">
        <a href="mailto:contacto@pyxolotl.com" style="color:var(--accent-1);margin:0 12px">contacto@pyxolotl.com</a>
      </p>
    </div>
  </footer>

  <script src="api.js"></script>
  <script>
    // Global variables
    let currentGame = null;
    let selectedRating = 0;

    // Get game ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('id');
    
    console.log('Game ID from URL:', gameId);
    
    if (!gameId) {
      // If no ID in URL, try to get the first game or show error
      showError();
    } else {
      loadGameDetails();
    }

    // Show error message
    function showError() {
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
    }

    // Load game details
    async function loadGameDetails() {
      try {
        console.log('Loading game with ID:', gameId);
        
        const response = await apiGetJuego(gameId);
        console.log('Game data received:', response);
        
        if (!response) {
          throw new Error('No se encontr√≥ el juego');
        }

        currentGame = response;

        // Hide spinner, show content
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        // Update page title
        document.title = `${response.titulo} - Pyxolotl`;

        // Basic info
        document.getElementById('productTitle').textContent = response.titulo || 'Sin t√≠tulo';
        document.getElementById('genreBadge').textContent = response.genero || 'Indie';
        document.getElementById('productSubtitle').textContent = response.descripcion || 'Sin descripci√≥n disponible';
        
        // Main image
        const mainImg = document.getElementById('mainImage');
        if (response.portada_url) {
          mainImg.innerHTML = `<img src="${response.portada_url}" alt="${response.titulo}">`;
        } else {
          document.getElementById('mainImageInitial').textContent = 
            response.titulo ? response.titulo.substring(0, 2).toUpperCase() : '?';
        }

        // Screenshots
        const thumbnailGrid = document.getElementById('thumbnailGrid');
        thumbnailGrid.innerHTML = '';
        
        // Add main image as first thumbnail
        const mainThumb = document.createElement('div');
        mainThumb.className = 'thumbnail active';
        if (response.portada_url) {
          mainThumb.innerHTML = `<img src="${response.portada_url}" alt="Main">`;
        } else {
          mainThumb.innerHTML = response.titulo ? response.titulo.substring(0, 2).toUpperCase() : '?';
        }
        mainThumb.onclick = () => selectImage(response.portada_url, 0);
        thumbnailGrid.appendChild(mainThumb);

        // Add screenshots if available
        if (response.screenshots_urls) {
          try {
            const screenshots = JSON.parse(response.screenshots_urls);
            if (Array.isArray(screenshots)) {
              screenshots.forEach((url, index) => {
                const thumb = document.createElement('div');
                thumb.className = 'thumbnail';
                thumb.innerHTML = `<img src="${url}" alt="Screenshot ${index + 1}">`;
                thumb.onclick = () => selectImage(url, index + 1);
                thumbnailGrid.appendChild(thumb);
              });
            }
          } catch (e) {
            console.error('Error parsing screenshots:', e);
          }
        }

        // Price
        const priceDiv = document.getElementById('priceDisplay');
        if (response.precio === 0 || response.precio === null) {
          priceDiv.innerHTML = `
            <div class="current-price">GRATIS</div>
            <small style="color:#4CAF50">‚ú® Juego gratuito</small>
          `;
          document.getElementById('addToCartBtn').textContent = '‚¨áÔ∏è Obtener gratis';
        } else {
          priceDiv.innerHTML = `
            <div class="current-price">$${parseFloat(response.precio).toFixed(2)} MXN</div>
          `;
        }

        // Stats
        document.getElementById('gameRating').textContent = 
          response.calificacion_promedio ? response.calificacion_promedio.toFixed(1) : '0.0';
        document.getElementById('totalReviews').textContent = response.total_resenas || 0;
        document.getElementById('totalDownloads').textContent = response.total_descargas || 0;
        document.getElementById('totalSales').textContent = response.total_ventas || 0;
        document.getElementById('fileSize').textContent = 
          response.tamano_mb ? `${response.tamano_mb} MB` : 'No especificado';

        // Developer info
        document.getElementById('developerName').textContent = 
          response.desarrollador?.nombre || 'Desarrollador Indie';
        
        // Release date
        if (response.fecha_creacion) {
          const date = new Date(response.fecha_creacion);
          const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                         'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
          document.getElementById('releaseDate').textContent = 
            `${months[date.getMonth()]} ${date.getFullYear()}`;
        } else {
          document.getElementById('releaseDate').textContent = 'No especificada';
        }

        // Full description
        document.getElementById('fullDescription').textContent = 
          response.descripcion || 'No hay descripci√≥n disponible para este juego.';

        // Trailer
        if (response.trailer_url) {
          const trailerSection = document.getElementById('trailerSection');
          trailerSection.style.display = 'block';
          
          // Check if it's a YouTube URL
          const youtubeMatch = response.trailer_url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);
          if (youtubeMatch) {
            document.getElementById('trailerContainer').innerHTML = `
              <iframe 
                style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;border-radius:12px;"
                src="https://www.youtube.com/embed/${youtubeMatch[1]}" 
                frameborder="0" 
                allowfullscreen>
              </iframe>
            `;
          } else {
            document.getElementById('trailerContainer').innerHTML = `
              <video 
                controls 
                style="width:100%;border-radius:12px;"
                src="${response.trailer_url}">
              </video>
            `;
          }
        }

        // Requirements
        if (response.requisitos) {
          try {
            const reqs = typeof response.requisitos === 'string' 
              ? JSON.parse(response.requisitos) 
              : response.requisitos;
            
            // Minimum requirements
            const minReqsList = document.getElementById('minRequirements');
            minReqsList.innerHTML = `
              <li><strong>SO:</strong> ${reqs.minimos?.os || 'Windows 7/8/10'}</li>
              <li><strong>Procesador:</strong> ${reqs.minimos?.cpu || 'Intel Core i3'}</li>
              <li><strong>Memoria:</strong> ${reqs.minimos?.ram || '4 GB RAM'}</li>
              <li><strong>Gr√°ficos:</strong> ${reqs.minimos?.gpu || 'Intel HD 4000'}</li>
              <li><strong>Almacenamiento:</strong> ${reqs.minimos?.storage || '500 MB'}</li>
            `;

            // Recommended requirements
            const recReqsList = document.getElementById('recRequirements');
            recReqsList.innerHTML = `
              <li><strong>SO:</strong> ${reqs.recomendados?.os || 'Windows 10/11'}</li>
              <li><strong>Procesador:</strong> ${reqs.recomendados?.cpu || 'Intel Core i5'}</li>
              <li><strong>Memoria:</strong> ${reqs.recomendados?.ram || '8 GB RAM'}</li>
              <li><strong>Gr√°ficos:</strong> ${reqs.recomendados?.gpu || 'NVIDIA GTX 1050'}</li>
              <li><strong>Almacenamiento:</strong> ${reqs.recomendados?.storage || '1 GB'}</li>
            `;

            // Platforms
            if (reqs.plataformas && Array.isArray(reqs.plataformas)) {
              const platformsDiv = document.getElementById('platformsList');
              const platformIcons = {
                'windows': 'ü™ü Windows',
                'mac': 'üçé MacOS',
                'linux': 'üêß Linux',
                'web': 'üåê Navegador'
              };
              
              platformsDiv.innerHTML = reqs.plataformas.map(platform => `
                <div style="padding:8px 16px;background:var(--glass);border-radius:8px;">
                  ${platformIcons[platform] || platform}
                </div>
              `).join('');
            }
          } catch (e) {
            console.error('Error parsing requirements:', e);
          }
        }

        // Load reviews
        await loadReviews();

        // Similar games
        loadSimilarGames(response.genero, response.id);

        // Add to cart button
        document.getElementById('addToCartBtn').onclick = () => {
          if (response.precio === 0) {
            handleFreeGame(response.id);
          } else {
            addToCart(response.id, response.titulo, response.precio, response.portada_url);
          }
        };

        // Check if user is logged in for reviews
        const user = JSON.parse(localStorage.getItem('current_user') || '{}');
        const token = localStorage.getItem('auth_token');
        
        if (user && token) {
          document.getElementById('addReviewSection').style.display = 'block';
          document.getElementById('loginPrompt').style.display = 'none';
        } else {
          document.getElementById('addReviewSection').style.display = 'none';
          document.getElementById('loginPrompt').style.display = 'block';
        }

      } catch (error) {
        console.error('Error loading game:', error);
        showError();
      }
    }

    // Select image for main display
    function selectImage(imageUrl, index) {
      const mainImg = document.getElementById('mainImage');
      if (imageUrl) {
        mainImg.innerHTML = `<img src="${imageUrl}" alt="Screenshot">`;
      }
      
      // Update active thumbnail
      const thumbs = document.querySelectorAll('.thumbnail');
      thumbs.forEach((thumb, i) => {
        thumb.classList.toggle('active', i === index);
      });
    }

    // Switch tabs
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}Tab`).classList.add('active');
    }

    // Star rating system
    document.querySelectorAll('#starRating button').forEach(button => {
      button.addEventListener('click', function() {
        selectedRating = parseInt(this.dataset.rating);
        
        // Update visual state
        document.querySelectorAll('#starRating button').forEach((btn, index) => {
          btn.classList.toggle('active', index < selectedRating);
        });
      });
    });

    // Character count for review
    document.getElementById('reviewText')?.addEventListener('input', function() {
      document.getElementById('charCount').textContent = this.value.length;
    });

    // Submit review
    document.getElementById('submitReviewBtn')?.addEventListener('click', async function() {
      const reviewText = document.getElementById('reviewText').value.trim();
      
      if (selectedRating === 0) {
        alert('Por favor selecciona una calificaci√≥n');
        return;
      }
      
      if (reviewText.length < 10) {
        alert('La rese√±a debe tener al menos 10 caracteres');
        return;
      }
      
      try {
        // TODO: Implement API call to submit review
        // For now, we'll just show a success message
        const token = localStorage.getItem('auth_token');
        
        // This is a placeholder - you need to implement the backend endpoint
        const response = await fetch(`${window.API_URL || 'https://pyxolotl-production.up.railway.app'}/api/resenas`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            juego_id: parseInt(gameId),
            calificacion: selectedRating,
            texto: reviewText
          })
        });
        
        if (response.ok) {
          alert('‚úÖ ¬°Rese√±a publicada con √©xito!');
          
          // Reset form
          selectedRating = 0;
          document.getElementById('reviewText').value = '';
          document.getElementById('charCount').textContent = '0';
          document.querySelectorAll('#starRating button').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // Reload reviews
          await loadReviews();
          
          // Update game stats
          currentGame.total_resenas = (currentGame.total_resenas || 0) + 1;
          document.getElementById('totalReviews').textContent = currentGame.total_resenas;
          document.getElementById('reviewCount').textContent = currentGame.total_resenas;
          document.getElementById('totalReviewsCount').textContent = currentGame.total_resenas;
        } else {
          const error = await response.json();
          alert('‚ùå Error: ' + (error.detail || 'No se pudo publicar la rese√±a'));
        }
      } catch (error) {
        console.error('Error submitting review:', error);
        alert('‚ùå Error al publicar la rese√±a. Por favor intenta de nuevo.');
      }
    });

    // Load reviews
    async function loadReviews() {
      try {
        // TODO: Replace with actual API call
        // const response = await fetch(`${API_URL}/api/resenas/juego/${gameId}`);
        // const reviews = await response.json();
        
        // For now, using static data
        const reviews = [];
        
        // Update review count
        document.getElementById('reviewCount').textContent = reviews.length;
        document.getElementById('totalReviewsCount').textContent = reviews.length;
        
        // Calculate rating distribution
        const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        let totalRating = 0;
        
        reviews.forEach(review => {
          distribution[review.calificacion]++;
          totalRating += review.calificacion;
        });
        
        // Update rating bars
        const total = reviews.length || 1;
        for (let i = 1; i <= 5; i++) {
          document.getElementById(`count${i}`).textContent = distribution[i];
          document.getElementById(`bar${i}`).style.width = `${(distribution[i] / total) * 100}%`;
        }
        
        // Update average
        const avg = reviews.length > 0 ? (totalRating / reviews.length) : 0;
        document.getElementById('avgRating').textContent = avg.toFixed(1);
        
        // Update stars
        const stars = Math.round(avg);
        document.getElementById('avgStars').textContent = '‚≠ê'.repeat(stars) + '‚òÜ'.repeat(5 - stars);
        
        // Display reviews
        const reviewsList = document.getElementById('reviewsList');
        if (reviews.length === 0) {
          reviewsList.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--muted);">
              <div style="font-size:48px;margin-bottom:16px;">üí¨</div>
              <p>A√∫n no hay rese√±as para este juego.</p>
              <p style="margin-top:8px;">¬°S√© el primero en dejar tu opini√≥n!</p>
            </div>
          `;
        } else {
          reviewsList.innerHTML = reviews.map(review => {
            const date = new Date(review.fecha_creacion);
            const timeAgo = getTimeAgo(date);
            
            return `
              <div class="review-card">
                <div class="review-header">
                  <div>
                    <div class="review-author">${review.usuario?.nombre || 'Usuario'}</div>
                    <div class="review-date">${timeAgo}</div>
                  </div>
                  <div class="review-stars">
                    ${'‚≠ê'.repeat(review.calificacion)}${'‚òÜ'.repeat(5 - review.calificacion)}
                  </div>
                </div>
                <p style="margin:0;color:var(--muted)">${review.texto}</p>
              </div>
            `;
          }).join('');
        }
        
      } catch (error) {
        console.error('Error loading reviews:', error);
      }
    }

    // Get time ago string
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      let interval = seconds / 31536000;
      if (interval > 1) return `Hace ${Math.floor(interval)} a√±o${Math.floor(interval) > 1 ? 's' : ''}`;
      
      interval = seconds / 2592000;
      if (interval > 1) return `Hace ${Math.floor(interval)} mes${Math.floor(interval) > 1 ? 'es' : ''}`;
      
      interval = seconds / 86400;
      if (interval > 1) return `Hace ${Math.floor(interval)} d√≠a${Math.floor(interval) > 1 ? 's' : ''}`;
      
      interval = seconds / 3600;
      if (interval > 1) return `Hace ${Math.floor(interval)} hora${Math.floor(interval) > 1 ? 's' : ''}`;
      
      interval = seconds / 60;
      if (interval > 1) return `Hace ${Math.floor(interval)} minuto${Math.floor(interval) > 1 ? 's' : ''}`;
      
      return 'Hace un momento';
    }

    // Load similar games
    async function loadSimilarGames(genre, currentGameId) {
      try {
        const response = await apiGetJuegos({ genero: genre });
        const similarGames = response
          .filter(game => game.id !== parseInt(currentGameId))
          .slice(0, 3);

        const container = document.getElementById('similarGames');
        
        if (similarGames.length === 0) {
          container.innerHTML = `
            <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">
              <p>No hay juegos similares disponibles en este momento.</p>
            </div>
          `;
        } else {
          container.innerHTML = similarGames.map(game => `
            <div class="game-card" onclick="window.location.href='producto-detalle.html?id=${game.id}'">
              <div class="thumb">
                ${game.portada_url 
                  ? `<img src="${game.portada_url}" alt="${game.titulo}">` 
                  : `<span>${game.titulo ? game.titulo.substring(0, 2).toUpperCase() : '?'}</span>`}
              </div>
              <div class="game-card-info">
                <h4>${game.titulo || 'Sin t√≠tulo'}</h4>
                <p style="color:var(--muted);font-size:14px">
                  ${game.genero || 'Indie'} ¬∑ 
                  ${game.fecha_creacion ? new Date(game.fecha_creacion).getFullYear() : '2025'} ¬∑ 
                  ${game.desarrollador?.nombre || 'Indie'}
                </p>
                <p style="color:var(--accent-1);font-weight:700;margin-top:8px">
                  ${game.precio === 0 || game.precio === null ? 'GRATIS' : `$${parseFloat(game.precio).toFixed(2)}`}
                </p>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading similar games:', error);
      }
    }

    // Add to cart
    function addToCart(gameId, title, price, image) {
      // Check if user is logged in
      if (!localStorage.getItem('auth_token')) {
        alert('Debes iniciar sesi√≥n para agregar juegos al carrito');
        window.location.href = 'inicio.html';
        return;
      }

      // Get current cart from localStorage
      let cart = JSON.parse(localStorage.getItem('pyxolotl_cart') || '[]');
      
      // Check if already in cart
      if (cart.find(item => item.id === gameId)) {
        alert('Este juego ya est√° en tu carrito');
        return;
      }

      // Add to cart
      cart.push({
        id: gameId,
        titulo: title,
        precio: price,
        imagen: image
      });

      localStorage.setItem('pyxolotl_cart', JSON.stringify(cart));

      // Update cart count
      updateCartCount();
      
      alert('‚úÖ Juego agregado al carrito');
    }

    // Handle free game
    async function handleFreeGame(gameId) {
      if (!localStorage.getItem('auth_token')) {
        alert('Debes iniciar sesi√≥n para obtener juegos gratis');
        window.location.href = 'inicio.html';
        return;
      }

      try {
        const response = await apiGetJuegoGratis(gameId);
        if (response.success) {
          alert('‚úÖ ¬°Juego agregado a tu biblioteca! Ya puedes descargarlo.');
          window.location.href = 'biblioteca.html';
        } else {
          alert('‚ùå ' + (response.message || 'Error al obtener el juego'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al procesar la solicitud');
      }
    }

    // Update cart count
    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('pyxolotl_cart') || '[]');
      const countElement = document.getElementById('cartCount');
      if (cart.length > 0) {
        countElement.textContent = cart.length;
        countElement.style.display = 'inline-block';
      } else {
        countElement.style.display = 'none';
      }
    }

    // Load on page ready
    document.addEventListener('DOMContentLoaded', () => {
      updateCartCount();
      
      // Check if user is logged in
      const user = JSON.parse(localStorage.getItem('current_user') || '{}');
      if (user && user.nombre) {
        const profileBtn = document.getElementById('userProfileBtn');
        profileBtn.textContent = `üë§ ${user.nombre}`;
        profileBtn.style.display = 'inline-block';
      }
    });
  </script>
</body>
</html>