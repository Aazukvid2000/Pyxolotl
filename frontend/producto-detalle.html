<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalles del Juego ‚Äì Pyxolotl</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos del header consistentes con index.html */
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .user-avatar span {
      color: #07102a;
      font-weight: bold;
      font-size: 16px;
    }
    #userName {
      color: var(--accent-1);
      font-weight: 600;
      cursor: pointer;
    }

    /* Product styles */
    .product-hero {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin: 40px 0;
      align-items: start;
    }
    .product-gallery { position: sticky; top: 100px; }
    .main-image {
      width: 100%;
      height: 400px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      color: #07102a;
      font-weight: 700;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(123,97,255,0.3);
      overflow: hidden;
    }
    .main-image img { width: 100%; height: 100%; object-fit: cover; }
    .thumbnail-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .thumbnail {
      height: 80px;
      border-radius: 8px;
      background: var(--glass);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      overflow: hidden;
    }
    .thumbnail img { width: 100%; height: 100%; object-fit: cover; }
    .thumbnail:hover, .thumbnail.active {
      border-color: var(--accent-1);
      transform: scale(1.05);
    }
    .product-info {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    }
    .price-section {
      background: linear-gradient(135deg, rgba(123,97,255,0.1), rgba(78,163,255,0.1));
      padding: 24px;
      border-radius: 12px;
      margin: 24px 0;
    }
    .current-price {
      font-size: 42px;
      font-weight: 700;
      color: var(--accent-1);
    }
    .free-badge {
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      color: #07102a;
      padding: 8px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 24px;
      display: inline-block;
    }
    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 24px 0;
      flex-wrap: wrap;
    }
    .dev-info {
      background: linear-gradient(135deg, rgba(123,97,255,0.15), rgba(78,163,255,0.15));
      padding: 20px;
      border-radius: 12px;
      margin-top: 24px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 24px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      margin: 40px 0 32px;
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      color: var(--muted);
      font-weight: 500;
      transition: all 0.2s;
      position: relative;
      background: none;
      border: none;
      font-size: 16px;
    }
    .tab:hover { color: #fff; }
    .tab.active { color: var(--accent-1); }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent-1);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Requirements */
    .requirements-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }
    .requirement-box {
      background: var(--glass);
      padding: 24px;
      border-radius: 12px;
    }
    .requirement-box h4 {
      color: var(--accent-1);
      margin: 0 0 16px;
    }
    .requirement-box ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .requirement-box li {
      padding: 8px 0;
      color: var(--muted);
    }

    /* Reviews */
    .reviews-summary {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      display: flex;
      gap: 40px;
      align-items: center;
      flex-wrap: wrap;
    }
    .rating-big {
      text-align: center;
    }
    .rating-big .score {
      font-size: 64px;
      font-weight: 700;
      color: var(--accent-1);
    }
    .rating-big .stars {
      color: #ffd700;
      font-size: 24px;
    }
    .rating-bars { flex: 1; min-width: 250px; }
    .rating-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 6px 0;
    }
    .rating-bar-fill {
      flex: 1;
      height: 8px;
      background: var(--glass);
      border-radius: 4px;
      overflow: hidden;
    }
    .rating-bar-fill div {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-2), var(--accent-1));
      border-radius: 4px;
    }

    /* Review form */
    .review-form {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      display: none;
    }
    .review-form.active { display: block; }
    .star-select {
      display: flex;
      gap: 8px;
      margin: 16px 0;
    }
    .star-select button {
      font-size: 32px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--glass);
      transition: all 0.2s;
    }
    .star-select button:hover,
    .star-select button.active {
      color: #ffd700;
      transform: scale(1.1);
    }
    .review-textarea {
      width: 100%;
      min-height: 120px;
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--glass);
      background: rgba(255,255,255,0.03);
      color: #fff;
      font-family: inherit;
      font-size: 16px;
      resize: vertical;
    }
    .review-textarea:focus {
      outline: none;
      border-color: var(--accent-1);
    }

    /* Review cards */
    .review-card {
      background: var(--glass);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .review-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .review-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #07102a;
    }
    .review-stars { color: #ffd700; font-size: 18px; }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px;
      color: var(--muted);
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--glass);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Error state */
    .error-state {
      text-align: center;
      padding: 60px;
    }
    .error-state h2 { color: #ff4757; }

    @media (max-width: 1024px) {
      .product-hero { grid-template-columns: 1fr; }
      .product-gallery { position: static; }
      .requirements-grid { grid-template-columns: 1fr; }
      .reviews-summary { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Header igual a index.html -->
  <header class="container header">
    <div class="brand" onclick="window.location.href='index.html'" style="cursor:pointer">
      <img src="PIXOLOTEL.png" alt="Logo Pyxolotl" class="brand-logo" onerror="this.style.display='none'">
      <div>
        <div class="site-title">Pyxolotl</div>
        <div style="font-size:12px;color:var(--muted)">Marketplace de juegos indie mexicanos</div>
      </div>
    </div>

    <nav class="nav">
      <a href="index.html">üè† Inicio</a>
      <a href="biblioteca.html">üìö Biblioteca</a>
      
      <!-- Botones de login (por defecto visibles) -->
      <a class="btn btn-ghost" href="inicio.html" id="loginBtn">Iniciar sesi√≥n</a>
      
      <!-- Perfil del usuario (oculto por defecto) -->
      <div id="userProfile" class="user-profile" style="display:none">
        <div id="userAvatar" class="user-avatar">
          <span id="userInitials">U</span>
        </div>
        <span id="userName">Usuario</span>
        <button id="logoutBtn" class="btn btn-ghost" onclick="logout()">Cerrar sesi√≥n</button>
      </div>
      
      <button id="cartBtn" class="btn btn-ghost" style="position:relative" onclick="window.location.href='pago.html'">
        üõí <span id="cartCount" class="cart-badge">0</span>
      </button>
    </nav>
  </header>

  <main class="container">
    <div style="margin: 20px 0">
      <a href="index.html" style="color:var(--muted);text-decoration:none">‚Üê Volver a la tienda</a>
    </div>

    <!-- Loading -->
    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <p>Cargando informaci√≥n del juego...</p>
    </div>

    <!-- Error -->
    <div id="errorState" class="error-state" style="display:none">
      <div style="font-size:80px;margin-bottom:20px">‚ö†Ô∏è</div>
      <h2>Juego no encontrado</h2>
      <p style="color:var(--muted)">El juego que buscas no existe o ha sido eliminado.</p>
      <a href="index.html" class="btn" style="margin-top:20px">Volver al inicio</a>
    </div>

    <!-- Contenido del juego -->
    <div id="gameContent" style="display:none">
      <div class="product-hero">
        <!-- Galer√≠a -->
        <div class="product-gallery">
          <div class="main-image" id="mainImage"><span id="mainImageText">?</span></div>
          <div class="thumbnail-grid" id="thumbnailGrid"></div>
        </div>

        <!-- Info -->
        <div>
          <div style="margin-bottom:12px">
            <span class="kicker" id="gameGenre">G√©nero</span>
          </div>
          <h1 style="margin:0 0 16px;font-size:42px" id="gameTitle">T√≠tulo del juego</h1>
          <p style="color:var(--muted);line-height:1.6" id="gameShortDesc">Descripci√≥n corta...</p>

          <div class="product-info">
            <!-- Rating header -->
            <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
              <span id="headerStars" style="color:#ffd700;font-size:20px">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
              <span style="color:var(--muted)" id="headerRating">5.0 (0 rese√±as)</span>
            </div>

            <!-- Precio -->
            <div class="price-section">
              <div id="priceDisplay"><span class="current-price">$0.00</span></div>
            </div>

            <!-- Botones -->
            <div class="action-buttons">
              <button id="addToCartBtn" class="btn" style="flex:1;padding:16px;font-size:18px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">
                üõí Agregar al carrito
              </button>
              <button id="getFreeBtn" class="btn" style="flex:1;padding:16px;font-size:18px;background:linear-gradient(135deg,#43e97b,#38f9d7);color:#07102a;display:none">
                üéÆ Obtener gratis
              </button>
            </div>

            <!-- Dev info -->
            <div class="dev-info">
              <p style="margin:0"><strong>üéÆ Desarrollado por:</strong> <span id="devName">Desarrollador</span></p>
              <p style="margin:8px 0 0;color:var(--muted);font-size:14px" id="gameSize"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="description">üìù Descripci√≥n</button>
        <button class="tab" data-tab="requirements">üíª Requisitos</button>
        <button class="tab" data-tab="reviews">‚≠ê Rese√±as</button>
      </div>

      <!-- Tab: Descripci√≥n -->
      <div class="tab-content active" id="tab-description">
        <div style="background:var(--card);padding:32px;border-radius:16px">
          <h2 style="margin-top:0">Acerca del juego</h2>
          <div id="gameFullDesc" style="color:var(--muted);line-height:1.8"></div>
        </div>
      </div>

      <!-- Tab: Requisitos -->
      <div class="tab-content" id="tab-requirements">
        <div class="requirements-grid">
          <div class="requirement-box">
            <h4>üíª Requisitos M√≠nimos</h4>
            <div id="minReqs"><p style="color:var(--muted)">No especificados</p></div>
          </div>
          <div class="requirement-box">
            <h4 style="color:var(--accent-2)">üöÄ Requisitos Recomendados</h4>
            <div id="recReqs"><p style="color:var(--muted)">No especificados</p></div>
          </div>
        </div>
      </div>

      <!-- Tab: Rese√±as -->
      <div class="tab-content" id="tab-reviews">
        <!-- Summary -->
        <div class="reviews-summary">
          <div class="rating-big">
            <div class="score" id="avgScore">0.0</div>
            <div class="stars" id="avgStars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
            <p style="color:var(--muted);margin:8px 0 0" id="totalReviewsText">0 rese√±as</p>
          </div>
          <div class="rating-bars" id="ratingBars"></div>
          <div>
            <button id="writeReviewBtn" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">
              ‚úçÔ∏è Escribir rese√±a
            </button>
          </div>
        </div>

        <!-- Formulario de rese√±a -->
        <div class="review-form" id="reviewForm">
          <h3 style="margin-top:0">‚úçÔ∏è Tu rese√±a</h3>
          <p style="color:var(--muted)">Comparte tu experiencia</p>
          
          <label style="color:var(--muted)">Tu calificaci√≥n:</label>
          <div class="star-select" id="starSelect">
            <button data-value="1">‚òÜ</button>
            <button data-value="2">‚òÜ</button>
            <button data-value="3">‚òÜ</button>
            <button data-value="4">‚òÜ</button>
            <button data-value="5">‚òÜ</button>
          </div>
          
          <label style="color:var(--muted)">Tu opini√≥n (m√≠nimo 10 caracteres):</label>
          <textarea id="reviewText" class="review-textarea" placeholder="Cu√©ntanos qu√© te pareci√≥ el juego..."></textarea>
          
          <div style="display:flex;gap:12px;margin-top:16px">
            <button id="submitReviewBtn" class="btn" style="background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">
              üì§ Publicar
            </button>
            <button id="cancelReviewBtn" class="btn btn-ghost">Cancelar</button>
          </div>
        </div>

        <!-- Lista de rese√±as -->
        <div id="reviewsList"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="pyxolotl-footer">
    <div class="footer-container">
      <div class="footer-column">
        <h3 class="footer-title">PYXOLOTL</h3>
        <p class="footer-description">Plataforma mexicana de videojuegos indie. Conectando desarrolladores con jugadores apasionados.</p>
        <div class="footer-social">
          <a href="https://www.instagram.com/pyxo.lotl?igsh=OHRybW00NHA4Nnc4" target="_blank" rel="noopener noreferrer" aria-label="Instagram" class="social-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
              <path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z" fill="none" stroke="#07102a" stroke-width="2"/>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5" stroke="#07102a" stroke-width="2"/>
            </svg>
          </a>
          <a href="https://www.facebook.com/profile.php?id=61584296583769" target="_blank" rel="noopener noreferrer" aria-label="Facebook" class="social-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </a>
        </div>
      </div>
      <div class="footer-column">
        <h4 class="footer-heading">DESARROLLADORES</h4>
        <ul class="footer-links">
          <li><a href="publicar-juego.html">Publicar juego</a></li>
          <li><a href="index.html#about">Acerca de Pyxolotl</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4 class="footer-heading">AYUDA</h4>
        <ul class="footer-links">
          <li><a href="faq.html">Preguntas frecuentes</a></li>
          <li><a href="mailto:soporte@pyxolotl.com">Soporte</a></li>
          <li><a href="#" onclick="openTermsModal(event)">T√©rminos y condiciones</a></li>
          <li><a href="#" onclick="openPrivacyModal(event)">Privacidad</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4 class="footer-heading">PYXOLOTL</h4>
        <ul class="footer-links">
          <li><a href="biblioteca.html">Mi biblioteca</a></li>
          <li><a href="inicio.html#registro">Registrarse</a></li>
          <li><a href="inicio.html">Iniciar sesi√≥n</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="footer-container">
        <p class="footer-copyright">¬© 2025 Pyxolotl. Todos los derechos reservados.</p>
        <div class="footer-legal">
          <a href="#" onclick="openPrivacyModal(event)">Privacidad</a>
          <span class="separator">¬∑</span>
          <a href="#" onclick="openTermsModal(event)">T√©rminos</a>
          <span class="separator">¬∑</span>
          <a href="faq.html">FAQ</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Modales -->
  <div id="termsModal" class="modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center">
    <div style="background:var(--card);padding:40px;border-radius:20px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto">
      <h2 style="margin-top:0">T√©rminos y Condiciones</h2>
      <p style="color:var(--muted);line-height:1.8">Al usar Pyxolotl, aceptas nuestros t√©rminos de servicio. Esta plataforma est√° dise√±ada para la distribuci√≥n de videojuegos independientes mexicanos.</p>
      <button onclick="closeTermsModal()" class="btn" style="margin-top:20px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">Cerrar</button>
    </div>
  </div>
  <div id="privacyModal" class="modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center">
    <div style="background:var(--card);padding:40px;border-radius:20px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto">
      <h2 style="margin-top:0">Pol√≠tica de Privacidad</h2>
      <p style="color:var(--muted);line-height:1.8">Pyxolotl respeta tu privacidad. Solo recopilamos informaci√≥n necesaria para el funcionamiento de la plataforma.</p>
      <button onclick="closePrivacyModal()" class="btn" style="margin-top:20px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#07102a">Cerrar</button>
    </div>
  </div>

  <style>
    .pyxolotl-footer {
      background: linear-gradient(180deg, #0a0e1a 0%, #07102a 100%);
      border-top: 1px solid rgba(123, 97, 255, 0.1);
      padding: 60px 0 0 0; margin-top: 100px; color: #e0e0e0;
    }
    .footer-container {
      max-width: 1400px; margin: 0 auto; padding: 0 40px;
      display: grid; grid-template-columns: 1.5fr repeat(3, 1fr); gap: 50px;
    }
    .footer-column { display: flex; flex-direction: column; gap: 20px; }
    .footer-title {
      font-size: 24px; font-weight: 700;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin-bottom: 8px; letter-spacing: 1px;
    }
    .footer-description { color: #b0b0b0; font-size: 14px; line-height: 1.6; margin-bottom: 10px; }
    .footer-social { display: flex; gap: 12px; margin-top: 8px; }
    .social-link {
      width: 40px; height: 40px; border-radius: 50%;
      background: rgba(123, 97, 255, 0.1);
      display: flex; align-items: center; justify-content: center;
      color: var(--accent-1); transition: all 0.3s ease;
      border: 1px solid rgba(123, 97, 255, 0.2); text-decoration: none;
    }
    .social-link:hover {
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #07102a; transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(123, 97, 255, 0.4);
    }
    .footer-heading { font-size: 12px; font-weight: 700; letter-spacing: 1.5px; color: #808080; text-transform: uppercase; margin-bottom: 4px; }
    .footer-links { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
    .footer-links li a { color: #b0b0b0; font-size: 14px; text-decoration: none; transition: all 0.2s ease; display: inline-block; }
    .footer-links li a:hover { color: var(--accent-1); transform: translateX(4px); }
    .footer-bottom { background: #060a16; border-top: 1px solid rgba(123, 97, 255, 0.1); padding: 24px 0; margin-top: 50px; }
    .footer-bottom .footer-container { display: flex; justify-content: space-between; align-items: center; }
    .footer-copyright { color: #808080; font-size: 13px; margin: 0; }
    .footer-legal { display: flex; gap: 16px; align-items: center; }
    .footer-legal a { color: #808080; font-size: 13px; text-decoration: none; }
    .footer-legal a:hover { color: var(--accent-1); }
    .footer-legal .separator { color: #404040; }
    @media (max-width: 1024px) {
      .footer-container { grid-template-columns: repeat(2, 1fr); gap: 40px; }
      .footer-column:first-child { grid-column: 1 / -1; text-align: center; }
      .footer-social { justify-content: center; }
    }
    @media (max-width: 768px) {
      .pyxolotl-footer { padding: 40px 0 0 0; margin-top: 60px; }
      .footer-container { grid-template-columns: 1fr; gap: 30px; padding: 0 20px; }
      .footer-bottom .footer-container { flex-direction: column; gap: 16px; text-align: center; }
      .footer-legal { flex-wrap: wrap; justify-content: center; }
    }
  </style>

  <script src="api.js"></script>
  <script>
    function openTermsModal(e) { if(e) e.preventDefault(); document.getElementById('termsModal').style.display = 'flex'; }
    function closeTermsModal() { document.getElementById('termsModal').style.display = 'none'; }
    function openPrivacyModal(e) { if(e) e.preventDefault(); document.getElementById('privacyModal').style.display = 'flex'; }
    function closePrivacyModal() { document.getElementById('privacyModal').style.display = 'none'; }
  </script>
  <script>
    // Variables globales
    let currentGame = null;
    let selectedRating = 0;
    
    // Obtener ID del juego de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('id');
    
    console.log('Game ID from URL:', gameId);

    // ========== INIT ==========
    async function init() {
      updateHeader();
      updateCartCount();
      
      if (!gameId) {
        showError();
        return;
      }
      
      try {
        const game = await apiGetJuego(gameId);
        console.log('Game data:', game);
        
        if (game.detail || !game.id) {
          showError();
          return;
        }
        
        currentGame = game;
        renderGame(game);
        await loadReviews();
        
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('gameContent').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading game:', error);
        showError();
      }
    }

    function showError() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').style.display = 'block';
    }

    // ========== HEADER ==========
    function updateHeader() {
      const user = getCurrentUser();
      if (user && user.nombre) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('userProfile').style.display = 'flex';
        document.getElementById('userName').textContent = user.nombre;
        document.getElementById('userInitials').textContent = getInitials(user.nombre);
      }
    }

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('pyxolotl_cart') || '[]');
      const el = document.getElementById('cartCount');
      el.textContent = cart.length;
      el.style.display = cart.length > 0 ? 'inline-block' : 'none';
    }

    // ========== RENDER GAME ==========
    function renderGame(game) {
      document.title = `${game.titulo} ‚Äì Pyxolotl`;
      
      // B√°sico
      document.getElementById('gameTitle').textContent = game.titulo;
      document.getElementById('gameGenre').textContent = `${game.genero} ¬∑ Indie`;
      document.getElementById('gameShortDesc').textContent = game.descripcion.substring(0, 200) + (game.descripcion.length > 200 ? '...' : '');
      document.getElementById('gameFullDesc').innerHTML = `<p>${game.descripcion.replace(/\n/g, '</p><p>')}</p>`;
      
      // Imagen principal
      const mainImg = document.getElementById('mainImage');
      if (game.portada_url && !game.portada_url.includes('temp')) {
        mainImg.innerHTML = `<img src="${getImageUrl(game.portada_url)}" alt="${game.titulo}" onerror="this.parentElement.innerHTML='<span>${getInitials(game.titulo)}</span>'">`;
      } else {
        document.getElementById('mainImageText').textContent = getInitials(game.titulo);
      }
      
      // Thumbnails
      renderThumbnails(game);
      
      // Precio
      if (game.precio === 0 || game.precio === null) {
        document.getElementById('priceDisplay').innerHTML = '<span class="free-badge">‚ú® GRATIS</span>';
        document.getElementById('addToCartBtn').style.display = 'none';
        document.getElementById('getFreeBtn').style.display = 'block';
      } else {
        document.getElementById('priceDisplay').innerHTML = `<span class="current-price">$${parseFloat(game.precio).toFixed(2)} MXN</span>`;
      }
      
      // Rating
      const rating = game.calificacion_promedio || 0;
      document.getElementById('headerStars').textContent = getStars(rating);
      document.getElementById('headerRating').textContent = `${rating.toFixed(1)} (${game.total_resenas || 0} rese√±as)`;
      
      // Developer
      document.getElementById('devName').textContent = game.desarrollador?.nombre || 'Desarrollador indie';
      if (game.tamano_mb) {
        document.getElementById('gameSize').textContent = `üì¶ Tama√±o: ${game.tamano_mb.toFixed(1)} MB`;
      }
      
      // Requisitos
      renderRequirements(game.requisitos);
    }

    function renderThumbnails(game) {
      const grid = document.getElementById('thumbnailGrid');
      grid.innerHTML = '';
      
      // Portada
      if (game.portada_url) {
        const thumb = createThumb(game.portada_url, true);
        grid.appendChild(thumb);
      }
      
      // Screenshots
      if (game.screenshots_urls) {
        try {
          const urls = JSON.parse(game.screenshots_urls);
          urls.forEach(url => grid.appendChild(createThumb(url, false)));
        } catch(e) {}
      }
    }

    function createThumb(url, active) {
      const div = document.createElement('div');
      div.className = 'thumbnail' + (active ? ' active' : '');
      const imgUrl = getImageUrl(url);
      div.innerHTML = `<img src="${imgUrl}" alt="Screenshot" onerror="this.style.display='none'">`;
      div.onclick = () => {
        document.getElementById('mainImage').innerHTML = `<img src="${imgUrl}" alt="Screenshot">`;
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        div.classList.add('active');
      };
      return div;
    }

    function renderRequirements(reqs) {
      if (!reqs) return;
      try {
        const r = JSON.parse(reqs);
        if (r.minimos) document.getElementById('minReqs').innerHTML = formatReqs(r.minimos);
        if (r.recomendados) document.getElementById('recReqs').innerHTML = formatReqs(r.recomendados);
      } catch(e) {
        document.getElementById('minReqs').innerHTML = `<p style="color:var(--muted)">${reqs}</p>`;
      }
    }

    function formatReqs(r) {
      let html = '<ul>';
      if (r.os) html += `<li><strong>SO:</strong> ${r.os}</li>`;
      if (r.cpu) html += `<li><strong>CPU:</strong> ${r.cpu}</li>`;
      if (r.ram) html += `<li><strong>RAM:</strong> ${r.ram}</li>`;
      if (r.gpu) html += `<li><strong>GPU:</strong> ${r.gpu}</li>`;
      if (r.storage) html += `<li><strong>Disco:</strong> ${r.storage}</li>`;
      return html + '</ul>';
    }

    // ========== REVIEWS ==========
    async function loadReviews() {
      try {
        const reviews = await apiGetResenas(gameId);
        console.log('Reviews:', reviews);
        renderReviews(reviews);
      } catch(e) {
        console.error('Error loading reviews:', e);
        renderReviews([]);
      }
    }

    function renderReviews(reviews) {
      const total = reviews.length;
      const avg = total > 0 ? reviews.reduce((s, r) => s + r.calificacion, 0) / total : 0;
      
      // Summary
      document.getElementById('avgScore').textContent = avg.toFixed(1);
      document.getElementById('avgStars').textContent = getStars(avg);
      document.getElementById('totalReviewsText').textContent = `${total} rese√±a${total !== 1 ? 's' : ''}`;
      
      // Bars
      const dist = [0,0,0,0,0];
      reviews.forEach(r => dist[r.calificacion - 1]++);
      
      let barsHtml = '';
      for (let i = 5; i >= 1; i--) {
        const pct = total > 0 ? (dist[i-1] / total) * 100 : 0;
        barsHtml += `
          <div class="rating-bar">
            <span style="color:var(--muted);width:30px">${i}‚òÖ</span>
            <div class="rating-bar-fill"><div style="width:${pct}%"></div></div>
            <span style="color:var(--muted);width:30px;text-align:right">${dist[i-1]}</span>
          </div>
        `;
      }
      document.getElementById('ratingBars').innerHTML = barsHtml;
      
      // List
      const list = document.getElementById('reviewsList');
      if (total === 0) {
        list.innerHTML = `
          <div style="text-align:center;padding:40px;color:var(--muted)">
            <div style="font-size:48px;margin-bottom:16px">üí¨</div>
            <p>A√∫n no hay rese√±as para este juego.</p>
            <p>¬°S√© el primero en opinar!</p>
          </div>
        `;
      } else {
        list.innerHTML = reviews.map(r => `
          <div class="review-card">
            <div class="review-header">
              <div class="review-user">
                <div class="review-avatar">${getInitials(r.usuario?.nombre || 'U')}</div>
                <div>
                  <strong>${r.usuario?.nombre || 'Usuario'}</strong>
                  <div style="color:var(--muted);font-size:13px">${timeAgo(r.fecha_creacion)}</div>
                </div>
              </div>
              <div class="review-stars">${getStars(r.calificacion)}</div>
            </div>
            <p style="color:var(--muted);margin:0">${r.texto}</p>
          </div>
        `).join('');
      }
    }

    // ========== TABS ==========
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      };
    });

    // ========== REVIEW FORM ==========
    document.getElementById('writeReviewBtn').onclick = () => {
      if (!isAuthenticated()) {
        alert('‚ö†Ô∏è Debes iniciar sesi√≥n para escribir una rese√±a');
        window.location.href = 'inicio.html';
        return;
      }
      document.getElementById('reviewForm').classList.add('active');
      document.getElementById('writeReviewBtn').style.display = 'none';
    };

    document.getElementById('cancelReviewBtn').onclick = () => {
      document.getElementById('reviewForm').classList.remove('active');
      document.getElementById('writeReviewBtn').style.display = 'block';
      resetReviewForm();
    };

    // Stars
    document.querySelectorAll('#starSelect button').forEach(btn => {
      btn.onclick = () => {
        selectedRating = parseInt(btn.dataset.value);
        updateStarSelect();
      };
      btn.onmouseenter = () => {
        const val = parseInt(btn.dataset.value);
        document.querySelectorAll('#starSelect button').forEach((b, i) => {
          b.textContent = i < val ? '‚òÖ' : '‚òÜ';
        });
      };
    });

    document.getElementById('starSelect').onmouseleave = updateStarSelect;

    function updateStarSelect() {
      document.querySelectorAll('#starSelect button').forEach((b, i) => {
        b.textContent = i < selectedRating ? '‚òÖ' : '‚òÜ';
        b.classList.toggle('active', i < selectedRating);
      });
    }

    // Submit
    document.getElementById('submitReviewBtn').onclick = async () => {
      const texto = document.getElementById('reviewText').value.trim();
      
      if (selectedRating === 0) {
        alert('‚ö†Ô∏è Selecciona una calificaci√≥n');
        return;
      }
      if (texto.length < 10) {
        alert('‚ö†Ô∏è La rese√±a debe tener al menos 10 caracteres');
        return;
      }
      
      try {
        const result = await apiCrearResena(gameId, selectedRating, texto);
        console.log('Review result:', result);
        
        if (result.id) {
          alert('‚úÖ ¬°Rese√±a publicada!');
          document.getElementById('reviewForm').classList.remove('active');
          document.getElementById('writeReviewBtn').style.display = 'block';
          resetReviewForm();
          await loadReviews();
        } else {
          alert('‚ùå ' + (result.detail || 'Error al publicar'));
        }
      } catch(e) {
        console.error('Error:', e);
        alert('‚ùå Error al publicar la rese√±a');
      }
    };

    function resetReviewForm() {
      selectedRating = 0;
      document.getElementById('reviewText').value = '';
      updateStarSelect();
    }

    // ========== CART & FREE ==========
    document.getElementById('addToCartBtn').onclick = () => {
      if (!currentGame) return;
      
      let cart = JSON.parse(localStorage.getItem('pyxolotl_cart') || '[]');
      if (cart.find(i => i.id === currentGame.id)) {
        alert('‚ö†Ô∏è Este juego ya est√° en tu carrito');
        return;
      }
      
      cart.push({
        id: currentGame.id,
        titulo: currentGame.titulo,
        precio: currentGame.precio,
        imagen: currentGame.portada_url
      });
      localStorage.setItem('pyxolotl_cart', JSON.stringify(cart));
      alert('‚úÖ Juego agregado al carrito');
      updateCartCount();
    };

    document.getElementById('getFreeBtn').onclick = async () => {
      if (!isAuthenticated()) {
        alert('‚ö†Ô∏è Debes iniciar sesi√≥n');
        window.location.href = 'inicio.html';
        return;
      }
      
      try {
        const result = await apiGetJuegoGratis(gameId);
        if (result.success) {
          alert('‚úÖ ' + result.message);
          window.location.href = 'biblioteca.html';
        } else {
          alert('‚ùå ' + (result.detail || result.message));
        }
      } catch(e) {
        alert('‚ùå Error al obtener el juego');
      }
    };

    // ========== UTILS ==========
    function getInitials(str) {
      if (!str) return '?';
      const words = str.split(' ');
      return words.length >= 2 
        ? (words[0][0] + words[1][0]).toUpperCase()
        : str.substring(0, 2).toUpperCase();
    }

    function getStars(rating) {
      const full = Math.round(rating);
      return '‚òÖ'.repeat(full) + '‚òÜ'.repeat(5 - full);
    }

    function getImageUrl(url) {
      if (!url) return '';
      if (url.startsWith('http')) return url;
      return `${API_URL}${url}`;
    }

    function timeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      
      if (diff < 60) return 'Hace un momento';
      if (diff < 3600) return `Hace ${Math.floor(diff/60)} min`;
      if (diff < 86400) return `Hace ${Math.floor(diff/3600)} h`;
      if (diff < 604800) return `Hace ${Math.floor(diff/86400)} d√≠as`;
      return date.toLocaleDateString('es-MX');
    }

    function logout() {
      clearAuthToken();
      localStorage.removeItem('current_user');
      window.location.href = 'inicio.html';
    }

    // ========== START ==========
    init();
  </script>
</body>
</html>
