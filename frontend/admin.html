<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin ‚Äî Pyxolotl</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:30px 0}
    .stat-card{background:var(--card);padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
    .stat-number{font-size:36px;font-weight:700;color:var(--accent-1);margin:10px 0}
    .juego-pendiente{background:var(--glass);padding:20px;margin:15px 0;border-radius:10px;border-left:4px solid var(--accent-1)}
    .btn-approve{background:#4CAF50;color:white}
    .btn-reject{background:#ff4757;color:white}
    .btn-download{background:var(--glass);color:var(--accent-1);text-decoration:none;display:inline-block}
  </style>
</head>
<body>
  <header class="container header">
    <div class="brand">
      <img src="PIXOLOTEL.png" alt="Logo" class="brand-logo">
      <div>
        <div class="site-title">Pyxolotl Admin</div>
        <div style="font-size:12px;color:var(--muted)">Panel de Administraci√≥n</div>
      </div>
    </div>
    <nav class="nav">
      <a href="index.html">Tienda</a>
      <a href="#" onclick="logout()">Cerrar sesi√≥n</a>
    </nav>
  </header>

  <main class="container">
    <h1>Panel de Administraci√≥n</h1>

    <div class="admin-grid">
      <div class="stat-card">
        <div style="color:var(--muted)">Juegos Pendientes</div>
        <div class="stat-number" id="statPendientes">0</div>
      </div>
      <div class="stat-card">
        <div style="color:var(--muted)">Total Juegos</div>
        <div class="stat-number" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div style="color:var(--muted)">Usuarios</div>
        <div class="stat-number" id="statUsuarios">0</div>
      </div>
    </div>

    <h2>Juegos Pendientes de Aprobaci√≥n</h2>
    <div id="juegosPendientes">
      <div style="text-align:center;padding:40px;color:var(--muted)">
        Cargando...
      </div>
    </div>
  </main>

  <script src="api.js"></script>
  <script>
    // ============================================
    // SISTEMA DE TOAST NOTIFICATIONS
    // ============================================
    function showToast(message, type = 'info') {
      // Remover toast anterior si existe
      const existing = document.querySelector('.admin-toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'admin-toast';
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 12px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: slideInRight 0.3s ease;
        background: ${type === 'error' ? '#ff4757' : type === 'success' ? '#4CAF50' : '#7b61ff'};
      `;
      toast.innerHTML = `<span>${message}</span>`;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Agregar estilos de animaci√≥n
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // Funci√≥n para construir la URL de descarga correctamente
    function getDownloadUrl(archivoUrl) {
      if (!archivoUrl) return '#';
      
      // Si ya es una URL completa (Cloudinary), usarla directamente
      if (archivoUrl.startsWith('http://') || archivoUrl.startsWith('https://')) {
        return archivoUrl;
      }
      
      // Si es una ruta relativa, construir la URL del backend
      const backendUrl = window.location.hostname === 'localhost' 
        ? 'http://localhost:8000'
        : 'https://pyxolotl-production.up.railway.app';
      
      return `${backendUrl}${archivoUrl}`;
    }
    
    // Funci√≥n para descargar archivo directamente
    async function downloadGame(archivoUrl, titulo) {
      const downloadUrl = getDownloadUrl(archivoUrl);
      
      showToast(`üì• Iniciando descarga de "${titulo}"...`, 'info');
      
      try {
        // Crear link de descarga invisible
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `${titulo.replace(/[^a-z0-9]/gi, '_')}.zip`;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => {
          showToast(`‚úÖ Descarga iniciada para "${titulo}"`, 'success');
        }, 500);
      } catch (error) {
        console.error('Error al descargar:', error);
        showToast('‚ùå Error al iniciar descarga', 'error');
        // Fallback: abrir en nueva pesta√±a
        window.open(downloadUrl, '_blank');
      }
    }

    async function cargarJuegosPendientes() {
      const user = getCurrentUser();
      if (!user || user.tipo_cuenta !== 'administrador') {
        showToast('Acceso denegado', 'error');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1500);
        return;
      }

      try {
        const juegos = await apiGetJuegosPendientes();
        const container = document.getElementById('juegosPendientes');
        
        document.getElementById('statPendientes').textContent = juegos.length;

        if (juegos.length === 0) {
          container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px">No hay juegos pendientes</p>';
          return;
        }

        container.innerHTML = juegos.map(juego => {
          return `
            <div class="juego-pendiente">
              <h3>${juego.titulo}</h3>
              <p><strong>Desarrollador:</strong> ${juego.desarrollador?.nombre || 'N/A'}</p>
              <p><strong>G√©nero:</strong> ${juego.genero} | <strong>Precio:</strong> $${juego.precio}</p>
              <p style="color:var(--muted)">${juego.descripcion ? juego.descripcion.substring(0, 150) : 'Sin descripci√≥n'}...</p>
              
              <div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn btn-approve" onclick="aprobarJuego(${juego.id})">
                  ‚úÖ Aprobar
                </button>
                <button class="btn btn-reject" onclick="rechazarJuego(${juego.id})">
                  ‚ùå Rechazar
                </button>
                <button class="btn btn-download" onclick="downloadGame('${juego.archivo_juego_url}', '${juego.titulo.replace(/'/g, "\\'")}')">
                  üì• Descargar y Probar
                </button>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('juegosPendientes').innerHTML = 
          '<p style="color:#ff4757;text-align:center;padding:40px">Error al cargar juegos: ' + error.message + '</p>';
      }
    }

    async function aprobarJuego(id) {
      // Crear modal de confirmaci√≥n
      const confirmed = await showConfirmModal('¬øAprobar este juego?', 'El juego ser√° publicado y visible para todos los usuarios.');
      if (!confirmed) return;

      try {
        const result = await apiAprobarJuego(id, true);
        
        if (result.success !== false) {
          showToast('‚úÖ Juego aprobado y publicado', 'success');
          cargarJuegosPendientes();
        } else {
          showToast('Error: ' + (result.detail || result.message || 'No se pudo aprobar'), 'error');
        }
      } catch (error) {
        console.error('Error al aprobar:', error);
        showToast('Error al aprobar: ' + error.message, 'error');
      }
    }

    async function rechazarJuego(id) {
      const motivo = await showPromptModal('Motivo del rechazo:', 'Explica brevemente por qu√© se rechaza el juego');
      if (!motivo) return;

      try {
        const result = await apiAprobarJuego(id, false, motivo);
        
        if (result.success !== false) {
          showToast('Juego rechazado. El desarrollador ser√° notificado.', 'info');
          cargarJuegosPendientes();
        } else {
          showToast('Error: ' + (result.detail || result.message || 'No se pudo rechazar'), 'error');
        }
      } catch (error) {
        console.error('Error al rechazar:', error);
        showToast('Error al rechazar: ' + error.message, 'error');
      }
    }
    
    // ============================================
    // MODALES PERSONALIZADOS
    // ============================================
    function showConfirmModal(title, message) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed; top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.8); z-index: 9999;
          display: flex; align-items: center; justify-content: center;
        `;
        
        overlay.innerHTML = `
          <div style="background: var(--card); padding: 30px; border-radius: 16px; max-width: 400px; text-align: center;">
            <h3 style="margin: 0 0 12px; color: #fff;">${title}</h3>
            <p style="color: var(--muted); margin: 0 0 24px;">${message}</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
              <button id="confirmNo" class="btn btn-ghost" style="padding: 10px 24px;">Cancelar</button>
              <button id="confirmYes" class="btn btn-approve" style="padding: 10px 24px;">Confirmar</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(overlay);
        
        overlay.querySelector('#confirmYes').onclick = () => { overlay.remove(); resolve(true); };
        overlay.querySelector('#confirmNo').onclick = () => { overlay.remove(); resolve(false); };
        overlay.onclick = (e) => { if (e.target === overlay) { overlay.remove(); resolve(false); } };
      });
    }
    
    function showPromptModal(title, placeholder) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed; top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.8); z-index: 9999;
          display: flex; align-items: center; justify-content: center;
        `;
        
        overlay.innerHTML = `
          <div style="background: var(--card); padding: 30px; border-radius: 16px; max-width: 450px; width: 90%;">
            <h3 style="margin: 0 0 16px; color: #fff;">${title}</h3>
            <textarea id="promptInput" placeholder="${placeholder}" style="
              width: 100%; height: 100px; padding: 12px; border-radius: 8px;
              border: 1px solid rgba(255,255,255,0.1); background: var(--glass);
              color: #fff; font-size: 14px; resize: none; margin-bottom: 20px;
            "></textarea>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button id="promptCancel" class="btn btn-ghost" style="padding: 10px 24px;">Cancelar</button>
              <button id="promptConfirm" class="btn btn-reject" style="padding: 10px 24px;">Rechazar</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(overlay);
        overlay.querySelector('#promptInput').focus();
        
        overlay.querySelector('#promptConfirm').onclick = () => {
          const value = overlay.querySelector('#promptInput').value.trim();
          overlay.remove();
          resolve(value || null);
        };
        overlay.querySelector('#promptCancel').onclick = () => { overlay.remove(); resolve(null); };
        overlay.onclick = (e) => { if (e.target === overlay) { overlay.remove(); resolve(null); } };
      });
    }

    // Inicializar
    cargarJuegosPendientes();
  </script>
</body>
</html>
